
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pysces.PyscesModel &#8212; PySCeS User Guide v0.9</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.7',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within PySCeS User Guide v0.9"
          href="../../_static/opensearch.xml"/>
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for pysces.PyscesModel</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">PySCeS - Python Simulator for Cellular Systems (http://pysces.sourceforge.net)</span>

<span class="sd">Copyright (C) 2004-2019 B.G. Olivier, J.M. Rohwer, J.-H.S Hofmeyr all rights reserved,</span>

<span class="sd">Brett G. Olivier (bgoli@users.sourceforge.net)</span>
<span class="sd">Triple-J Group for Molecular Cell Physiology</span>
<span class="sd">Stellenbosch University, South Africa.</span>

<span class="sd">Permission to use, modify, and distribute this software is given under the</span>
<span class="sd">terms of the PySceS (BSD style) license. See LICENSE.txt that came with</span>
<span class="sd">this distribution for specifics.</span>

<span class="sd">NO WARRANTY IS EXPRESSED OR IMPLIED.  USE AT YOUR OWN RISK.</span>
<span class="sd">Brett G. Olivier</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">unicode_literals</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">FUTURE TODO:</span>
<span class="sd">Parameter elasticities wrt the compartments</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pysces.version</span> <span class="k">import</span> <span class="n">__version__</span>
<span class="vm">__doc__</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">            PyscesModel</span>
<span class="s1">            -----------</span>

<span class="s1">            This module contains the core PySCeS classes which</span>
<span class="s1">            create the model and associated data objects</span>

<span class="s1">            &#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">gc</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">operator</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.linalg</span>
<span class="n">ScipyDerivative</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">HAVE_SCIPY_DERIV</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ScipyDerivative</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">derivative</span>
    <span class="n">HAVE_SCIPY_DERIV</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scipy.misc</span>
        <span class="n">ScipyDerivative</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">derivative</span>
        <span class="n">HAVE_SCIPY_DERIV</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SCIPY_DERIV</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">SciPy derivative function not available&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">getpass</span> <span class="k">import</span> <span class="n">getuser</span>

<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">model_dir</span> <span class="k">as</span> <span class="n">MODEL_DIR</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">output_dir</span> <span class="k">as</span> <span class="n">OUTPUT_DIR</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">install_dir</span> <span class="k">as</span> <span class="n">INSTALL_DIR</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">nleq2</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">nleq2_switch</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">pitcon</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">plt</span><span class="p">,</span> <span class="n">gplt</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">PyscesStoich</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">PyscesParse</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">PyscesRandom</span> <span class="k">as</span> <span class="n">random</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">__SILENT_START__</span>
<span class="kn">from</span> <span class="nn">pysces.PyscesScan</span> <span class="k">import</span> <span class="n">Scanner</span>
<span class="kn">from</span> <span class="nn">pysces.core2.InfixParser</span> <span class="k">import</span> <span class="n">MyInfixParser</span>
<span class="kn">from</span> <span class="nn">pysces</span> <span class="k">import</span> <span class="n">SED</span>
<span class="n">interface</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># this is incredibly crude but effectively masks off unsupported random functions</span>
<span class="k">del</span> <span class="n">random</span><span class="o">.</span><span class="n">setstate</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">getstate</span><span class="p">,</span> <span class="c1"># random.division, </span>
<span class="k">del</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span>
<span class="k">del</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">jumpahead</span>
<span class="k">del</span> <span class="n">random</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">WichmannHill</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">triangular</span>
<span class="c1"># used by functions random.NV_MAGICCONST, random.SG_MAGICCONST, random.BPF, random.RECIP_BPF</span>


<span class="c1"># Scipy version check</span>
<span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: Your version of SciPy (&#39;</span> <span class="o">+</span>  <span class="n">scipy</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span> <span class="o">+</span> <span class="s1">&#39;) might be too old</span><span class="se">\n\t</span><span class="s1">Version 0.6.x or newer is strongly recommended</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">__SILENT_START__</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;You are using NumPy (</span><span class="si">%s</span><span class="s1">) with SciPy (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="n">scipy</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>

<span class="n">_HAVE_PYSUNDIALS</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_PYSUNDIALS_LOAD_ERROR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pysundials</span> <span class="k">import</span> <span class="n">cvode</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">__SILENT_START__</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PySundials available&#39;</span><span class="p">)</span>
    <span class="n">_HAVE_PYSUNDIALS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="n">_PYSUNDIALS_LOAD_ERROR</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ex</span>
    <span class="n">_HAVE_PYSUNDIALS</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># We now welcome a prototype StomPy interface to PySCeS which will provide expanding stochastic simulation support.</span>


<span class="c1"># for future fun</span>
<span class="n">_HAVE_VPYTHON</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">_VPYTHON_LOAD_ERROR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="c1">##  try:</span>
    <span class="c1">##  import visual</span>
    <span class="c1">##  _HAVE_VPYTHON = True</span>
    <span class="c1">##  vpyscene = visual.display(x=150, y=50, title=&#39;PySCeS &#39;+__version__+&#39; - C Brett G. Olivier, Stellenbosch 2006&#39;, width=640, height=480,\</span>
    <span class="c1">##  center=(0,0,0), background=(0,0,0))</span>
    <span class="c1">##  vpyscene.select()</span>
    <span class="c1">##  # vpyscene.autocenter = True</span>
    <span class="c1">##  l1 = visual.label(pos=(0,0,0), text=&quot;Welcome to the PySCeS Visualisation Terminal&quot;, color=visual.color.red, box=0)</span>
    <span class="c1">##  l2 = visual.label(pos=(0,0.5,0.5), text=&quot;It just works!&quot;, color=visual.color.green, box=0)</span>
<span class="c1">##  except Exception, ex:</span>
    <span class="c1">##  _VPYTHON_LOAD_ERROR = &#39;%s&#39; % ex</span>
    <span class="c1">##  _HAVE_VPYTHON = False</span>

<span class="n">__psyco_active__</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">##  try:</span>
    <span class="c1">##  import psyco</span>
    <span class="c1">##  psyco.profile()</span>
    <span class="c1">##  __psyco_active__ = 1</span>
    <span class="c1">##  print &#39;PySCeS Model module is now PsycoActive!&#39;</span>
<span class="c1">##  except:</span>
    <span class="c1">##  __psyco_active__ = 0</span>

<span class="c1"># machine specs</span>
<span class="n">mach_spec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">MachAr</span><span class="p">()</span>
<span class="c1"># grab a parser</span>
<span class="n">pscParser</span> <span class="o">=</span> <span class="n">PyscesParse</span><span class="o">.</span><span class="n">PySCeSParser</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="chkpsc"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.chkpsc">[docs]</a><span class="k">def</span> <span class="nf">chkpsc</span><span class="p">(</span><span class="n">File</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    chkpsc(File)</span>

<span class="sd">    Chekc whether the filename &quot;File&quot; has a &#39;.psc&#39; extension and adds one if not.</span>

<span class="sd">    Arguments:</span>

<span class="sd">    File: filename string</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">File</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.psc&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assuming extension is .psc&#39;</span><span class="p">)</span>
            <span class="n">File</span> <span class="o">+=</span> <span class="s1">&#39;.psc&#39;</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Chkpsc error&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">File</span></div>

<div class="viewcode-block" id="chkmdir"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.chkmdir">[docs]</a><span class="k">def</span> <span class="nf">chkmdir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    chkmdir()</span>

<span class="sd">    Import and grab pysces.model_dir</span>

<span class="sd">    Arguments:</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">##  from pysces import model_dir as MODEL_DIR</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="BagOfStuff"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.BagOfStuff">[docs]</a><span class="k">class</span> <span class="nc">BagOfStuff</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A collection of attributes defined by row and column lists</span>
<span class="sd">    used by Response coefficients etc matrix is an array of values</span>
<span class="sd">    while row/col are lists of row colummn name strings</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">matrix</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">row</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">col</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="s2">&quot;Load attributes from arrays&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Row dimension mismatch&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">==</span> <span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Col dimension mismatch&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span> <span class="o">=</span> <span class="n">matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

<div class="viewcode-block" id="BagOfStuff.load"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.BagOfStuff.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">r</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">c</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">])</span></div>

<div class="viewcode-block" id="BagOfStuff.get"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.BagOfStuff.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr1</span><span class="p">,</span> <span class="n">attr2</span><span class="p">):</span>
        <span class="s2">&quot;Returns a single attribute </span><span class="se">\&quot;</span><span class="s2">attr1_attr2</span><span class="se">\&quot;</span><span class="s2"> or None&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr1</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attr2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="BagOfStuff.select"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.BagOfStuff.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a dictionary of &lt;attr&gt;_&lt;name&gt;, &lt;name&gt;_&lt;attr&gt; : val or {} if none</span>
<span class="sd">        If attr exists as an index for both left and right attr then:</span>
<span class="sd">        search=&#39;a&#39; : both left and right attributes (default)</span>
<span class="sd">        search=&#39;l&#39; : left attributes only</span>
<span class="sd">        search=&#39;r&#39; : right attributes&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">search</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;l&#39;</span><span class="p">]:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">search</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">]:</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">attr</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="BagOfStuff.list"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.BagOfStuff.list">[docs]</a>    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all attributes as a attr:val dictionary</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">output</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="BagOfStuff.listAllOrdered"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.BagOfStuff.listAllOrdered">[docs]</a>    <span class="k">def</span> <span class="nf">listAllOrdered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;descending&#39;</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an ordered list of (attr, value) tuples</span>

<span class="sd">         - *order* [default=&#39;descending&#39;] the order to return as: &#39;descending&#39; or &#39;ascending&#39;</span>
<span class="sd">         - *absolute* [default=True] use the absolute value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">!=</span> <span class="s1">&#39;ascending&#39;</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">output_v</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output_n</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">output_v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">])</span>
                <span class="n">output_n</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">absolute</span><span class="p">:</span>
            <span class="n">new_idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">output_v</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">output_v</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">new_idx</span> <span class="o">=</span> <span class="n">new_idx</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">new_idx</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i_</span> <span class="ow">in</span> <span class="n">new_idx</span><span class="p">:</span>
            <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">output_n</span><span class="p">[</span><span class="n">i_</span><span class="p">],</span> <span class="n">output_v</span><span class="p">[</span><span class="n">i_</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">output</span></div></div>



<div class="viewcode-block" id="ScanDataObj"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj">[docs]</a><span class="k">class</span> <span class="nc">ScanDataObj</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    New class used to store parameter scan data (uses StateDataObj)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">species</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">fluxes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mod_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">flux_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">species_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rules_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xdata_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mod_data_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">invalid_states</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parameter_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">HAS_FLUXES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_SPECIES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_RULES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_XDATA</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_MOD_DATA</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_SET_LABELS</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ALL_VALID</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">OPEN</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">par_label</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalid_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par_label</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span> <span class="o">=</span> <span class="n">par_label</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">par_label</span><span class="p">]</span>


<div class="viewcode-block" id="ScanDataObj.setLabels"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.setLabels">[docs]</a>    <span class="k">def</span> <span class="nf">setLabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssdata</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span> <span class="o">=</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">species_labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">HAS_FLUXES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span> <span class="o">=</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">flux_labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span> <span class="o">=</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">rules_labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span> <span class="o">=</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">xdata_labels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SET_LABELS</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ScanDataObj.addPoint"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.addPoint">[docs]</a>    <span class="k">def</span> <span class="nf">addPoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ipar</span><span class="p">,</span> <span class="n">ssdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;takes a list/array of input parameter values and the associated ssdata object&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Scan has been finalised no new data may be added&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SET_LABELS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setLabels</span><span class="p">(</span><span class="n">ssdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ipar</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ssdata</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ssdata</span><span class="o">.</span><span class="n">getFluxes</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ssdata</span><span class="o">.</span><span class="n">getRules</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ssdata</span><span class="o">.</span><span class="n">getXData</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ssdata</span><span class="o">.</span><span class="n">IS_VALID</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ALL_VALID</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalid_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ipar</span><span class="p">)</span></div>

<div class="viewcode-block" id="ScanDataObj.addModData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.addModData">[docs]</a>    <span class="k">def</span> <span class="nf">addModData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_MOD_DATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">HAS_MOD_DATA</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mod_data_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_data_labels</span><span class="p">]))</span></div>

<div class="viewcode-block" id="ScanDataObj.closeScan"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.closeScan">[docs]</a>    <span class="k">def</span> <span class="nf">closeScan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: closing scan no new data may be added.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_MOD_DATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mod_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ScanDataObj.getSpecies"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.getSpecies">[docs]</a>    <span class="k">def</span> <span class="nf">getSpecies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeScan</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span>
        <span class="k">if</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ScanDataObj.getFluxes"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.getFluxes">[docs]</a>    <span class="k">def</span> <span class="nf">getFluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeScan</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span>
        <span class="k">if</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ScanDataObj.getRules"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.getRules">[docs]</a>    <span class="k">def</span> <span class="nf">getRules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeScan</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span>
        <span class="k">if</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ScanDataObj.getXData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.getXData">[docs]</a>    <span class="k">def</span> <span class="nf">getXData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeScan</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span>
        <span class="k">if</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ScanDataObj.getModData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.getModData">[docs]</a>    <span class="k">def</span> <span class="nf">getModData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeScan</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_MOD_DATA</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_data</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">mod_data_labels</span>
        <span class="k">if</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ScanDataObj.getAllScanData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.getAllScanData">[docs]</a>    <span class="k">def</span> <span class="nf">getAllScanData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">OPEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closeScan</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_MOD_DATA</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_data</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">mod_data_labels</span>
        <span class="k">if</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="ScanDataObj.getScanData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ScanDataObj.getScanData">[docs]</a>    <span class="k">def</span> <span class="nf">getScanData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;getScanData(\*args) feed this method species/flux/rule/mod labels and it</span>
<span class="sd">        will return an array of [parameter(s), sp1, f1, ....]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;lbls&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">lbls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lbls&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lbls</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_labels</span>
        <span class="k">for</span> <span class="n">roc</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_MOD_DATA</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_data_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_data</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">mod_data_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">lout</span></div></div>


<div class="viewcode-block" id="StateDataObj"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj">[docs]</a><span class="k">class</span> <span class="nc">StateDataObj</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    New class used to store steady-state data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fluxes</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">species</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">flux_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">species_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rules_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xdata_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">HAS_FLUXES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_SPECIES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_RULES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_XDATA</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">IS_VALID</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">##  def setLabels(self, species=None, fluxes=None, rules=None):</span>
        <span class="c1">##  &quot;&quot;&quot;set the species, rate and rule label lists&quot;&quot;&quot;</span>
        <span class="c1">##  if species != None:</span>
            <span class="c1">##  self.species_labels = species</span>
        <span class="c1">##  if fluxes != None:</span>
            <span class="c1">##  self.flux_labels = fluxes</span>
        <span class="c1">##  if rules != None:</span>
            <span class="c1">##  self.rules_labels = rules</span>

<div class="viewcode-block" id="StateDataObj.setSpecies"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.setSpecies">[docs]</a>    <span class="k">def</span> <span class="nf">setSpecies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the species array&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span> <span class="o">=</span> <span class="n">lbls</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">s</span><span class="p">])</span></div>

<div class="viewcode-block" id="StateDataObj.setFluxes"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.setFluxes">[docs]</a>    <span class="k">def</span> <span class="nf">setFluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fluxes</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set the flux array&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span> <span class="o">=</span> <span class="n">fluxes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span> <span class="o">=</span> <span class="n">lbls</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="p">[</span><span class="n">f</span><span class="p">])</span></div>

<div class="viewcode-block" id="StateDataObj.setRules"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.setRules">[docs]</a>    <span class="k">def</span> <span class="nf">setRules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the results of rate rules&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span> <span class="o">=</span> <span class="n">lbls</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">r</span><span class="p">])</span></div>

<div class="viewcode-block" id="StateDataObj.setXData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.setXData">[docs]</a>    <span class="k">def</span> <span class="nf">setXData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets extra simulation data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span> <span class="o">=</span> <span class="n">lbls</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="p">)):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">[</span><span class="n">x</span><span class="p">])</span></div>

<div class="viewcode-block" id="StateDataObj.getSpecies"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.getSpecies">[docs]</a>    <span class="k">def</span> <span class="nf">getSpecies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return species array&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span></div>

<div class="viewcode-block" id="StateDataObj.getFluxes"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.getFluxes">[docs]</a>    <span class="k">def</span> <span class="nf">getFluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return flux array&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span></div>

<div class="viewcode-block" id="StateDataObj.getRules"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.getRules">[docs]</a>    <span class="k">def</span> <span class="nf">getRules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return rule array&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span></div>

<div class="viewcode-block" id="StateDataObj.getXData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.getXData">[docs]</a>    <span class="k">def</span> <span class="nf">getXData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return xdata array&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span></div>

<div class="viewcode-block" id="StateDataObj.getAllStateData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.getAllStateData">[docs]</a>    <span class="k">def</span> <span class="nf">getAllStateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all available data as species+fluxes+rules</span>
<span class="sd">        if lbls=True returns (array,labels) else just array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="StateDataObj.getStateData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.StateDataObj.getStateData">[docs]</a>    <span class="k">def</span> <span class="nf">getStateData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;getSimData(\*args) feed this method species/rate labels and it</span>
<span class="sd">        will return an array of [time, sp1, r1, ....]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;lbls&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">lbls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lbls&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lbls</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">roc</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_FLUXES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;I don</span><span class="se">\&#39;</span><span class="s1">t have an attribute </span><span class="si">%s</span><span class="s1"> ... ignoring.&#39;</span> <span class="o">%</span> <span class="n">roc</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="n">lout</span></div></div>


<div class="viewcode-block" id="IntegrationDataObj"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj">[docs]</a><span class="k">class</span> <span class="nc">IntegrationDataObj</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class is specifically designed to store the results of a time simulation</span>
<span class="sd">    It has methods for setting the Time, Labels, Species and Rate data and</span>
<span class="sd">    getting Time, Species and Rate (including time) arrays. However, of more use:</span>

<span class="sd">    - getOutput(\*args) feed this method species/rate labels and it will return</span>
<span class="sd">      an array of [time, sp1, r1, ....]</span>
<span class="sd">    - getDataAtTime(time) the data generated at time point &quot;time&quot;.</span>
<span class="sd">    - getDataInTimeInterval(time, bounds=None) more intelligent version of the above</span>
<span class="sd">      returns an array of all data points where: time-bounds &lt;= time &lt;= time+bounds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rates</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">species</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xdata</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">time_label</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>
    <span class="n">rate_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">species_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rules_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xdata_labels</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">HAS_SPECIES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_RATES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_RULES</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_TIME</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">HAS_XDATA</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">IS_VALID</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">TYPE_INFO</span> <span class="o">=</span> <span class="s1">&#39;Deterministic&#39;</span>

<div class="viewcode-block" id="IntegrationDataObj.setLabels"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.setLabels">[docs]</a>    <span class="k">def</span> <span class="nf">setLabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set the species, rate and rule label lists&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">species</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span> <span class="o">=</span> <span class="n">species</span>
        <span class="k">if</span> <span class="n">rates</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_labels</span> <span class="o">=</span> <span class="n">rates</span>
        <span class="k">if</span> <span class="n">rules</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span> <span class="o">=</span> <span class="n">rules</span></div>

<div class="viewcode-block" id="IntegrationDataObj.setTime"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.setTime">[docs]</a>    <span class="k">def</span> <span class="nf">setTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the time vector&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_TIME</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbl</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_label</span> <span class="o">=</span> <span class="n">lbl</span></div>

<div class="viewcode-block" id="IntegrationDataObj.setSpecies"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.setSpecies">[docs]</a>    <span class="k">def</span> <span class="nf">setSpecies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the species array&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span> <span class="o">=</span> <span class="n">lbls</span></div>

<div class="viewcode-block" id="IntegrationDataObj.setRates"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.setRates">[docs]</a>    <span class="k">def</span> <span class="nf">setRates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set the rate array&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rates</span> <span class="o">=</span> <span class="n">rates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RATES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rate_labels</span> <span class="o">=</span> <span class="n">lbls</span></div>

<div class="viewcode-block" id="IntegrationDataObj.setRules"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.setRules">[docs]</a>    <span class="k">def</span> <span class="nf">setRules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rules</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the results of rate rules&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">rules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span> <span class="o">=</span> <span class="n">lbls</span></div>

<div class="viewcode-block" id="IntegrationDataObj.setXData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.setXData">[docs]</a>    <span class="k">def</span> <span class="nf">setXData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets extra simulation data&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span> <span class="o">=</span> <span class="n">xdata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">lbls</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span> <span class="o">=</span> <span class="n">lbls</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getTime"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getTime">[docs]</a>    <span class="k">def</span> <span class="nf">getTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return the time vector&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_TIME</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">),)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getSpecies"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getSpecies">[docs]</a>    <span class="k">def</span> <span class="nf">getSpecies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return time+species array&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getRates"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getRates">[docs]</a>    <span class="k">def</span> <span class="nf">getRates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return time+rate array&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RATES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getRules"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getRules">[docs]</a>    <span class="k">def</span> <span class="nf">getRules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return time+rule array&quot;&quot;&quot;</span>
        <span class="c1">##  assert self.rules != None, &quot;\nNo rules&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getXData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getXData">[docs]</a>    <span class="k">def</span> <span class="nf">getXData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return time+xdata array&quot;&quot;&quot;</span>
        <span class="c1">##  assert self.rules != None, &quot;\nNo rules&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getDataAtTime"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getDataAtTime">[docs]</a>    <span class="k">def</span> <span class="nf">getDataAtTime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return all data generated at &quot;time&quot; &quot;&quot;&quot;</span>
        <span class="c1">#TODO add rate rule data</span>
        <span class="n">t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ru</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">xd</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">temp_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">),)</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_t</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">temp_t</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">==</span> <span class="n">time</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">tt</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span><span class="p">:</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">tt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RATES</span><span class="p">:</span>
                    <span class="n">ra</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">tt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
                    <span class="n">ru</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">tt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
                    <span class="n">xd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">tt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">temp_t</span><span class="p">[</span><span class="n">t</span><span class="p">]]])</span>
            <span class="k">if</span> <span class="n">sp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span><span class="n">sp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span><span class="n">ra</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ru</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span><span class="n">ru</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">xd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span><span class="n">xd</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getDataInTimeInterval"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getDataInTimeInterval">[docs]</a>    <span class="k">def</span> <span class="nf">getDataInTimeInterval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         getDataInTimeInterval(time, bounds=None) returns an array of all</span>
<span class="sd">         data points where: time-bounds &lt;= time &lt;= time+bounds</span>
<span class="sd">         where bound defaults to stepsize</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO add rate rule data</span>
        <span class="n">temp_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">),)</span>
        <span class="k">if</span> <span class="n">bounds</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">temp_t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_t</span> <span class="o">&gt;=</span> <span class="n">time</span><span class="o">-</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_t</span> <span class="o">&lt;=</span> <span class="n">time</span><span class="o">+</span><span class="n">bounds</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Searching (</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">-</span><span class="n">bounds</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">time</span><span class="o">+</span><span class="n">bounds</span><span class="p">))</span>

        <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">c1</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="ow">and</span> <span class="n">c2</span><span class="p">[</span><span class="n">tt</span><span class="p">]:</span>
                <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_TIME</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RATES</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getOutput"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getOutput">[docs]</a>    <span class="k">def</span> <span class="nf">getOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Old alias for getSimData()</span>
<span class="sd">        getOutput(\*args) feed this method species/rate labels and it</span>
<span class="sd">        will return an array of [time, sp1, r1, ....]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSimData</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getAllSimData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getAllSimData">[docs]</a>    <span class="k">def</span> <span class="nf">getAllSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lbls</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all available data as time+species+rates+rules</span>
<span class="sd">        if lbls=True returns (array,lables) else just array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_TIME</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RATES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">+=</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="p">))</span>
            <span class="n">labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">labels</span></div>

<div class="viewcode-block" id="IntegrationDataObj.getSimData"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.IntegrationDataObj.getSimData">[docs]</a>    <span class="k">def</span> <span class="nf">getSimData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;getSimData(\*args) feed this method species/rate labels and it</span>
<span class="sd">        will return an array of [time, sp1, r1, ....]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
        <span class="c1">##  print argimrgs</span>
        <span class="k">if</span> <span class="s1">&#39;lbls&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">lbls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lbls&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lbls</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">lout</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time_label</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">roc</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_SPECIES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">species_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RATES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rates</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">rate_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_RULES</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">rules_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">HAS_XDATA</span> <span class="ow">and</span> <span class="n">roc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="p">:</span>
                <span class="n">lout</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roc</span><span class="p">)</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdata</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xdata_labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">roc</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lbls</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">lout</span></div></div>

<span class="c1"># this must stay in sync with core2</span>
<div class="viewcode-block" id="NewCoreBase"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.NewCoreBase">[docs]</a><span class="k">class</span> <span class="nc">NewCoreBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Core2 base class, needed here as we use Core2 derived classes</span>
<span class="sd">    in PySCes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__DEBUG__</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="NewCoreBase.getName"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.NewCoreBase.getName">[docs]</a>    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="NewCoreBase.setName"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.NewCoreBase.setName">[docs]</a>    <span class="k">def</span> <span class="nf">setName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span></div>

<div class="viewcode-block" id="NewCoreBase.get"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.NewCoreBase.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an attribute whose name is str(attr)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span></div></div>


<span class="c1"># this must stay in sync with core2</span>
<div class="viewcode-block" id="NumberBase"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.NumberBase">[docs]</a><span class="k">class</span> <span class="nc">NumberBase</span><span class="p">(</span><span class="n">NewCoreBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Derived Core2 number class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value_initial</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<div class="viewcode-block" id="NumberBase.getValue"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.NumberBase.getValue">[docs]</a>    <span class="k">def</span> <span class="nf">getValue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="NumberBase.setValue"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.NumberBase.setValue">[docs]</a>    <span class="k">def</span> <span class="nf">setValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span></div></div>

<span class="c1"># Finally killed my lambda functions - brett07</span>
<div class="viewcode-block" id="ReactionObj"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ReactionObj">[docs]</a><span class="k">class</span> <span class="nc">ReactionObj</span><span class="p">(</span><span class="n">NewCoreBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a reaction with a KineticLaw *kl8, *formula* and *name* bound</span>
<span class="sd">    to a model instance, *mod*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xcode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">code_string</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">compartment</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">piecewises</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">klrepl</span><span class="o">=</span><span class="s1">&#39;self.&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mod : model instance</span>
<span class="sd">        name = reaction name</span>
<span class="sd">        kl = kinetic law</span>
<span class="sd">        klrepl = replacement string for KineticLaw</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setKineticLaw</span><span class="p">(</span><span class="n">kl</span><span class="p">,</span> <span class="n">klrepl</span><span class="o">=</span><span class="s1">&#39;self.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate</span>

<div class="viewcode-block" id="ReactionObj.setKineticLaw"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.ReactionObj.setKineticLaw">[docs]</a>    <span class="k">def</span> <span class="nf">setKineticLaw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">klrepl</span><span class="o">=</span><span class="s1">&#39;self.&#39;</span><span class="p">):</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">kl</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">klrepl</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piecewises</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span>
        <span class="n">formula</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
        <span class="c1"># this code has to stay together #</span>
        <span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.mod.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">,</span> <span class="s1">&#39;self.mod.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">)</span>
        <span class="c1"># this code has to stay together #</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;self.rate=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_string</span><span class="p">,</span> <span class="s1">&#39;Req: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">kl</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">klrepl</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;numpy.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;math.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;operator.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span></div></div>

<span class="n">InfixParser</span> <span class="o">=</span> <span class="n">MyInfixParser</span><span class="p">()</span>
<span class="n">InfixParser</span><span class="o">.</span><span class="n">buildlexer</span><span class="p">()</span>
<span class="n">InfixParser</span><span class="o">.</span><span class="n">buildparser</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">debugfile</span><span class="o">=</span><span class="s1">&#39;infix.dbg&#39;</span><span class="p">,</span>\
		<span class="n">tabmodule</span><span class="o">=</span><span class="s1">&#39;infix_tabmodule&#39;</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>
<span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">)</span>

<span class="c1"># adapted from core2</span>
<div class="viewcode-block" id="Function"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.Function">[docs]</a><span class="k">class</span> <span class="nc">Function</span><span class="p">(</span><span class="n">NewCoreBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function class ported from Core2 to enable the use of functions in PySCeS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">code_string</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xcode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">argsl</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">piecewises</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">functions</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argsl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argsl</span><span class="p">[</span><span class="n">ar</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="n">ar</span><span class="p">])</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

<div class="viewcode-block" id="Function.setArg"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.Function.setArg">[docs]</a>    <span class="k">def</span> <span class="nf">setArg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argsl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span></div>

<div class="viewcode-block" id="Function.addFormula"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.Function.addFormula">[docs]</a>    <span class="k">def</span> <span class="nf">addFormula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">SymbolReplacements</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_TIME_&#39;</span><span class="p">:</span><span class="s1">&#39;mod._TIME_&#39;</span><span class="p">}</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piecewises</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">functions</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;self.value=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_string</span><span class="p">,</span> <span class="s1">&#39;Func: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span></div></div>

<span class="c1"># adapted from core2</span>
<div class="viewcode-block" id="EventAssignment"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.EventAssignment">[docs]</a><span class="k">class</span> <span class="nc">EventAssignment</span><span class="p">(</span><span class="n">NumberBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Event assignments are actions that are triggered by an event.</span>
<span class="sd">    Ported from Core2 to build an event handling framework fro PySCeS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">variable</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">code_string</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xcode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">piecewises</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__DEBUG__</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Assigning </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span>

<div class="viewcode-block" id="EventAssignment.setVariable"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.EventAssignment.setVariable">[docs]</a>    <span class="k">def</span> <span class="nf">setVariable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variable</span> <span class="o">=</span> <span class="n">var</span></div>

<div class="viewcode-block" id="EventAssignment.setFormula"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.EventAssignment.setFormula">[docs]</a>    <span class="k">def</span> <span class="nf">setFormula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">SymbolReplacements</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_TIME_&#39;</span><span class="p">:</span><span class="s1">&#39;self.mod._TIME_&#39;</span><span class="p">}</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piecewises</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;self.value=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_string</span><span class="p">,</span> <span class="s1">&#39;EvAs: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span></div>
        <span class="c1">##  print &#39;\t&#39;, self.name, self.code_string</span>

<div class="viewcode-block" id="EventAssignment.evaluateAssignment"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.EventAssignment.evaluateAssignment">[docs]</a>    <span class="k">def</span> <span class="nf">evaluateAssignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcode</span><span class="p">)</span></div></div>

<span class="c1"># adapted from core2</span>
<div class="viewcode-block" id="Event"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.Event">[docs]</a><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">NewCoreBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Event&#39;s have triggers and fire EventAssignments when required.</span>
<span class="sd">    Ported from Core2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trigger</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">code_string</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xcode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">state0</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">assignments</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_TIME_</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">_ASS_TIME_</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">_need_action</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_time_symbol</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">piecewises</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__DEBUG__</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="n">time</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcode</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="n">ass</span><span class="o">.</span><span class="n">evaluateAssignment</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_need_action</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ASS_TIME_</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">event </span><span class="si">%s</span><span class="s1"> is evaluating at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_need_action</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ASS_TIME_</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                <span class="n">ass</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__DEBUG__</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;event </span><span class="si">%s</span><span class="s1"> is assigning at </span><span class="si">%s</span><span class="s1"> (delay=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_need_action</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="Event.setTrigger"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.Event.setTrigger">[docs]</a>    <span class="k">def</span> <span class="nf">setTrigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">delay</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="c1">##  print formula, delay</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_symbol</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">InfixParser</span><span class="o">.</span><span class="n">SymbolReplacements</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_time_symbol</span> <span class="p">:</span> <span class="s1">&#39;_TIME_&#39;</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">InfixParser</span><span class="o">.</span><span class="n">SymbolReplacements</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_TIME_&#39;</span> <span class="p">:</span> <span class="s1">&#39;_TIME_&#39;</span><span class="p">}</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piecewises</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;self.state=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_string</span><span class="p">,</span> <span class="s1">&#39;Ev: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span></div>
        <span class="c1">##  print self.name, self.code_string</span>

<div class="viewcode-block" id="Event.setAssignment"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.Event.setAssignment">[docs]</a>    <span class="k">def</span> <span class="nf">setAssignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">formula</span><span class="p">):</span>
        <span class="n">ass</span> <span class="o">=</span> <span class="n">EventAssignment</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">mod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mod</span><span class="p">)</span>
        <span class="n">ass</span><span class="o">.</span><span class="n">setVariable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="n">ass</span><span class="o">.</span><span class="n">setFormula</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">var</span><span class="p">,</span> <span class="n">ass</span><span class="p">)</span></div>

<div class="viewcode-block" id="Event.reset"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.Event.reset">[docs]</a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state0</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ASS_TIME_</span> <span class="o">=</span> <span class="mf">0.0</span></div></div>


<div class="viewcode-block" id="PieceWise"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PieceWise">[docs]</a><span class="k">class</span> <span class="nc">PieceWise</span><span class="p">(</span><span class="n">NewCoreBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic piecewise class adapted from Core2 that generates a compiled</span>
<span class="sd">    Python code block that allows evaluation of arbitrary length piecewise</span>
<span class="sd">    functions. Piecewise statements should be defined in assignment rules</span>
<span class="sd">    as `piecewise(&lt;Piece&gt;, &lt;Conditional&gt;, &lt;OtherValue&gt;)` where there can</span>
<span class="sd">    be an arbitrary number of `&lt;Piece&gt;, &lt;Conditional&gt;` pairs.</span>

<span class="sd">    - *args* a dictionary of piecewise information generated by the InfixParser as InfixParser.piecewises</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">code_string</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">xcode</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_names</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_TIME_</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">mod</span><span class="p">):</span>
        <span class="n">pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="k">if</span> <span class="n">pwd</span><span class="p">[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="s1">&#39;self.value = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pwd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">other</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span>
            <span class="n">pwd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;other&#39;</span><span class="p">)</span>

        <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pwd</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="s1">&#39;_TIME_&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
            <span class="n">thenStat</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">)</span>
            <span class="c1">##  thenStat = pwd[0][1]</span>
            <span class="c1">##  InfixParser.setNameStr(&#39;self.mod.&#39;, &#39;&#39;)</span>
            <span class="c1">##  InfixParser.parse(thenStat)</span>
            <span class="c1">##  thenStat = InfixParser.output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;if </span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">    self.value = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">else:</span><span class="se">\n</span><span class="s1">    </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>\
            <span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">thenStat</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="s1">&#39;_TIME_&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
            <span class="n">thenStat</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">)</span>
            <span class="c1">##  thenStat = pwd[0][1]</span>
            <span class="c1">##  InfixParser.setNameStr(&#39;self.mod.&#39;, &#39;&#39;)</span>
            <span class="c1">##  InfixParser.parse(thenStat)</span>
            <span class="c1">##  thenStat = InfixParser.output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;if </span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">    self.value = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">thenStat</span><span class="p">)</span>
            <span class="n">pwd</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pwd</span><span class="p">:</span>
                <span class="n">formula</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">formula</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="s1">&#39;_TIME_&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

                <span class="n">formula</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
                <span class="n">thenStat</span> <span class="o">=</span> <span class="n">pwd</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;self.mod.&#39;</span><span class="p">)</span>
                <span class="c1">##  thenStat = pwd[p][1]</span>
                <span class="c1">##  InfixParser.setNameStr(&#39;self.mod.&#39;, &#39;&#39;)</span>
                <span class="c1">##  InfixParser.parse(thenStat)</span>
                <span class="c1">##  thenStat = InfixParser.output</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">+=</span> <span class="s1">&#39;elif </span><span class="si">%s</span><span class="s1">:</span><span class="se">\n</span><span class="s1">    self.value = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">thenStat</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span> <span class="o">+=</span> <span class="s1">&#39;else:</span><span class="se">\n</span><span class="s1">    </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">other</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xcode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_string</span><span class="p">,</span> <span class="s1">&#39;PieceWise&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xcode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="PysMod"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod">[docs]</a><span class="k">class</span> <span class="nc">PysMod</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a model object and instantiate a PySCeS model so that it can be used for further analyses. PySCeS</span>
<span class="sd">    model descriptions can be loaded from files or strings (see the *loader* argument for details).</span>

<span class="sd">    - *File* the name of the PySCeS input file if not explicit a \*.psc extension is assumed.</span>
<span class="sd">    - *dir* if specified, the path to the input file otherwise the default PyscesModel directory (defined in the pys_config.ini file) is assumed.</span>
<span class="sd">    - *autoload* autoload the model, pre 0.7.1 call mod.doLoad(). (default=True) **new**</span>
<span class="sd">    - *loader* the default behaviour is to load PSC file, however, if this argument is set to &#39;string&#39; an input file can be supplied as the *fString* argument (default=&#39;file&#39;)</span>
<span class="sd">    - *fString* a string containing a PySCeS model file (use with *loader=&#39;string&#39;*) the *File* argument now sepcifies the new input file name.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__version__</span> <span class="o">=</span> <span class="n">__version__</span>
    <span class="n">__pysces_directory__</span> <span class="o">=</span> <span class="n">INSTALL_DIR</span>
    <span class="n">__settings__</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">random</span> <span class="o">=</span> <span class="n">random</span>
    <span class="c1">#__STOMPY__ = None</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">loader</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span><span class="n">fString</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">autoload</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a model object and instantiate a PySCeS model so that it can be used for further analyses. PySCeS</span>
<span class="sd">        model descriptions can be loaded from files or strings (see the *loader* argument for details).</span>

<span class="sd">        - *File* the name of the PySCeS input file if not explicit a \*.psc extension is assumed.</span>
<span class="sd">        - *dir* if specified, the path to the input file otherwise the default PyscesModel directory (defined in the pys_config.ini file) is assumed.</span>
<span class="sd">        - *autoload* autoload the model, pre 0.7.1 call mod.doLoad(). (default=True) **new**</span>
<span class="sd">        - *loader* the default behaviour is to load PSC file, however, if this argument is set to &#39;string&#39; an input file can be supplied as the *fString* argument (default=&#39;file&#39;)</span>
<span class="sd">        - *fString* a string containing a PySCeS model file (use with *loader=&#39;string&#39;*) the *File* argument now sepcifies the new input file name.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#if _HAVE_STOMPY:</span>
            <span class="c1">#self.__STOMPY__ = StomPyInterface(MODEL_DIR, OUTPUT_DIR)</span>
            <span class="c1">#print &#39;PySCeS/StochPy interface active&#39;</span>
        <span class="c1">#else:</span>
            <span class="c1">#self.__STOMPY__ = None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;enable_deprecated_attr&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">loader</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LoadFromFile</span><span class="p">(</span><span class="n">File</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">loader</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LoadFromString</span><span class="p">(</span><span class="n">File</span><span class="p">,</span><span class="n">fString</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">LoadFromFile</span><span class="p">(</span><span class="n">File</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
        <span class="c1"># stuff that needs to be done before initmodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_substitute_assignment_rules&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_compartment_warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># this will be the built-in time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">piecewise_functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__piecewises__</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_PIECEWISE__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelLoad</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__PSC_auto_load</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__PSC_auto_load</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="PysMod.ModelLoad"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.ModelLoad">[docs]</a>    <span class="k">def</span> <span class="nf">ModelLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stoich_load</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and instantiate a PySCeS model so that it can be used for further analyses. This function</span>
<span class="sd">        replaces the pre-0.7.1 doLoad() method.</span>

<span class="sd">        - *stoich_load* try to load a structural analysis saved with Stoichiometry_Save_Serial() (default=0)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseInputFile</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parseOK</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error in input file, parsing could not complete&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stoichiometry_Analyse</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">load</span><span class="o">=</span><span class="n">stoich_load</span><span class="p">)</span>
        <span class="c1"># add new Style functions to model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseFunctions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseCompartments</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseRules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseEvents</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseRuleChecks</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseOldFunctions</span><span class="p">()</span> <span class="c1"># TODO replace this with initialisation functions</span></div>

<div class="viewcode-block" id="PysMod.doLoad"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doLoad">[docs]</a>    <span class="k">def</span> <span class="nf">doLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stoich_load</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load and instantiate a PySCeS model so that it can be used for further analyses. This function is</span>
<span class="sd">        being replaced by the ModelLoad() method.</span>

<span class="sd">        - *stoich_load* try to load a structural analysis saved with Stoichiometry_Save_Serial() (default=0)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__PSC_auto_load</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelLoad</span><span class="p">(</span><span class="n">stoich_load</span><span class="o">=</span><span class="n">stoich_load</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PySCeS now automatically loads the model on model object instantiation. If you do not want this behaviour pass the autoload=False argument to the constructor, if you really want to reload the model, run reLoad().&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.reLoad"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.reLoad">[docs]</a>    <span class="k">def</span> <span class="nf">reLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stoich_load</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-load and instantiate a PySCeS model so that it can be used for further analyses. This is just a convenience call to the ModelLoad() method.</span>

<span class="sd">        - *stoich_load* try to load a structural analysis saved with Stoichiometry_Save_Serial() (default=0)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelLoad</span><span class="p">(</span><span class="n">stoich_load</span><span class="o">=</span><span class="n">stoich_load</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.LoadFromString"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.LoadFromString">[docs]</a>    <span class="k">def</span> <span class="nf">LoadFromString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fString</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Docstring required</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#grab model directory</span>
        <span class="n">chkmdir</span><span class="p">()</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">MODEL_DIR</span>

        <span class="c1"># check for .psc extension</span>
        <span class="n">File</span> <span class="o">=</span> <span class="n">chkpsc</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using model directory: &#39;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_DIR</span><span class="p">,</span><span class="s2">&quot;orca&quot;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_DIR</span><span class="p">,</span><span class="s2">&quot;orca&quot;</span><span class="p">))</span>

        <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODEL_DIR</span><span class="p">,</span><span class="s2">&quot;orca&quot;</span><span class="p">)</span>

        <span class="c1"># write string to file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">outFile</span> <span class="o">=</span> <span class="n">file</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fString</span><span class="p">)</span>
            <span class="n">outFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using file: &#39;</span> <span class="o">+</span> <span class="n">File</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; loading .....&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span> <span class="o">=</span> <span class="nb">dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">=</span> <span class="n">File</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; does not exist&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please set with ModelDir and ModelFile .....&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span> <span class="o">=</span> <span class="nb">dir</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; does not exist please re-instantiate model .....&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span> <span class="o">=</span> <span class="n">OUTPUT_DIR</span>


        <span class="c1">##  # Initialise elementary modes</span>
        <span class="c1">##  if os.sys.platform == &#39;win32&#39;:</span>
            <span class="c1">##  self.eModeExe_int = os.path.join(self.__metatool,&#39;meta43_int.exe&#39;)</span>
            <span class="c1">##  self.eModeExe_dbl = os.path.join(self.__metatool,&#39;meta43_double.exe&#39;)</span>
        <span class="c1">##  else:</span>
            <span class="c1">##  self.eModeExe_int = os.path.join(self.__metatool,&#39;meta43_int&#39;)</span>
            <span class="c1">##  self.eModeExe_dbl = os.path.join(self.__metatool,&#39;meta43_double&#39;)</span>
        <span class="c1">##  print &#39;Done.&#39;</span>

        <span class="c1"># Initialize serial directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span><span class="s1">&#39;pscdat&#39;</span><span class="p">)</span>
        <span class="c1"># Initialize stoichiometric precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_fp_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mach_spec</span><span class="o">.</span><span class="n">eps</span><span class="o">*</span><span class="mf">2.0e4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_lu_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_fp_zero&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_gj_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_lu_precision&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">10.0</span></div>


<div class="viewcode-block" id="PysMod.LoadFromFile"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.LoadFromFile">[docs]</a>    <span class="k">def</span> <span class="nf">LoadFromFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="nb">dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __init__(File=None,dir=None)</span>

<span class="sd">        Initialise a PySCeS model object with PSC file that can be found in optional directory.</span>
<span class="sd">        If a a filename is not supplied the pysces.model_dir directory contents is displayed and</span>
<span class="sd">        the model name can be entered at the promp (&lt;ctrl&gt;+C exits the loading process).</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: the name of the PySCeS input file</span>
<span class="sd">        dir [default=pysces.model_dir]: the optional directory where the PSC file can be found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">dir</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chkmdir</span><span class="p">()</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="n">MODEL_DIR</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chkmdir</span><span class="p">()</span>
            <span class="nb">dir</span> <span class="o">=</span> <span class="n">MODEL_DIR</span>

        <span class="n">mfgo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mfgo</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">File</span> <span class="o">=</span> <span class="n">chkpsc</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)):</span>
                <span class="n">mfgo</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">mfgo</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">while</span> <span class="n">mfgo</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Models available in your model_dir: </span><span class="se">\n</span><span class="s1">************&#39;</span><span class="p">)</span>
            <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">namelen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No models available in model directory, please set using pys_usercfg.ini or call</span><span class="se">\</span>
<span class="s1">                with pysces.model(</span><span class="se">\&#39;</span><span class="s1">file.psc</span><span class="se">\&#39;</span><span class="s1">,dir=</span><span class="se">\&#39;</span><span class="s1">path</span><span class="se">\\</span><span class="s1">to</span><span class="se">\\</span><span class="s1">models</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Please enter full path to models &lt;CTRL+C&gt; exits: &#39;</span><span class="p">)</span>

            <span class="n">dirList</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dirList</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dirList</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.psc&#39;</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">dirList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dirList</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">namelen</span><span class="p">:</span>
                    <span class="n">namelen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dirList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cntr</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="n">namelen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">You need to specify a valid model file ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">File</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Please enter filename: &#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">File</span> <span class="o">=</span> <span class="n">chkpsc</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)):</span>
                    <span class="n">mfgo</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">mfgo</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using model directory: &#39;</span> <span class="o">+</span> <span class="nb">dir</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; loading .....&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span> <span class="o">=</span> <span class="nb">dir</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">=</span> <span class="n">File</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; does not exist&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Please set with ModelDir and ModelFile .....&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span> <span class="o">=</span> <span class="nb">dir</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span><span class="n">File</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; does not exist please re-instantiate model .....&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span> <span class="o">=</span> <span class="n">OUTPUT_DIR</span>


        <span class="c1">##  # Initialise elementary modes</span>
        <span class="c1">##  if os.sys.platform == &#39;win32&#39;:</span>
            <span class="c1">##  self.eModeExe_int = os.path.join(self.__metatool,&#39;meta43_int.exe&#39;)</span>
            <span class="c1">##  self.eModeExe_dbl = os.path.join(self.__metatool,&#39;meta43_double.exe&#39;)</span>
        <span class="c1">##  else:</span>
            <span class="c1">##  self.eModeExe_int = os.path.join(self.__metatool,&#39;meta43_int&#39;)</span>
            <span class="c1">##  self.eModeExe_dbl = os.path.join(self.__metatool,&#39;meta43_double&#39;)</span>
        <span class="c1">##  print &#39;Done.&#39;</span>

        <span class="c1"># Initialize serial directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span><span class="s1">&#39;pscdat&#39;</span><span class="p">)</span>
        <span class="c1"># Initialize stoichiometric precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_fp_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mach_spec</span><span class="o">.</span><span class="n">eps</span><span class="o">*</span><span class="mf">2.0e4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_lu_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_fp_zero&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_gj_precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_lu_precision&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">10.0</span></div>

    <span class="c1">#def __LoadStomPyInterface__(self):</span>
        <span class="c1">#&quot;&quot;&quot;</span>
        <span class="c1">#Load the StomPy Stochastic simulation interface</span>
        <span class="c1">#&quot;&quot;&quot;</span>
        <span class="c1">#if _HAVE_STOMPY and self.__STOMPY__ == None:</span>
            <span class="c1">#self.__STOMPY__ = StomPyInterface(MODEL_DIR, OUTPUT_DIR)</span>
            <span class="c1">#print &#39;PySCeS/StomPy interface active&#39;</span>

    <span class="k">def</span> <span class="nf">__ParsePiecewiseFunctions__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">piecewises</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        THIS IS HIGHLY EXPERIMENTAL! Takes the a piecewises dictionary</span>
<span class="sd">        and creates a piecewise object while substituting the object name</span>
<span class="sd">        in the formula string.</span>

<span class="sd">        - *piecewises* a piecewise dictionary created by the InfixParser</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">piecewises</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">piecewises</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_PIECEWISE__</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">piecewises</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Info: adding piecewise object: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="p">)</span>
                <span class="c1">#if len(piecewises[p].keys()) == 2:</span>
                    <span class="c1"># piecewises[p][0].reverse() # only for libsbml generated infix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__piecewises__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">p</span> <span class="p">:</span> <span class="n">piecewises</span><span class="p">[</span><span class="n">p</span><span class="p">]})</span>
                <span class="n">P</span> <span class="o">=</span> <span class="n">PieceWise</span><span class="p">(</span><span class="n">piecewises</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">P</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">piecewise_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>

<div class="viewcode-block" id="PysMod.InitialiseInputFile"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseInputFile">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseInputFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        InitialiseInputFile()</span>

<span class="sd">        Parse the input file associated with the PySCeS model instance and assign the basic model attributes</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__parseOK</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># check that model has parsed ok?</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Invalid self.ModelFile: &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Problem verifying: &#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.psc&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assuming extension is .psc&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+=</span> <span class="s1">&#39;.psc&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parsing file: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">))</span>

        <span class="n">pscParser</span><span class="o">.</span><span class="n">ParsePSC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

        <span class="n">badlist</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">KeywordCheck</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">ReactionIDs</span><span class="p">)</span>
        <span class="n">badlist</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">KeywordCheck</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">Inits</span><span class="p">,</span><span class="n">badlist</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">badlist</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">******************************</span><span class="se">\n</span><span class="s1">PSC input file contains PySCeS keywords please rename them and reload:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">badlist</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   --&gt; &#39;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;******************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parseOK</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">#assert len(badlist) != 0, &#39;Keyword error, please check input file&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parseOK</span><span class="p">:</span>
            <span class="c1"># brett 2008</span>
            <span class="n">InfixParser</span><span class="o">.</span><span class="n">__pwcntr__</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">nDict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">sDict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__pDict__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">pDict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__uDict__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">uDict</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># model attributes are now initialised here brett2008</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__InitDict__</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># set parameters and add to __InitDict__</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__pDict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pDict__</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pDict__</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__InitDict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">__pDict__</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pDict__</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">]})</span>
            <span class="c1"># set species and add to __InitDict__ and set mod.Xi_init</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;fixed&#39;</span><span class="p">]:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_init&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__InitDict__</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">]})</span>

            <span class="c1"># setup keywords</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">KeyWords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Modelname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Modelname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.psc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.psc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># if SpeciesTypes undefined assume []</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># if OutputType is undefined assume it is the same as SpeciesType</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;ModelType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;ModelType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Deterministic&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;ModelType&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;ModelType&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>


            <span class="c1"># we now check for modeltype, if it specified as stochastic check if stochpy is available</span>
            <span class="c1">#if self.__KeyWords__[&#39;ModelType&#39;] == [&#39;Stochastic&#39;]:</span>
                <span class="c1">#if _HAVE_STOMPY:</span>
                    <span class="c1">#print &#39;INFO: This model suggests that it requires discrete simulation and StochPy is installed ... mod.doStochSim() and mod.doStochSimPlot() are available for use.&#39;</span>
                <span class="c1">#else:</span>
                    <span class="c1">#print &#39;INFO: This model suggests that it requires stochastic simulation and StochPy (stompy.sf.net) is not installed ... PySCeS will treat this model as continuous.&#39;</span>

            <span class="c1"># set the species type in sDict according to &#39;Species_In_Conc&#39;</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;isamount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;isamount&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># setup compartments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">compartments</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># no (self.)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">fixed_species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__modifiers__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">modifiers</span><span class="p">)</span>
            <span class="c1"># Initialize exposed stuff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fixed_species</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">fixed_species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modifiers</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">modifiers</span><span class="p">)</span>

            <span class="c1"># Add input file defined fuctions - brett 200500621</span>
            <span class="c1"># TODO deprecated</span>
            <span class="c1"># self._Function_time = copy.copy(pscParser.TimeFunc)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Function_user</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">UserFunc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Function_init</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">InitFunc</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__functions__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">Functions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">AssignmentRules</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__InitFuncs__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">ModelInit</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__userfuncs__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">UserFuncs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__eDict__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">Events</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cbm_fluxbounds__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">cbm_FluxBounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cbm_objfuncs__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">cbm_ObjectiveFunctions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__cbm_userfluxconstraints__</span> <span class="o">=</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">cbm_UserFluxConstraints</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1">##  if pscParser.ModelUsesNumpyFuncs:</span>
                <span class="c1">##  print &#39;Numpy functions detected in kinetic laws.\n&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ERROR: model parsing error, please check input file.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># added in a check for model correctness and human error reporting (1=ok, 0=error)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pscParser</span><span class="o">.</span><span class="n">SymbolErrors</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Undefined symbols:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">SymbolErrors</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">ParseOK</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">*****</span><span class="se">\n</span><span class="s1">Model parsing errors detected in input file &#39;</span><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">*****&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Input file errors&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">LexErrors</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="c1">##  try:</span>
                    <span class="c1">##  print error[0] + &#39;in line:\t&#39; + str(error[1]) + &#39; (&#39;+ error[2][:20] +&#39; ...)&#39;</span>
                <span class="c1">##  except IndexError:</span>
                    <span class="c1">##  print &#39;Illegal character:&#39;, error.__repr__(), error.__str__()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parser errors&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">ParseErrors</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                <span class="c1">##  try:</span>
                    <span class="c1">##  print error[0] + &#39;- &#39; + error[2][:20]</span>
                <span class="c1">##  except IndexError:</span>
                    <span class="c1">##  print &#39;Illegal character:&#39;, error</span>
            <span class="k">assert</span> <span class="n">pscParser</span><span class="o">.</span><span class="n">ParseOK</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Input File Error&#39;</span></div>

<div class="viewcode-block" id="PysMod.InitialiseRules"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseRules">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseRules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># we need to detect different types of rules etc</span>
        <span class="c1">#defmod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FORCED_FUNCS__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">rate_rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">assignment_rules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;assignment&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FORCED_FUNCS__</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">assignment_rules</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ar</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ar</span><span class="p">]})</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rate&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">rate_rules</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ar</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ar</span><span class="p">]})</span>

         <span class="c1"># THE NEW WAY (adds formula parsing for numpy functions etc)</span>
        <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_NewRuleXCode</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FORCED_FUNCS__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_substitute_assignment_rules&#39;</span><span class="p">]:</span>
            <span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">all_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">assignment_rules</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">assignment_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">assignment_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">])</span>
                <span class="n">assignment_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>
                <span class="n">formula</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
                <span class="c1"># this code has to stay together #</span>
                <span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span><span class="p">:</span>
                    <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">,</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ParsePiecewiseFunctions__</span><span class="p">(</span><span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span><span class="p">)</span>
                <span class="c1"># this code has to stay together #</span>
                <span class="n">assignment_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;code_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formula</span>
                <span class="n">all_names</span> <span class="o">+=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>

            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">)</span>
            <span class="n">keep</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">assignment_rules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">dep</span> <span class="o">=</span> <span class="n">rules</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dep</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">indep</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
                        <span class="n">indep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ar</span><span class="p">)</span>
                <span class="n">keep</span> <span class="o">+=</span> <span class="n">dep</span>
                <span class="n">rules</span> <span class="o">=</span> <span class="n">indep</span>
            <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">indep</span><span class="o">+</span><span class="n">keep</span><span class="p">:</span>
                <span class="n">evalCode</span> <span class="o">=</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">assignment_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>\
                                            <span class="n">assignment_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;code_string&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_NewRuleXCode</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">assignment_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="n">evalCode</span><span class="p">})</span>
                <span class="n">code_string</span> <span class="o">+=</span> <span class="n">evalCode</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Assignment rule(s) detected.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Function_forced</span>  <span class="o">=</span> <span class="n">code_string</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FORCED_FUNCS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_substitute_assignment_rules&#39;</span><span class="p">]:</span>
            <span class="c1"># here we substitute nested assignment rules</span>
            <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">symbR</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="n">assignment_rules</span><span class="p">:</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">assignment_rules</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">])</span>
                <span class="n">formula</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
                <span class="c1"># this code has to stay together #</span>
                <span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span><span class="p">:</span>
                    <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">,</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ParsePiecewiseFunctions__</span><span class="p">(</span><span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span><span class="p">)</span>
                <span class="c1"># this code has to stay together #</span>
                <span class="n">symbR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">assignment_rules</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>  <span class="p">:</span> <span class="n">formula</span><span class="p">})</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="n">assignment_rules</span><span class="p">:</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">FunctionReplacements</span> <span class="o">=</span> <span class="n">symbR</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">assignment_rules</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">])</span>
                <span class="n">assignment_rules</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;code_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Function_forced</span> <span class="o">=</span> <span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assignment rule(s) detected and substituted.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Function_forced</span> <span class="o">=</span> <span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__CODE_forced</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Function_forced</span><span class="p">,</span><span class="s1">&#39;AssignRules&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="c1"># tested in InitialiseRuleChecks()</span>


        <span class="c1"># defmod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rr_code_block</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">rr_map_block</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_NewRateRuleXCode</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="c1"># create a rr vector</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rate_rules</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="c1"># brett2008 debug stuff doesn&#39;t do any harm</span>
            <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rr_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rate_rules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">rr_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">ar</span> <span class="ow">in</span> <span class="n">rr_keys</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">rate_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">rate_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">])</span>
                <span class="n">formula</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
                <span class="n">rate_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;symbols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>
                <span class="c1"># this code has to stay together #</span>
                <span class="k">for</span> <span class="n">pw</span> <span class="ow">in</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span><span class="p">:</span>
                    <span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">,</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1">()&#39;</span> <span class="o">%</span> <span class="n">pw</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__ParsePiecewiseFunctions__</span><span class="p">(</span><span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span><span class="p">)</span>
                <span class="c1"># this code has to stay together #</span>
                <span class="n">rate_rules</span><span class="p">[</span><span class="n">ar</span><span class="p">][</span><span class="s1">&#39;code_string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formula</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">rr_code_block</span> <span class="o">+=</span> <span class="s1">&#39;self.__rrule__[</span><span class="si">%s</span><span class="s1">] = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cntr</span><span class="p">,</span> <span class="n">formula</span><span class="p">)</span>
                <span class="c1">##  rr_code_block += &#39;self.%s = self.__rrule__[%s]\n&#39; % (name, cntr)</span>
                <span class="n">rr_map_block</span> <span class="o">+=</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1"> = self.__rrule__[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cntr</span><span class="p">)</span>
                <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># create mod.&lt;rule name&gt;_init attributes</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_init&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Rate rule(s) detected.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rr_code_block</span> <span class="o">=</span> <span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">rr_map_block</span> <span class="o">=</span> <span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="c1">#TODO consider putting this in self.__HAS_RATE_RULES__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">rr_code_block</span><span class="p">,</span><span class="s1">&#39;RateRules&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule_map</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">rr_map_block</span><span class="p">,</span><span class="s1">&#39;RateRuleMap&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">rate_rules</span><span class="p">,</span> <span class="n">assignment_rules</span></div>

<div class="viewcode-block" id="PysMod.InitialiseRuleChecks"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseRuleChecks">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseRuleChecks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Assignment RateRule ZeroDivision on initialisation (continuing)&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: RateRule initialisation error</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>

        <span class="n">zeroDivErr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NewRuleXCode</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NewRuleXCode</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="s1">&#39;NewRuleXCode&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">zeroDivErr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">exit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NewRuleXCode</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">zeroDivErr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">exit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zeroDivErr2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">zeroDivErr</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_NewRuleXCode</span><span class="p">[</span><span class="n">kk</span><span class="p">],</span><span class="s1">&#39;NewRuleXCode&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule</span><span class="p">)</span>
                        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule_map</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">zeroDivErr2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
            <span class="n">exit</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">zeroDivErr</span> <span class="o">=</span> <span class="n">zeroDivErr2</span>
            <span class="k">if</span> <span class="n">exit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: ZeroDivision elimination failed&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_forced</span><span class="p">)</span>
            <span class="c1">#print &#39;done.&#39;</span>
        <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Assignment rule ZeroDivision on intialisation&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Assignment rule error (disabling all rules)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CODE_forced</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="s1">&#39;pass</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;AssignRules&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.Stoichiometry_Init"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Stoichiometry_Init">[docs]</a>    <span class="k">def</span> <span class="nf">Stoichiometry_Init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nmatrix</span><span class="p">,</span><span class="n">load</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stoichiometry_Init(nmatrix,load=0)</span>

<span class="sd">        Initialize the model stoichiometry. Given a stoichiometric matrix N, this method will return an instantiated PyscesStoich instance and status flag. Alternatively, if load is enabled, PySCeS will</span>
<span class="sd">        attempt to load a previously saved stoichiometric analysis (saved with Stoichiometry_Save_Serial)</span>
<span class="sd">        and test it&#39;s correctness. The status flag indicates 0 = reanalyse stoichiometry or</span>
<span class="sd">        1 = complete structural analysis preloaded.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        nmatrix: The input stoichiometric matrix, N</span>
<span class="sd">        load [default=0]: try to load a saved stoichiometry (1)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">load</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Loading saved stoichiometry ...&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stoichiometry_Load_Serial</span><span class="p">()</span>
                <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">slx</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">slx</span><span class="p">)</span>
                <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">row</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">nmatrix</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">go</span><span class="p">:</span>
                <span class="n">badList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">stc</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]:</span>
                        <span class="n">badList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stc</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
                        <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">stc</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]:</span>
                            <span class="n">badList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">stc</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span>
                            <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">nmatrix</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">-</span> <span class="n">stc</span><span class="o">.</span><span class="n">nmatrix</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">stc</span><span class="o">.</span><span class="n">stoichiometric_analysis_fp_zero</span><span class="p">:</span>
                            <span class="n">badList</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">),</span><span class="n">nmatrix</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">],</span><span class="n">stc</span><span class="o">.</span><span class="n">nmatrix</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]))</span>
                            <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">go</span><span class="p">:</span>
                <span class="c1">##  print &#39;Stoichiometry mismatch&#39;</span>
                <span class="c1">##  for x in badList:</span>
                    <span class="c1">##  print x,</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Problem loading stoichiometry, reanalysing ...&#39;</span><span class="p">)</span>
                <span class="n">stc</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">Stoich</span><span class="p">(</span><span class="n">nmatrix</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stoichiometry verified ... we have liftoff&#39;</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#print &#39;Instantiating new stoichiometry ...&#39;</span>
            <span class="n">stc</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">Stoich</span><span class="p">(</span><span class="n">nmatrix</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">stc</span><span class="p">,</span><span class="n">status</span></div>


<div class="viewcode-block" id="PysMod.Stoichiometry_Save_Serial"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Stoichiometry_Save_Serial">[docs]</a>    <span class="k">def</span> <span class="nf">Stoichiometry_Save_Serial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Serialize and save a Stoichiometric instance to binary pickle&quot;&quot;&quot;</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Stoichiometry_Save_Serial()</span>

<span class="s2">        Serilaise and save the current model stoichiometry to a file with name &lt;model&gt;_stoichiometry.pscdat</span>
<span class="s2">        in the mod.__settings__[&#39;serial_dir&#39;] directory (default: mod.model_output/pscdat)</span>

<span class="s2">        Arguments:</span>
<span class="s2">        None</span>

<span class="s2">        &quot;&quot;&quot;</span>
        <span class="c1"># new plan, I introduce species and reaction arrays into the stoich instance for verification purposes</span>
        <span class="c1"># brett - 20050831</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">__species__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">__reactions__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SerialEncode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STOICH</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_stoichiometry&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.Stoichiometry_Load_Serial"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Stoichiometry_Load_Serial">[docs]</a>    <span class="k">def</span> <span class="nf">Stoichiometry_Load_Serial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stoichiometry_Load_Serial()</span>

<span class="sd">        Load a saved stoichiometry saved with mod.Stoichiometry_Save_Serial() and return</span>
<span class="sd">        a stoichiometry instance.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SerialDecode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_stoichiometry&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stc</span></div>

    <span class="c1"># new powerslave method - brett 20050825</span>
<div class="viewcode-block" id="PysMod.Stoichiometry_Analyse"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Stoichiometry_Analyse">[docs]</a>    <span class="k">def</span> <span class="nf">Stoichiometry_Analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">override</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">load</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stoichiometry_Analyse(override=0,load=0)</span>

<span class="sd">        Perform a structural analyses. The default behaviour is to construct and analyse the model</span>
<span class="sd">        from the parsed model information. Overriding this behaviour analyses the stoichiometry</span>
<span class="sd">        based on the current stoichiometric matrix. If load is specified PySCeS tries to load a</span>
<span class="sd">        saved stoichiometry, otherwise the stoichiometric analysis is run. The results of</span>
<span class="sd">        the analysis are checked for floating point error and nullspace rank consistancy.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        override [default=0]: override stoichiometric analysis intialisation from parsed data</span>
<span class="sd">        load [default=0]: load a presaved stoichiometry</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">override</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initmodel__</span><span class="p">()</span>            <span class="c1">#Creates the model N</span>
            <span class="c1">#print &#39;\nintializing N\n&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Stoichiometric override active</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Unable to generate Stoichiometric Matrix! model has:</span><span class="se">\n</span><span class="si">%s</span><span class="s1"> reactions</span><span class="se">\n</span><span class="si">%s</span><span class="s1"> species</span><span class="se">\n</span><span class="s1">what did you have in mind?</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="o">.</span><span class="n">shape</span>               <span class="c1">#Get the shape of N</span>
        <span class="c1">##  self.__Vtemp__ = numpy.zeros((self.__Nshape__[1])) # going going ....</span>

        <span class="c1"># get stoich instance and whether it was analysed or loaded - brett 20050830</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="p">,</span> <span class="n">stc_load</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Stoichiometry_Init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">,</span><span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">)</span>

        <span class="c1"># if not loaded analyze - brett 20050830</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stc_load</span><span class="p">:</span>
            <span class="c1"># technically this means we can define this on the fly - brett #20051013</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">stoichiometric_analysis_fp_zero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_fp_zero&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">stoichiometric_analysis_lu_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_lu_precision&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">stoichiometric_analysis_gj_precision</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;stoichiometric_analysis_gj_precision&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">AnalyseL</span><span class="p">()</span>           <span class="c1">#Get all L related stuff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">AnalyseK</span><span class="p">()</span>           <span class="c1">#Get all K related stuff</span>


        <span class="c1">#test matrix values against __settings__[&#39;stoichiometric_analysis_lu_precision&#39;]</span>
        <span class="n">lsmall</span><span class="p">,</span><span class="n">lbig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">MatrixValueCompare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix</span><span class="p">)</span>
        <span class="n">ksmall</span><span class="p">,</span><span class="n">kbig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">MatrixValueCompare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix</span><span class="p">)</span>
        <span class="n">SmallValueError</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lsmall</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">stoichiometric_analysis_lu_precision</span><span class="o">*</span><span class="mf">10.0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: values in L0matrix are close to stoichiometric precision!&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stoichiometric LU precision:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">stoichiometric_analysis_lu_precision</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;L0 smallest abs(value)&#39;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lsmall</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Machine precision:&#39;</span><span class="p">,</span> <span class="n">mach_spec</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
            <span class="n">SmallValueError</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ksmall</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">stoichiometric_analysis_lu_precision</span><span class="o">*</span><span class="mf">10.0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: values in K0matrix are close to stoichiometric precision!&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stoichiometric precision:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">stoichiometric_analysis_lu_precision</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;K0 smallest abs(value)&#39;</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ksmall</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Machine precision:&#39;</span><span class="p">,</span> <span class="n">mach_spec</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
            <span class="n">SmallValueError</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">SmallValueError</span><span class="p">:</span>
            <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Structural Analysis results may not be reliable!!!.</span><span class="se">\n\n</span><span class="s1">Try change &lt;mod&gt;.__settings__[&quot;stoichiometric_analysis_lu_precision&quot;] (see reference manual for details)</span><span class="se">\n\n\t</span><span class="s1"> press any key to continue: &#39;</span><span class="p">)</span>

        <span class="c1"># cross check that rank is consistant between K0 and L0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: the rank calculated by the Kand L analysis methods are not the same!&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">K analysis calculates the rank as: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">L analysis calculates the rank as: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This is not good! Structural Analysis results are not reliable!!!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">StructuralAnalysis Error: rank mismatch&#39;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FLUX_CONSERVATION__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">info_flux_conserve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">info_moiety_conserve</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;enable_deprecated_attr&#39;</span><span class="p">]:</span>
            <span class="c1">##  self.__nmatrix__ = copy.copy(self.nmatrix)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span> <span class="c1"># done with caution brett2008</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nmatrix_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nmatrix_col</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">kmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kmatrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kmatrix_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kmatrix_col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix_col</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lmatrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lmatrix_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lmatrix_col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix_col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">conservation_matrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">conservation_matrix_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">conservation_matrix_col</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nrmatrix</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nrmatrix_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nrmatrix_col</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix</span><span class="p">)</span>
        <span class="c1"># switch that is set if the stoichiometric analysis is up to date</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">reactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nmatrix</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">StructMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nmatrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nmatrix_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nmatrix</span><span class="o">.</span><span class="n">setRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nmatrix</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">StructMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nrmatrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">setRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Kmatrix</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">StructMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kmatrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Kmatrix</span><span class="o">.</span><span class="n">setRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Kmatrix</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K0matrix</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">StructMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">kzeromatrix_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K0matrix</span><span class="o">.</span><span class="n">setRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K0matrix</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Lmatrix</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">StructMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lmatrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lmatrix</span><span class="o">.</span><span class="n">setRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Lmatrix</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">L0matrix</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">StructMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L0matrix</span><span class="o">.</span><span class="n">setRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L0matrix</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">info_moiety_conserve</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Consmatrix</span> <span class="o">=</span> <span class="n">PyscesStoich</span><span class="o">.</span><span class="n">StructMatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">conservation_matrix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">conservation_matrix_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">conservation_matrix_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Consmatrix</span><span class="o">.</span><span class="n">setRow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Consmatrix</span><span class="o">.</span><span class="n">setCol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Consmatrix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__StoichOK</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.Stoichiometry_ReAnalyse"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Stoichiometry_ReAnalyse">[docs]</a>    <span class="k">def</span> <span class="nf">Stoichiometry_ReAnalyse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stoichiometry_ReAnalyse()</span>

<span class="sd">        Reanalyse the stoichiometry using the current N matrix ie override=1</span>
<span class="sd">        (for use with mod.Stoich_matrix_SetValue)</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Stoichiometry_Analyse</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseConservationArrays</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.Stoich_nmatrix_SetValue"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Stoich_nmatrix_SetValue">[docs]</a>    <span class="k">def</span> <span class="nf">Stoich_nmatrix_SetValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">species</span><span class="p">,</span><span class="n">reaction</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stoich_nmatrix_SetValue(species,reaction,value)</span>

<span class="sd">        Change a stoichiometric coefficient&#39;s value in the N matrix. Only a coefficients magnitude may be set, in other words a</span>
<span class="sd">        a coefficient&#39;s value must remain negative, positive or zero. After changing a coefficient</span>
<span class="sd">        it is necessary to Reanalyse the stoichiometry.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        species: species name (s0)</span>
<span class="sd">        reaction: reaction name (R4)</span>
<span class="sd">        value: new coefficient value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Stoich_nmatrix_FindIndex__</span><span class="p">(</span><span class="n">species</span><span class="p">,</span><span class="n">reaction</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__Stoich_nmatrix_CheckValue__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__Stoich_nmatrix_UpdateValue__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__StoichOK</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">__Stoich_nmatrix_FindIndex__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">species</span><span class="p">,</span><span class="n">reaction</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __Stoich_nmatrix_FindIndex__(species,reaction)</span>

<span class="sd">        Return the N matrix co-ordinates of the coefficient referenced by species and reaction name.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        species: species name</span>
<span class="sd">        reaction: reaction name</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cval</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">species</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">rval</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reaction</span> <span class="o">==</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">cval</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rval</span><span class="p">,</span><span class="n">cval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__Stoich_nmatrix_UpdateValue__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xxx_todo_changeme</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __Stoich_nmatrix_UpdateValue__((x,y), val)</span>

<span class="sd">        Update N matrix co-ordinates (x,y) with val</span>

<span class="sd">        Arguments:</span>
<span class="sd">        (x,y): row, column coordinates</span>
<span class="sd">        val: value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">xxx_todo_changeme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmatrix</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nmatrix</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">__Stoich_nmatrix_CheckValue__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xxx_todo_changeme1</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __Stoich_nmatrix_CheckValue__((x,y),val)</span>

<span class="sd">        Check validity of new coefficient value against existing N matrix coefficient (x,y) for existance and/or sign.</span>
<span class="sd">        Returns 1 (true) or 0.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        (x,y): N matrix coordinates</span>
<span class="sd">        val: new value</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">xxx_todo_changeme1</span>
        <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">y</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Species (nmatrix) index  =&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reaction (nmatrix) index =&#39;</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">I</span><span class="se">\&#39;</span><span class="s1">m confused, perhaps you entered an incorrect species or reaction name&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;or they are in the wrong order?&#39;</span><span class="p">)</span>
            <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Zero coefficient violation&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  nmatrix[&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;] can only be = 0.0 (input &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Positive coefficient violation&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  nmatrix[&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;] can only be &gt; 0.0 (input &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Negative coefficient violation&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  nmatrix[&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;] can only be &lt; 0.0 (input &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">go</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

<div class="viewcode-block" id="PysMod.SerialEncode"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.SerialEncode">[docs]</a>    <span class="k">def</span> <span class="nf">SerialEncode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SerialEncode(data,filename)</span>

<span class="sd">        Serialise and save a Python object using a binary pickle to file. The serialised object</span>
<span class="sd">        is saved as &lt;filename&gt;.pscdat in the directory defined by mod.model_serial.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        data: pickleable Python object</span>
<span class="sd">        filename: the ouput filename</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.pscdat&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">]):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">cPickle data stored in: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">])</span>

        <span class="n">File</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">),</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">File</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serialization complete&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">E</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serialize error:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">E</span><span class="p">)</span>
        <span class="n">File</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">File</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">data</span></div>


<div class="viewcode-block" id="PysMod.SerialDecode"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.SerialDecode">[docs]</a>    <span class="k">def</span> <span class="nf">SerialDecode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SerialDecode(filename)</span>

<span class="sd">        Decode and return a serialised object saved with SerialEncode.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        filename: the filename (.pscdat is assumed)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.pscdat&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">],</span><span class="n">filename</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Serialized data &#39;</span><span class="o">+</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">],</span><span class="n">filename</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; does not exist&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">File</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;serial_dir&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">),</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serial decoding complete&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">E</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Serial decode error:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">E</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="PysMod.InitialiseCompartments"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseCompartments">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseCompartments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># the name should say it all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;compartment_fudge_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">startFudging</span> <span class="o">=</span> <span class="mf">1.0e-8</span>
        <span class="n">I_AM_FUDGING</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">())])</span>
            <span class="k">if</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="n">startFudging</span><span class="p">:</span>
                <span class="c1">##  self.__settings__[&#39;compartment_fudge_factor&#39;] = 10.0**round(numpy.log10(tmp))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;compartment_fudge_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span> <span class="c1"># sneaky b%*))_)%$^&amp;*@rds</span>
                <span class="c1">##  print &#39;compartment_fudge_factor&#39;, self.__settings__[&#39;compartment_fudge_factor&#39;]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;compartment_fudge_factor&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">startFudging</span><span class="p">:</span>
                    <span class="n">newsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;compartment_fudge_factor&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: Rescaling compartment with size </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">],</span> <span class="n">newsize</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newsize</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;scale&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;compartment_fudge_factor&#39;</span><span class="p">]})</span>
                    <span class="n">I_AM_FUDGING</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_init&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;COMPARTMENT WARNING: this model has a compartment defined </span><span class="si">%s</span><span class="s1"> but </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1"> is not in it ... I</span><span class="se">\&#39;</span><span class="s1">ll try it for now&#39;</span> <span class="o">%</span>\
                    <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">())],</span> <span class="n">sp</span><span class="p">))</span>
                    <span class="c1">##  print self.__sDict__[sp]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">,</span>\
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">COMPARTMENT ERROR: this model has multiple compartments defined </span><span class="si">%s</span><span class="s1"> but </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1"> is not in one!&#39;</span> <span class="o">%</span>\
                    <span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="o">.</span><span class="n">keys</span><span class="p">())],</span> <span class="n">sp</span><span class="p">)</span>
                <span class="c1"># brett 2008 fudge this!</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">I_AM_FUDGING</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;compartment_fudge_factor&#39;</span><span class="p">]</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">])</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_init&#39;</span> <span class="o">%</span> <span class="n">sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: Rescaling species (</span><span class="si">%s</span><span class="s1">) to size </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">sp</span><span class="p">][</span><span class="s1">&#39;initial&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__null_compartment__</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">uses_null_compartments</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__sDict__</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;__null_compartment__&#39;</span><span class="p">)</span>
                <span class="n">uses_null_compartments</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">uses_null_compartments</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;__null_compartment___init&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="c1">##  self.__CsizeFSIdx__ = []</span>
        <span class="c1">##  for s in self.__fixed_species__:</span>
            <span class="c1">##  if self.__HAS_COMPARTMENTS__:</span>
                <span class="c1">##  self.__CsizeFSIdx__.append(self.__sDict__[s][&#39;compartment&#39;])</span>
            <span class="c1">##  else:</span>
                <span class="c1">##  self.__CsizeFSIdx__.append(&#39;__null_compartment__&#39;)</span>

        <span class="c1"># Init compartment divisions vector - brett 2008</span>
        <span class="c1">##  self.__CsizeAll__ = numpy.ones(len(self.__CsizeAllIdx__), &#39;d&#39;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;size&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span></div>
        <span class="c1">##  self.__CsizeFS__ = numpy.array([self.__compartments__[c][&#39;size&#39;] for c in self.__CsizeFSIdx__], &#39;d&#39;)</span>


    <span class="c1"># add new function types to model</span>
<div class="viewcode-block" id="PysMod.InitialiseFunctions"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseFunctions">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseFunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__functions__</span><span class="p">:</span>
            <span class="n">F</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__functions__</span><span class="p">[</span><span class="n">func</span><span class="p">][</span><span class="s1">&#39;args&#39;</span><span class="p">]:</span>
                <span class="n">F</span><span class="o">.</span><span class="n">setArg</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">F</span><span class="o">.</span><span class="n">addFormula</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__functions__</span><span class="p">[</span><span class="n">func</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__functions__</span><span class="p">:</span>
            <span class="n">fobj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fobj</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__functions__</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">fobj</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span></div>

    <span class="c1"># add event types to model</span>
<div class="viewcode-block" id="PysMod.InitialiseEvents"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseEvents">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__events__</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for each event</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eDict__</span><span class="p">:</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">_time_symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eDict__</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;tsymb&#39;</span><span class="p">]</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">setTrigger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__eDict__</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;trigger&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eDict__</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;delay&#39;</span><span class="p">])</span>
            <span class="c1"># for each assignment</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eDict__</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;assignments&#39;</span><span class="p">]:</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">setAssignment</span><span class="p">(</span><span class="n">ass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eDict__</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="s1">&#39;assignments&#39;</span><span class="p">][</span><span class="n">ass</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ev</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_EVENTS__</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Event(s) detected.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_EVENTS__</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.InitialiseModel"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseModel">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseModel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        InitialiseModel()</span>

<span class="sd">        Initialise and set up dynamic model attributes and methods using the model defined in</span>
<span class="sd">        the associated PSC file</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO killkillkill</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">,</span> <span class="n">DvarUpString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initvar__</span><span class="p">()</span> <span class="c1">#Initialise s[] array</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">__CDvarUpString__</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">DvarUpString</span><span class="p">,</span><span class="s1">&#39;DvarUpString&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">##  self.sim_res = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_u</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_var</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_c__</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="c1">#  #debug</span>
        <span class="c1">#  self.display_debugcount = 0</span>
        <span class="c1">#  self.cntr = 50</span>

        <span class="n">par_map2store</span><span class="p">,</span> <span class="n">par_remap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initfixed__</span><span class="p">()</span>         <span class="c1">#Initialise fixed species</span>

        <span class="c1">#self.__par_map2storeC =  par_map2store</span>
        <span class="c1">#self.__par_remapC =  par_remap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__par_map2storeC</span> <span class="o">=</span>  <span class="nb">compile</span><span class="p">(</span><span class="n">par_map2store</span><span class="p">,</span><span class="s1">&#39;par_map2store&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__par_remapC</span> <span class="o">=</span>  <span class="nb">compile</span><span class="p">(</span><span class="n">par_remap</span><span class="p">,</span><span class="s1">&#39;par_remap&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>

        <span class="c1">##  self.__xMake = compile(xString,&#39;xString&#39;,&#39;exec&#39;)</span>
        <span class="c1">##  exec(self.__xMake)</span>

        <span class="c1"># initialise rate equations</span>
        <span class="n">mapString</span><span class="p">,</span><span class="n">mapString_R</span><span class="p">,</span><span class="n">vString</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initREQ__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__mapFunc__</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">mapString</span><span class="p">,</span><span class="s1">&#39;mapString&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mapFunc_R__</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">mapString_R</span><span class="p">,</span><span class="s1">&#39;mapString_R&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__vFunc__</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">vString</span><span class="p">,</span><span class="s1">&#39;vString&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="c1">##  exec(lambdaFuncsC)</span>

        <span class="c1"># Machine specific values (for IEEE compliant FP machines this is around 2.e-16)</span>
        <span class="c1"># FutureNote: investigate arbitrary precision FP in Python, probably GNU-GMP based - brett 20040326</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mach_spec</span><span class="o">.</span><span class="n">eps</span>

        <span class="c1"># PySCeS mode switches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%2.4e</span><span class="s1">&#39;</span> <span class="c1"># this affects number output formatting in PySCeS)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_init&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>         <span class="c1"># 0:initval, 1:zeroval, 2:lastss 3:sim_res[-1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_max_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>     <span class="c1"># maximum number of auto-stepsize adjustments</span>

        <span class="c1">#TODO UPGRADE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_state_init</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># 0:initval, 1:zeroval, 2:sim, 3:%state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">=</span> <span class="s1">&#39;HYBRD&#39;</span>              <span class="c1"># 0:HYBRD, 1:FINTSLV, 2:NLEQ2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver_fallback</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 0:Solver failure fails,</span>
                                       <span class="c1"># 1:solver failure falls back to NLEQ2 if present then FINTSLV (see next)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">STATE_extra_output</span> <span class="o">=</span> <span class="p">[]</span>   <span class="c1"># extra data added to data_sstate object</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_init3_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># factor to multiply the previous ss used as initialiser</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__mode_state_init2_array__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">18</span><span class="p">)</span> <span class="c1"># the simulation array used to initialise the steady state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># happy exit message from State()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_nan_on_fail&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># give last best solutions or NaN as solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;solver_switch_warning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># the irritating switching to message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_solver_fallback_integration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 0:no fallback to forward integration 1:fallback to integration</span>
        <span class="c1"># this is now initialised in the model parsing sectiomn ParseModel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># the order of ScipyDerivative - 3 seems good for most situations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># MCA scaling option 0:unscaled E+C+Eig 1:scaled E+C+Eig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_eigen_output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># 0:normal, 1:extended eigen value + left/right vectors</span>
        <span class="c1"># under consideration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_suppress_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># 0:warnings displayed, 1:warnings suppressed</span>
        <span class="c1"># new compartment stuff (using dictionary directly) - brett 2008</span>

        <span class="c1">##  self.Species_In_Conc = False</span>

        <span class="c1"># misc settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># write an id header before the array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_spacer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># write a empty line before the array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_html_header&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#write html page header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_html_footer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#write html page footer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_html_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%2.4f</span><span class="s1">&#39;</span> <span class="c1">#html number format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># lines to write before flushing to disk</span>

        <span class="c1"># Hybrd options (zero value means routine decides)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_xtol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-12</span>    <span class="c1"># relative error tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_maxfev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># Maximum number of calls, zero means then 100*(len(species)+1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_epsfcn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">])</span> <span class="c1"># A suitable step length for the forward-difference approximation of the Jacobian</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>     <span class="c1"># A parameter determining the initial step bound in interval (0.1,100)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># print the exit status message</span>

        <span class="c1"># Finstslv options (forward integration solver) - brett (20030331)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;fintslv_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-3</span>   <span class="c1"># max allowed deviation between max(sim_res) to be a steady state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;fintslv_step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>       <span class="c1"># threshold number of steps where deviation &lt; atol to be declared a steady state</span>
        <span class="c1"># a &quot;saturation&quot; type range - should be ok for most systems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fintslv_range__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">5000</span><span class="p">,</span><span class="mi">10000</span><span class="p">,</span><span class="mi">50000</span><span class="p">,</span><span class="mi">50100</span><span class="p">,</span><span class="mi">50200</span><span class="p">,</span><span class="mi">50300</span><span class="p">,</span><span class="mi">50400</span><span class="p">,</span><span class="mi">50500</span><span class="p">,</span><span class="mi">50600</span><span class="p">,</span><span class="mi">50700</span><span class="p">,</span><span class="mi">50800</span><span class="p">,</span><span class="mi">50850</span><span class="p">,</span><span class="mi">50900</span><span class="p">,</span><span class="mi">50950</span><span class="p">,</span><span class="mi">51000</span><span class="p">],</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="c1">#self.__fintslv_range__ = numpy.array([1,10,100,1000,5000,10000,50000,100000,500000,1000000,1000100, 1000200,1000300,1000400,1000500,1000600,1000700,1000800],&#39;d&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;fintslv_rmult&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># NLEQ2 options (optional non-linear solver) - brett (20030331)</span>
        <span class="c1"># IOPT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_advanced_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># use advanced NLEQ2 features ... may speedup some parameter scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_growth_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># nitmax growth factor per nleq2 iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iter&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">3</span>       <span class="c1"># number of itertions to loop the solver through (2 should almost always be sufficient)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iter_max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>    <span class="c1"># maximum numbe rof iterations in advanced mode</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_rtol&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="mf">1.e-8</span>   <span class="c1"># automatically calculated by nleq12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_jacgen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>       <span class="c1"># 2:numdiff, 3:numdiff+feedback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iscaln&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># 0:xscal lower thresholdof scaling vector, 1:always scaling vector</span>
        <span class="c1"># Dangerous anything not zero seqfaults</span>
        <span class="c1">## self.__settings__[&#39;nleq2_mprerr&#39;] = 1       # 0:no output, 1:error, 2:+warning, 3:+info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_nonlin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>       <span class="c1"># 1:linear, 2:mildly non-lin, 3:highly non-lin, 4:extremely non-lin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_qrank1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># 0:no Broyden approx. rank-1 updates, 1:Broyden approx. rank-1 updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_qnscal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># 0:Automatic row scaling is active, 1:inactive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_ibdamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># 0:auto damping strategy, 1:damping on, 2:damping off</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_nitmax_growth_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># on non-superlinear convergance nitmax *= this (ierr=5)</span>
        <span class="c1"># TODO: chekc this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iormon&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>       <span class="c1"># 0:default(2) 1:convergance not checked, 2:+&#39;weak stop&#39;, 3:+&#39;hard stop&#39; criterion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># print the exit status message</span>
        <span class="c1">#TODO:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nleq2_nitmax</span> <span class="o">=</span> <span class="mi">50</span>      <span class="c1"># optimized and self adjusting :-)</span>

        <span class="c1"># Other SteadyState options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;small_concentration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-6</span>       <span class="c1"># the initial values of 1:zeroval smaller than 1.0e-6 sometimes give problems</span>
        <span class="c1">##  self.__state_set_conserve__ = 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span> <span class="o">=</span> <span class="kc">None</span>            <span class="c1"># new object for recarray with simulation results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># the new integration results data object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_stochsim</span> <span class="o">=</span> <span class="kc">None</span>        <span class="c1"># the new stochastic integration results data object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_results__</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># yaaaay gnuplot is back</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_pars__</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Simulate/lsoda options (zero value means routine decides)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;lsoda_atol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-12</span>    <span class="c1"># The input parameters rtol and atol determine the error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;lsoda_rtol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-7</span>     <span class="c1"># control performed by the solver. -- johann 20050217 changed from 1e-5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># maximum number (internally defined) steps allowed per point. 0: x &lt;= 500</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_h0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>         <span class="c1"># the step size to be attempted on the first step.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_hmax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># the maximum absolute step size allowed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_hmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>       <span class="c1"># the minimum absolute step size allowed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxordn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">12</span>      <span class="c1"># maximum order to be allowed for the nonstiff (Adams) method.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>       <span class="c1"># maximum order to be allowed for the stiff (BDF) method.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mesg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># print the exit status message</span>

        <span class="c1"># try to select the best integration algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span> <span class="o">=</span> <span class="s1">&#39;LSODA&#39;</span> <span class="c1"># LSODA/CVODE set the intgration algorithm</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_EVENTS__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_HAVE_PYSUNDIALS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: events detected and we have PySundials installed, switching to CVODE (mod.mode_integrator=</span><span class="se">\&#39;</span><span class="s1">CVODE</span><span class="se">\&#39;</span><span class="s1">).&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span> <span class="o">=</span> <span class="s1">&#39;CVODE&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: PySCeS needs PySundials installed for event handling, PySCeS will continue with LSODA (NOTE: ALL EVENTS WILL BE IGNORED!).&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Windows users may install the &quot;pysces_pysundials&quot; package from pysces.sf.net&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For other OS</span><span class="se">\&#39;</span><span class="s1">s see pysundials.sf.net for installation details</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__events__</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#if self.__HAS_RATE_RULES__ or self.__HAS_COMPARTMENTS__:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_HAVE_PYSUNDIALS</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: RateRules detected and PySundials installed, switching to CVODE (mod.mode_integrator=</span><span class="se">\&#39;</span><span class="s1">CVODE</span><span class="se">\&#39;</span><span class="s1">).</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span> <span class="o">=</span> <span class="s1">&#39;CVODE&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: RateRules detected! PySCeS prefers CVODE but will continue with LSODA (NOTE: VARIABLE COMPARTMENTS ARE NOT SUPPORTED WITH LSODA!)&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Windows users may install the &quot;pysces_pysundials&quot; package from pysces.sf.net&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For other OS</span><span class="se">\&#39;</span><span class="s1">s see pysundials.sf.net for installation details</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># pysundials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># only available with CVODE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_abstol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-15</span>     <span class="c1"># absolute tolerance</span>
        <span class="c1">##  self.__settings__[&quot;cvode_abstol_max&quot;]  = 1.0e-3 # not used anymore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_abstol_factor&quot;</span><span class="p">]</span>  <span class="o">=</span> <span class="mf">1.0e-6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_reltol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-9</span>      <span class="c1"># relative tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_auto_tol_adjust&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># auto reduce tolerances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>        <span class="c1"># max step default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_stats&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>         <span class="c1"># print some pretty stuff after a simulation</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_PIECEWISE__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_reltol&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.0e-9</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_reltol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-6</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: Piecewise functions detected increasing CVODE tolerance slightly (mod.__settings__[</span><span class="se">\&quot;</span><span class="s1">cvode_reltol</span><span class="se">\&quot;</span><span class="s1">] = 1.0e-9 ).&#39;</span><span class="p">)</span>

        <span class="c1"># Normal simulation options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_start</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span> <span class="o">=</span> <span class="mf">10.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span> <span class="o">=</span> <span class="mf">20.0</span>
        <span class="n">sim_steps</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_start</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span> <span class="o">+</span> <span class="n">sim_steps</span><span class="p">,</span> <span class="n">sim_steps</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SIMPLOT_OUT__</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># elasticity options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;elas_evar_upsymb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>        <span class="c1"># attach elasticities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;elas_epar_upsymb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>        <span class="c1"># attach parameter elasticities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;elas_evar_remap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>             <span class="c1"># remap steady state values ... no if SimElas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0001</span> <span class="c1"># used to determine a stepsize dx=So*factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-12</span>   <span class="c1"># minimum value dx is allowed to have</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_zero_flux_fix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># replaces zero fluxes with a very small number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_zero_conc_fix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># replaces zero concentrations with a very small number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_scaling_div0_fix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># if Infinite values are created when scaling set to zero</span>

        <span class="c1"># MCA options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccj_upsymb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># attach the flux control coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccs_upsymb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>         <span class="c1"># attach the concentration control coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_fluxout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># in .showCC() output flux cc&#39;s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_concout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># in .showCC() output conc cc&#39;s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_altout&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1"># in .showCC() all CC&#39;s group by reaction</span>

        <span class="c1"># gone in 60 seconds brett2008 (Refactored to PyscesLink)</span>
        <span class="c1">##  # Elementary mode options</span>
        <span class="c1">##  self.emode_userout = 0     # write metatool output to file 0:no, 1:yes</span>
        <span class="c1">##  self.emode_intmode = 0  # 0:float metatool, 1:integer metatool</span>
        <span class="c1">##  self.emode_file = self.ModelFile[:-4] + &#39;_emodes&#39;</span>

        <span class="c1"># pitcon (pitcon 6.1) continuation options - brett 20040429</span>
        <span class="c1">#my interface controls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_fix_small&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1">#in the REq evaluation values &lt;1.e-15 = 1.e-15</span>
        <span class="c1">#TODO:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_par_space</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="c1">#parameter space that pitcon must search in</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_iter</span> <span class="o">=</span> <span class="mi">10</span>        <span class="c1">#number of iterations to search for every point in par_space</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_allow_badstate&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#initialize with non steady-state values 0:no,1:yes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_flux_gen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1">#generate fluxes as output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_filter_neg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c1">#drop pitcon results containing negative concentrations 0:no,1:yes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_filter_neg_res&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#drop output results containing negative concentrations 0:no,1:yes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_max_step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span>        <span class="c1">#Maximum stepsize</span>
        <span class="c1">#TODO:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_target_points</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#list of calculated target points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_limit_points</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#list of calculated limit points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_targ_val</span> <span class="o">=</span> <span class="mf">0.0</span>        <span class="c1">#Target value (Seek solution with iwork[4]=)</span>

        <span class="c1"># moved to InitialiseConservationArrays</span>
        <span class="c1"># self.__settings__[&quot;pitcon_max_step&quot;] = 10*(len(self.__SI__)+1) #max corrector steps</span>

        <span class="c1">#pitcon integer options iwork in pitcon/dpcon61.f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_init_par&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>        <span class="c1">#Use X(1) for initial parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_par_opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1">#Parameterization option 0:allows program</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_jac_upd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1">#Update jacobian every newton step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_targ_val_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1">#Seek target values for X(n)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_limit_point_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1">#Seek limit points in X(n)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_output_lvl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c1">#Control amount of output.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_jac_opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>            <span class="c1">#Jacobian choice. 0:supply jacobian,1:use forward difference,2:central difference</span>
        <span class="c1">#pitcon float options rwork in pitcon/dpcon61.f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_abs_tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>    <span class="c1">#Absolute error tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_rel_tol&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.00001</span>    <span class="c1">#Relative error tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_min_step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.01</span>        <span class="c1">#Minimum stepsize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_start_step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.3</span>    <span class="c1">#Starting stepsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_start_dir&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>        <span class="c1">#Starting direction +1.0/-1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_max_grow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">3.0</span>        <span class="c1">#maximum growth factor</span>

        <span class="c1"># setup conservation matrices (L_switch is set by stoich to 1 if it &quot;detects&quot; conservation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InitialiseConservationArrays</span><span class="p">()</span>

        <span class="c1"># scan option - removed from initsimscan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># should scan1 run mca analysis 0:no,1:elas,2:cc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_dropbad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># should scan1 drop invalid steady states (rare)?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_nan_on_bad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># invalid steady states are returned as NaN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mesg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># print out progress messages for large (&gt;20) scans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scan_errors_par__</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># collect errors, parameters values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scan_errors_idx__</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># collect errors, indexes</span></div>


<div class="viewcode-block" id="PysMod.InitialiseConservationArrays"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseConservationArrays">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseConservationArrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialise conservation related vectors/array was in InitialiseModel but has been</span>
<span class="sd">        moved out so is can be called by when the stoichiometry is reanalysed</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Init and Sx vectors # these vectors are multiplying all by themselves - brett</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_max_step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#max corrector steps</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># reorder the conservation matrix so that it is compatible with L</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix_col</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix_col</span><span class="p">))]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__reordered_lcons</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__Build_Tvec__</span><span class="p">(</span><span class="n">amounts</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__Build_Tvec__</span><span class="p">(</span><span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showConserved</span><span class="p">(</span><span class="n">screenwrite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.InitialiseOldFunctions"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.InitialiseOldFunctions">[docs]</a>    <span class="k">def</span> <span class="nf">InitialiseOldFunctions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        InitialiseOldFunctions()</span>

<span class="sd">        Parse and initialise user defined functions specified by !T !U in the PSC input file</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__CODE_user</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Function_user</span><span class="p">,</span><span class="s1">&#39;_Function_user&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_user</span><span class="p">)</span>
            <span class="c1">#print &#39;done.&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: User function error</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This might be due to non-instantiated (e.g. MCA/state) attributes&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Make sure the attributes that are used in your function exist ...&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;and manually load using the self.ReloadUserFunc() method&#39;</span><span class="p">)</span>

        <span class="c1">#print &#39;\nInitializing init function ...&#39;</span>
        <span class="c1">#print self._Function_init</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ReloadInitFunc</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: Init function error</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This function is meant to be used exclusively for the initialization&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;of PySCeS properties and expressions based on model attributes defined in the input file.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reinitialize with ReloadInitFunc()&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.ReloadUserFunc"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.ReloadUserFunc">[docs]</a>    <span class="k">def</span> <span class="nf">ReloadUserFunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ReloadUserFunc()</span>

<span class="sd">        Recompile and execute the user function (!U) from the input file.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">##  print &quot;User functions disabled ...&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__CODE_user</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Function_user</span><span class="p">,</span><span class="s1">&#39;_Function_user&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_user</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: User function load error</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.ReloadInitFunc"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.ReloadInitFunc">[docs]</a>    <span class="k">def</span> <span class="nf">ReloadInitFunc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ReloadInitFunc()</span>

<span class="sd">        Recompile and execute the user initialisations (!I) as defined in the PSC input file.</span>
<span class="sd">        and in mod.__InitFuncs__.</span>

<span class="sd">        UPDATE 2015: can now be used to define InitialAssignments (no need for self.* prefix in input file)</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">topolgical_sort</span><span class="p">(</span><span class="n">graph_unsorted</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Repeatedly go through all of the nodes in the graph, moving each of</span>
<span class="sd">            the nodes that has all its edges resolved, onto a sequence that</span>
<span class="sd">            forms our sorted graph. A node has all of its edges resolved and</span>
<span class="sd">            can be moved once all the nodes its edges point to, have been moved</span>
<span class="sd">            from the unsorted graph onto the sorted one.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># This is the list we&#39;ll return, that stores each node/edges pair</span>
            <span class="c1"># in topological order.</span>
            <span class="n">graph_sorted</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Convert the unsorted graph into a hash table. This gives us</span>
            <span class="c1"># constant-time lookup for checking if edges are unresolved, and</span>
            <span class="c1"># for removing nodes from the unsorted graph.</span>
            <span class="n">graph_unsorted</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">graph_unsorted</span><span class="p">)</span>

            <span class="c1"># Run until the unsorted graph is empty.</span>
            <span class="k">while</span> <span class="n">graph_unsorted</span><span class="p">:</span>

                <span class="c1"># Go through each of the node/edges pairs in the unsorted</span>
                <span class="c1"># graph. If a set of edges doesn&#39;t contain any nodes that</span>
                <span class="c1"># haven&#39;t been resolved, that is, that are still in the</span>
                <span class="c1"># unsorted graph, remove the pair from the unsorted graph,</span>
                <span class="c1"># and append it to the sorted graph. Note here that by using</span>
                <span class="c1"># using the items() method for iterating, a copy of the</span>
                <span class="c1"># unsorted graph is used, allowing us to modify the unsorted</span>
                <span class="c1"># graph as we move through it. We also keep a flag for</span>
                <span class="c1"># checking that that graph is acyclic, which is true if any</span>
                <span class="c1"># nodes are resolved during each pass through the graph. If</span>
                <span class="c1"># not, we need to bail out as the graph therefore can&#39;t be</span>
                <span class="c1"># sorted.</span>
                <span class="n">acyclic</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">edges</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph_unsorted</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">graph_unsorted</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">acyclic</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">del</span> <span class="n">graph_unsorted</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
                        <span class="n">graph_sorted</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">edges</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">acyclic</span><span class="p">:</span>
                    <span class="c1"># Uh oh, we&#39;ve passed through all the unsorted nodes and</span>
                    <span class="c1"># weren&#39;t able to resolve any of them, which means there</span>
                    <span class="c1"># are nodes with cyclic edges that will never be resolved,</span>
                    <span class="c1"># so we bail out with an error.</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;A cyclic dependency occurred&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">graph_sorted</span>

        <span class="n">simpleAss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exprsAss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">symbolsX</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">init</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__InitFuncs__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">):</span>
                <span class="c1">#TODO: to be continued by brett</span>
                <span class="c1">#print(init, self.__InitFuncs__[init])</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__InitFuncs__</span><span class="p">[</span><span class="n">init</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__InitFuncs__</span><span class="p">[</span><span class="n">init</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="c1">#self.__InitFuncs__[init] = eval(self.__InitFuncs__[init])</span>
                        <span class="c1">#setattr(self, init, self.__InitFuncs__[init])</span>
                        <span class="c1">#self.__InitFuncs__[init] = compile(self.__InitFuncs__[init], &#39;_InitFunc_&#39;, &#39;single&#39;)</span>
                        <span class="n">simpleAss</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">init</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__InitFuncs__</span><span class="p">[</span><span class="n">init</span><span class="p">])))</span>
                        <span class="c1">#setattr(self, init, eval(self.__InitFuncs__[init]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="c1">#InfixParser.SymbolReplacements = {&#39;_TIME_&#39;:&#39;mod._TIME_&#39;}</span>
                        <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__InitFuncs__</span><span class="p">[</span><span class="n">init</span><span class="p">]))</span>
                        <span class="n">piecewises</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">piecewises</span>
                        <span class="n">symbols</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">names</span>
                        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symbolsX</span><span class="p">:</span>
                                <span class="n">symbolsX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">init</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symbolsX</span><span class="p">:</span>
                            <span class="n">symbolsX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
                        <span class="n">functions</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">functions</span>
                        <span class="n">code_string</span> <span class="o">=</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                        <span class="n">xcode</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">code_string</span><span class="p">,</span> <span class="s1">&#39;_InitAss_&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
                        <span class="n">exprsAss</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">init</span><span class="p">,</span> <span class="n">xcode</span><span class="p">,</span> <span class="n">symbols</span><span class="p">))</span>
                        <span class="c1">#setattr(self, init, eval(xcode))</span>
                    <span class="c1">#else:</span>
                        <span class="c1">##setattr(self, init, self.__InitFuncs__[init])</span>
                        <span class="c1">#self.__InitFuncs__[init] = compile(self.__InitFuncs__[init], &#39;_InitFunc_&#39;, &#39;single&#39;)</span>
                        <span class="c1">#setattr(self, init, eval(self.__InitFuncs__[init]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__InitFuncs__</span><span class="p">[</span><span class="n">init</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ModelInit error&#39;</span>
        <span class="c1">#TODO: to be continued by brett</span>
        <span class="c1">#print(&#39;symbolsX&#39;, symbolsX)</span>
        <span class="k">for</span> <span class="n">init</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">simpleAss</span><span class="p">:</span>
            <span class="c1">#print(&#39;s&#39;, init,val)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="n">execOrder</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">init</span><span class="p">,</span> <span class="n">xcode</span><span class="p">,</span> <span class="n">symbols2</span> <span class="ow">in</span> <span class="n">exprsAss</span><span class="p">:</span>
            <span class="n">symbols2</span> <span class="o">=</span> <span class="p">[</span><span class="n">symbolsX</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span> <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">symbols2</span><span class="p">]</span>
            <span class="n">execOrder</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">symbolsX</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">init</span><span class="p">),</span> <span class="n">symbols2</span><span class="p">))</span>
            <span class="c1">#TODO: to be continued by brett</span>
            <span class="c1">#print(&#39;x&#39;, symbols2)</span>
            <span class="c1">#print(&#39;e&#39;, init,code_string)</span>
            <span class="nb">eval</span><span class="p">(</span><span class="n">xcode</span><span class="p">)</span></div>
        <span class="c1">#TODO: to be continued by brett</span>
        <span class="c1">#print(execOrder)</span>
        <span class="c1">#print(topolgical_sort(execOrder))</span>
        <span class="c1">#print(symbolsX)</span>

    <span class="k">def</span> <span class="nf">__initREQ__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __initREQ__()</span>

<span class="sd">        Compile and initialise the model rate equations and associated arrays. Rate equations are</span>
<span class="sd">        generated as lambda functions callable as mod.R1(mod)</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create work arrays for Reactions and variable species</span>
        <span class="c1"># s = numpy.zeros(len(self.__species__),&#39;d&#39;)</span>
        <span class="c1"># self.Vtemp = numpy.zeros(len(self.__reactions__),&#39;d&#39;)</span>
        <span class="c1"># This appears to be redundant leftover code - brett 20031215</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1">#print &#39;Vtemp&#39;</span>

        <span class="c1"># create the map string by taking the VarReagent[] and assigning it to an s[index]</span>
        <span class="c1"># a reverse map function mapping self.sXi back to self.init[x] for simulation initiation</span>
        <span class="n">mapString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">mapString_R</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)):</span>
            <span class="n">mapString</span> <span class="o">+=</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1"> = s[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">mapString_R</span> <span class="o">+=</span> <span class="s1">&#39;self.__inspec__[</span><span class="si">%s</span><span class="s1">] = self.</span><span class="si">%s</span><span class="s1">_init</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="c1">##  print mapString_R</span>
            <span class="c1"># this creates the mapping string for the derivative functions</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mapString&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mapString</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mapString_R&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mapString_R</span><span class="p">)</span>

        <span class="c1"># create the REq string in ReactionIDs order as a single multiline definition</span>
        <span class="c1"># using indexes: vString (Vtemp[x] =)</span>
        <span class="c1"># or a list of individual compile definitions: vArray (v + ReactionID = )</span>
        <span class="n">vString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="c1">##  vString2 = &#39;&#39;</span>
        <span class="c1">##  DvOrder = []</span>
        <span class="n">EStat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">##  dispREq = &#39;&#39;</span>

        <span class="n">symbR</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_substitute_assignment_rules&#39;</span><span class="p">]:</span>
            <span class="c1"># create substitution dictionary</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">:</span>
                <span class="n">symbR</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;code_string&#39;</span><span class="p">]})</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)):</span>
            <span class="n">req1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]][</span><span class="s1">&#39;RateEq&#39;</span><span class="p">]</span>
            <span class="c1">##  DvOrder.append(self.__reactions__[x])</span>
            <span class="n">vString</span> <span class="o">+=</span> <span class="s1">&#39;Vtemp[</span><span class="si">%s</span><span class="s1">] = self.</span><span class="si">%s</span><span class="s1">()</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

            <span class="c1"># Core update inspired by Core2, lambda functions replaced by Reaction instances</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_substitute_assignment_rules&#39;</span><span class="p">]:</span>
                <span class="c1"># substitute assignment rules</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">setNameStr</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">FunctionReplacements</span> <span class="o">=</span> <span class="n">symbR</span>
                <span class="n">InfixParser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">req1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="n">req2</span> <span class="o">=</span> <span class="n">InfixParser</span><span class="o">.</span><span class="n">output</span>
                <span class="c1">##  req1_names = InfixParser.names</span>
                <span class="n">rObj</span> <span class="o">=</span> <span class="n">ReactionObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">req2</span><span class="p">,</span> <span class="s1">&#39;self.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rObj</span> <span class="o">=</span> <span class="n">ReactionObj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">req1</span><span class="p">,</span> <span class="s1">&#39;self.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__ParsePiecewiseFunctions__</span><span class="p">(</span><span class="n">rObj</span><span class="o">.</span><span class="n">piecewises</span><span class="p">)</span>
            <span class="n">rObj</span><span class="o">.</span><span class="n">compartment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">rObj</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">rObj</span><span class="p">)</span>

        <span class="c1"># this is to check that if a model defines compartments then REq&#39;s MUST be in amounts brett2008</span>
        <span class="c1"># brett2008</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span><span class="p">:</span>
            <span class="n">cnames</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compartments__</span><span class="p">]</span>
            <span class="n">warnings</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">:</span>
                <span class="n">rrobj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rr</span><span class="p">)</span>
                <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">rrobj</span><span class="o">.</span><span class="n">compartment</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_compartment_warnings&#39;</span><span class="p">]:</span>
                    <span class="n">warnings</span> <span class="o">+=</span> <span class="s2">&quot;# </span><span class="si">%s</span><span class="s2"> is not located in a compartment.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">rrobj</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">cnames</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">rrobj</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span>
                            <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                        <span class="n">warnings</span> <span class="o">+=</span> <span class="s2">&quot;# </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">#  assuming kinetic constants are flow constants.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">rrobj</span><span class="o">.</span><span class="n">formula</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">warnings</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_compartment_warnings&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># -- COMPARTMENT WARNINGS --&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">warnings</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;vString&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">vString</span><span class="p">)</span>
            <span class="c1">##  print &#39;vString2&#39;</span>
            <span class="c1">##  print vString2</span>
            <span class="c1">##  print &#39;DvOrder&#39;</span>
            <span class="c1">##  print DvOrder</span>
        <span class="k">return</span> <span class="n">mapString</span><span class="p">,</span><span class="n">mapString_R</span><span class="p">,</span><span class="n">vString</span>

    <span class="k">def</span> <span class="nf">__initmodel__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __initmodel__()</span>

<span class="sd">        Generate the stoichiometric matrix N from the parsed model description.</span>
<span class="sd">        Returns a stoichiometric matrix (N)</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">VarReagents</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;self.&#39;</span><span class="o">+</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">]</span>
        <span class="n">StoicMatrix</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">VarReagents</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reag</span> <span class="ow">in</span> <span class="n">VarReagents</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">reag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">StoicMatrix</span><span class="p">[</span><span class="n">VarReagents</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">reag</span><span class="p">)][</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">id</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="nb">id</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">][</span><span class="n">reag</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">StoicMatrix</span>

    <span class="k">def</span> <span class="nf">__initvar__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __initvar__()</span>

<span class="sd">        Compile and initialise the model variable species and derivatives and associated mapping arrays.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mvarString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">sOrder</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__remaps</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">DvarUpString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="c1">#self.__inspec__ = numpy.zeros((len(self.__species__)),&#39;d&#39;) moved to ParseModel</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="c1">##  self.__inspec__[x] = eval(key)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">mvarString</span> <span class="o">+=</span> <span class="s1">&#39;self.__inspec__[</span><span class="si">%s</span><span class="s1">] = float(self.</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__remaps</span> <span class="o">+=</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1"> = self.</span><span class="si">%s</span><span class="s1">_ss</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">sOrder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">)</span>
            <span class="n">DvarUpString</span> <span class="o">+=</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1"> = input[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;s_initDeriv&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s_initDeriv</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">__remaps&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__remaps</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">DvarUpString&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">DvarUpString</span><span class="p">)</span>

        <span class="n">mvarFunc</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">mvarString</span><span class="p">,</span><span class="s1">&#39;mvarString&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sOrder</span><span class="p">,</span><span class="n">DvarUpString</span>

    <span class="k">def</span> <span class="nf">__initfixed__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __initfixed__()</span>

<span class="sd">        Compile and initialise the fixed species and associated mapping arrays</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">runmapString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;InitParams2&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;InitStrings2&#39;</span><span class="p">)</span>
            <span class="c1">##  print self.__InitStrings</span>

        <span class="c1"># Initialise parameter elasticities</span>
        <span class="n">par_map2store</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">par_remap</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)):</span>
            <span class="n">par_map2store</span> <span class="o">+=</span> <span class="s1">&#39;parVal_hold[</span><span class="si">%s</span><span class="s1">] = self.</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="n">par_remap</span> <span class="o">+=</span> <span class="s1">&#39;self.</span><span class="si">%s</span><span class="s1"> = parVal_hold[</span><span class="si">%s</span><span class="s1">]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;par_map2store&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">par_map2store</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;par_remap&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">par_remap</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">par_map2store</span><span class="p">,</span><span class="n">par_remap</span><span class="p">)</span>

<span class="c1">#pysces core - the steady-state solver and integration routines</span>
    <span class="k">def</span> <span class="nf">_SpeciesAmountToConc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;takes and returns s&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="c1">##  print &#39;__CALL__&#39;, self.__CsizeAll__</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span>

    <span class="k">def</span> <span class="nf">_SpeciesConcToAmount</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;takes and returns s&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
        <span class="c1">##  print &#39;__CALL__&#39;, self.__CsizeAll__</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span>

    <span class="k">def</span> <span class="nf">_FixedSpeciesAmountToConc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">)):</span>
            <span class="n">am</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeFS__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeFSIdx__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">am</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeFS__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_FixedSpeciesConcToAmount</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">)):</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeFS__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeFSIdx__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cn</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeFS__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

    <span class="c1"># extract SI and &quot;correct&quot; SD in s solve for v</span>
    <span class="c1"># Vtemp is passed through the function to avoid an irritating bug</span>
    <span class="c1"># that appears if it isn&#39;t (ie defined as a global) - brett</span>
    <span class="k">def</span> <span class="nf">_EvalREq2_alt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _EvalREq2_alt(s,Vtemp)</span>

<span class="sd">        Evaluate the rate equations correcting for mass conservation.</span>
<span class="sd">        Takes full [s] returns full [s] --&gt; moiety aware</span>

<span class="sd">        Arguments:</span>

<span class="sd">        s: a vector of species cosnservations</span>
<span class="sd">        Vtemp: the rate vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#form an SI vector</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

        <span class="c1">#replace SD with SI calculated values</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">)):</span>
            <span class="n">s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_EvalREq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapFunc__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Forcing_Function</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">de</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: forcing function failure&#39;</span><span class="p">,</span> <span class="n">de</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__vFunc__</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ArithmeticError</span><span class="p">,</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">NameError</span><span class="p">,</span><span class="ne">ZeroDivisionError</span><span class="p">,</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: REq evaluation failure:&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span>
            <span class="n">Vtemp</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ArithmeticError</span><span class="p">,</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">NameError</span><span class="p">,</span><span class="ne">ZeroDivisionError</span><span class="p">,</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">detail</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: RateRule evaluation failure:&#39;</span><span class="p">,</span> <span class="n">detail</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Vtemp</span>

    <span class="k">def</span> <span class="nf">_EvalREq2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _EvalREq2(s,Vtemp)</span>

<span class="sd">        Evaluate the rate equations, as PySCeS uses the reduced set of ODE&#39;s for its core operations, this method</span>
<span class="sd">        takes mass conservation into account and regenerates the full species vector</span>
<span class="sd">        takes [si] returns full [s]</span>

<span class="sd">        Arguments:</span>

<span class="sd">        s: species vector</span>
<span class="sd">        Vtemp: rate vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#stick SI into s using Nrrow order</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="c1">#stick SD into s using lzerorow order</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_EvalODE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _EvalODE(s,Vtemp)</span>

<span class="sd">        Core ODE evaluation routine evaluating the reduced set of ODE&#39;s. Depending on whether mass conservation is present or not either N*v (_EvalREq) or Nr*v (_EvalREq2) is used to automatically generate the ODE&#39;s.</span>
<span class="sd">        Returns sdot.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        s: species vector</span>
<span class="sd">        Vtemp: rate vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span><span class="o">*</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="c1"># the following are user functions defined in the input file or assigned after instantiated</span>
    <span class="k">def</span> <span class="nf">_EvalODE_CVODE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        _EvalODE_CVODE(s,Vtemp)</span>

<span class="sd">        Evaluate the full set of ODE&#39;s. Depending on whether mass conservation is present or not</span>
<span class="sd">        either N*v (_EvalREq) or Nr*v (_EvalREq2_alt) is used.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        s: species vector</span>
<span class="sd">        Vtemp: rate vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">s</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span>

<div class="viewcode-block" id="PysMod.Forcing_Function"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Forcing_Function">[docs]</a>    <span class="k">def</span> <span class="nf">Forcing_Function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Forcing_Function()</span>

<span class="sd">        User defined forcing function either defined in the PSC input file as !F or by overwriting this method.</span>
<span class="sd">        This method is evaluated prior to every rate equation evaluation.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialized in __initFunction__() - brett 20050621</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_forced</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.User_Function"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.User_Function">[docs]</a>    <span class="k">def</span> <span class="nf">User_Function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Deprecated**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_user</span><span class="p">)</span></div>

    <span class="c1"># pysundials</span>

    <span class="k">def</span> <span class="nf">_EvalExtraData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Takes a list of model attributes and returns an array of values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">xdata</span><span class="p">])</span>

    <span class="n">__CVODE_initialise__</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">CVODE_continuous_result</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">__CVODE_initial_num__</span> <span class="o">=</span> <span class="kc">None</span>
<div class="viewcode-block" id="PysMod.CVODE_continue"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.CVODE_continue">[docs]</a>    <span class="k">def</span> <span class="nf">CVODE_continue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tvec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Experimental:** continues a simulation over a new time vector, the</span>
<span class="sd">        CVODE memobj is reused and not reinitialised and model parameters can be</span>
<span class="sd">        changed between calls to this method. The mod.data_sim objects from</span>
<span class="sd">        the initial simulation and all calls to this method are stored in the list</span>
<span class="sd">        *mod.CVODE_continuous_result*.</span>

<span class="sd">         - *tvec* a numpy array of time points</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span> <span class="o">==</span> <span class="s1">&#39;CVODE&#39;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">For what should be rather obvious reasons, this method requires CVODE to be used as the default integration algorithm.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_continuous_result</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_continuous_result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initialise__</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="n">tvec</span>

        <span class="n">Tsim0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">sim_res</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">simOK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CVODE</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">Tsim1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> time for </span><span class="si">%s</span><span class="s2"> points: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">),</span> <span class="n">Tsim1</span><span class="o">-</span><span class="n">Tsim0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">sim_res</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sim_res</span><span class="p">,[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RateRules evaluated and added to mod.data_sim.&#39;</span><span class="p">)</span>

        <span class="c1"># TODO: split this off into a method shared by this and Simulate()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span> <span class="o">=</span> <span class="n">IntegrationDataObj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IS_VALID</span> <span class="o">=</span> <span class="n">simOK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setSpecies</span><span class="p">(</span><span class="n">sim_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setRates</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setRules</span><span class="p">(</span><span class="n">rrules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setXData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">simOK</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation failure&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">sim_res</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_continuous_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initialise__</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PysMod.CVODE"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.CVODE">[docs]</a>    <span class="k">def</span> <span class="nf">CVODE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CVODE(initial)</span>

<span class="sd">        PySCeS interface to the CVODE integration algorithm.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        initial: vector containing initial species concentrations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">_HAVE_PYSUNDIALS</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">PySundials is not installed or did not import correctly</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_PYSUNDIALS_LOAD_ERROR</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">def</span> <span class="nf">findi</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ydot</span><span class="p">,</span> <span class="n">f_data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">ydota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">Vtemp</span><span class="p">)</span>
            <span class="n">ydot</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ydota</span><span class="p">[:]</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="c1">#non-zero return indicates error state</span>

        <span class="k">def</span> <span class="nf">ffull</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ydot</span><span class="p">,</span> <span class="n">f_data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="n">t</span>
            <span class="c1">##  ya = numpy.array(y)</span>
            <span class="n">ydota</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE_CVODE</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">Vtemp</span><span class="p">)</span> <span class="c1"># unreduced ODE&#39;s</span>
            <span class="n">ydot</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ydota</span><span class="p">[:]</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">ffull</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">findi</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initialise__</span><span class="p">:</span>
            <span class="n">tZero</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                <span class="n">initial</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">initial</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                <span class="n">tZero</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span><span class="p">:</span>
                <span class="n">initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tZero</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span><span class="p">:</span>
                <span class="n">tZero</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">tZero</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                <span class="n">initial</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">initial</span><span class="p">,</span> <span class="n">rrules</span><span class="p">])</span>
                <span class="n">tZero</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">tZero</span><span class="p">,</span> <span class="n">rrules</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tZero</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#the following block initialises the cvode integrator, and sets various options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initialise__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">NVector</span><span class="p">(</span><span class="n">initial</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeCreate</span><span class="p">(</span><span class="n">cvode</span><span class="o">.</span><span class="n">CV_BDF</span><span class="p">,</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_NEWTON</span><span class="p">)</span> <span class="c1">#initialisation with basic options, newtonian solver etc...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initial_num__</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">initial</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">realtype</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">rates</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)))</span>
        <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)))</span>

        <span class="n">CVODE_XOUT</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: CVODE is ignoring extra data (</span><span class="si">%s</span><span class="s1">), it either doesn</span><span class="se">\&#39;</span><span class="s1">t exist or it</span><span class="se">\&#39;</span><span class="s1">s a species or rate.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">CVODE_XOUT</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">del</span> <span class="n">out</span>

        <span class="k">if</span> <span class="n">CVODE_XOUT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)))</span>

        <span class="n">sim_st</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initialise__</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">tZero</span><span class="p">[:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">[:])</span>

            <span class="k">if</span> <span class="n">CVODE_XOUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalExtraData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span>
            <span class="n">sim_st</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">del</span> <span class="n">tZero</span>

        <span class="n">var_store</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_EVENTS__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">:</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                    <span class="n">var_store</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">ass</span><span class="o">.</span><span class="n">variable</span> <span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span><span class="p">)})</span>
        <span class="n">TOL_ADJUSTER</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">MAX_TOL_CNT</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">MAX_REL_TOLERANCE</span> <span class="o">=</span> <span class="mf">1.0e-3</span>
        <span class="n">RELTOL_ADJUST_FACTOR</span> <span class="o">=</span> <span class="mf">1.0e3</span>
        <span class="n">MIN_ABS_TOL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_abstol&quot;</span><span class="p">]</span> <span class="c1"># 1.0e-15</span>
        <span class="c1">##  MAX_ABS_TOL = self.__settings__[&quot;cvode_abstol_max&quot;] #1.0e-3 not used anymore</span>
        <span class="n">ABSTOL_ADJUST_FACTOR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_abstol_factor&quot;</span><span class="p">]</span> <span class="c1"># 1.0e-6</span>
        <span class="n">cvode_sim_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sim_st</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">)))</span>
        <span class="n">cvode_scale_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">sim_st</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">)))</span>
        <span class="n">cvode_scale_range</span> <span class="o">=</span> <span class="n">cvode_scale_range</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">reltol</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">realtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_reltol&quot;</span><span class="p">])</span> <span class="c1">#relative tolerance must be a realtype</span>
        <span class="n">abstol</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">NVector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initial_num__</span><span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_abstol&quot;</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">)):</span>
            <span class="n">newVal</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">*</span><span class="n">ABSTOL_ADJUST_FACTOR</span>
            <span class="k">if</span> <span class="n">newVal</span> <span class="o">&lt;</span> <span class="n">MIN_ABS_TOL</span><span class="p">:</span>
                <span class="n">abstol</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIN_ABS_TOL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">abstol</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">newVal</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initialise__</span><span class="p">:</span>
            <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeMalloc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">,</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_SV</span><span class="p">,</span> <span class="n">reltol</span><span class="p">,</span> <span class="n">abstol</span><span class="p">)</span> <span class="c1">#set tolerances, specify vector of initial conditions, set integrtion function etc...</span>
            <span class="n">cvode</span><span class="o">.</span><span class="n">CVDense</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_initial_num__</span><span class="p">)</span> <span class="c1">#set dense option, specify dimension of problem (3)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_EVENTS__</span><span class="p">:</span>
            <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeRootInit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_EVENTS</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1">#specify to &#39;root&#39; conditions, and function that calculates them</span>


        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">cvode_sim_range</span><span class="p">:</span>
            <span class="n">tout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">[</span><span class="n">st</span><span class="p">]</span>
            <span class="n">errcount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">##  print TOL_ADJUSTER, MAX_TOL_CNT, abstol, MAX_REL_TOLERANCE</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_auto_tol_adjust&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">TOL_ADJUSTER</span> <span class="o">&gt;=</span> <span class="n">MAX_TOL_CNT</span> <span class="ow">and</span> <span class="n">reltol</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">MAX_REL_TOLERANCE</span><span class="p">:</span>
                <span class="n">reltol</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">reltol</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">RELTOL_ADJUST_FACTOR</span>
                <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeSetTolerances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_SV</span><span class="p">,</span> <span class="n">reltol</span><span class="p">,</span> <span class="n">abstol</span><span class="p">)</span>
                <span class="c1">##  print &#39;\nCVODE: new tolerance set:\nreltol=%s&#39; % reltol.value</span>
                <span class="c1">##  print &#39;\nAbs tolerance:\n%s&#39; % abstol</span>
                <span class="n">TOL_ADJUSTER</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="ow">in</span> <span class="n">cvode_scale_range</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_auto_tol_adjust&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">)):</span>
                    <span class="n">newVal</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">[</span><span class="n">s</span><span class="p">])</span><span class="o">*</span><span class="n">ABSTOL_ADJUST_FACTOR</span>
                    <span class="k">if</span> <span class="n">newVal</span> <span class="o">&lt;</span> <span class="n">MIN_ABS_TOL</span><span class="p">:</span>
                        <span class="n">abstol</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIN_ABS_TOL</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">abstol</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">newVal</span>
                <span class="c1">##  print &#39;\nCVODE: new tolerance set, abstol:\n%s&#39; % abstol</span>
                <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeSetTolerances</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_SV</span><span class="p">,</span> <span class="n">reltol</span><span class="p">,</span> <span class="n">abstol</span><span class="p">)</span>
                <span class="c1">##  cvode.CVodeReInit(self.__CVODE_mem__, func, self.sim_time[st-1], self.__CVODE_y__, cvode.CV_SV, reltol, abstol)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="n">tout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">,</span> <span class="n">cvode</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_NORMAL</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">AssertionError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cvode error1&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="n">tout</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_ROOT_RETURN</span><span class="p">:</span> <span class="c1">#if a root was found before desired time point, output it</span>
                    <span class="n">ya</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">)</span>
                    <span class="n">rootsfound</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetRootInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">))</span>
                    <span class="n">reInit</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">rootsfound</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span><span class="o">.</span><span class="n">assignments</span><span class="p">:</span>
                                <span class="c1"># only can assign to independent species vector</span>
                                <span class="k">if</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L0matrix</span><span class="o">.</span><span class="n">getLabels</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span>\
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span> <span class="ow">and</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">):</span>
                                    <span class="n">assVal</span> <span class="o">=</span> <span class="n">ass</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
                                    <span class="n">assIdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ass</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
                                        <span class="c1">##  print self.__CVODE_y__</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">[</span><span class="n">assIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">assVal</span><span class="o">*</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">[</span><span class="n">assIdx</span><span class="p">])</span>
                                        <span class="c1">##  raw_input(self.__CVODE_y__)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">[</span><span class="n">assIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">assVal</span>
                                    <span class="n">reInit</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span> <span class="ow">and</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">L0matrix</span><span class="o">.</span><span class="n">getLabels</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Event assignment to dependent species consider setting </span><span class="se">\&quot;</span><span class="s1">mod.mode_integrate_all_odes = True</span><span class="se">\&quot;</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span> <span class="ow">and</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">:</span>
                                    <span class="c1">##  print &#39;Event is assigning to rate rule&#39;</span>
                                    <span class="n">assVal</span> <span class="o">=</span> <span class="n">ass</span><span class="o">.</span><span class="n">getValue</span><span class="p">()</span>
                                    <span class="n">rrIdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ass</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>
                                    <span class="c1">##  print ass.variable, assVal</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">[</span><span class="n">rrIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">assVal</span>
                                    <span class="c1">##  print self.L0matrix.shape[1], rrIdx, len(self.__CVODE_y__)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">L0matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">rrIdx</span><span class="p">]</span> <span class="o">=</span> <span class="n">assVal</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="n">assVal</span><span class="p">)</span>
                                    <span class="n">reInit</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span><span class="p">,</span> <span class="n">ass</span><span class="o">.</span><span class="n">getValue</span><span class="p">())</span>
                                        <span class="n">reInit</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: Updating model attribute from event: &#39;</span><span class="p">,</span> <span class="n">ass</span><span class="o">.</span><span class="n">variable</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">reInit</span><span class="p">:</span>
                        <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeReInit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">tout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">,</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_SV</span><span class="p">,</span> <span class="n">reltol</span><span class="p">,</span> <span class="n">abstol</span><span class="p">)</span>

                    <span class="c1"># this gets everything into the current tout state</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">ya</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE_CVODE</span><span class="p">(</span><span class="n">ya</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">tmp</span>

                    <span class="c1"># here we regenerate Sd&#39;s and fix concentrations</span>
                    <span class="n">rrules</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ya</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">ya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">ya</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># convert to concentrations</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">ya</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ya</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">ya</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span><span class="p">])</span>

                    <span class="n">output</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">ya</span>
                    <span class="c1"># set with self._EvalODE above</span>
                    <span class="n">rates</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span>

                    <span class="k">if</span> <span class="n">CVODE_XOUT</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span><span class="p">[</span><span class="n">st</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalExtraData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span>
                    <span class="c1"># this should adjust the expected time to the new output time time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tout</span><span class="p">)</span>
                    <span class="c1"># dont need anymore i think</span>
                    <span class="k">if</span> <span class="n">_HAVE_VPYTHON</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_VPYTHON</span><span class="p">(</span><span class="n">ya</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_SUCCESS</span><span class="p">:</span>
                    <span class="n">ya</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_y__</span><span class="p">)</span>
                    <span class="c1"># this gets everything into the current tout state</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">ya</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE_CVODE</span><span class="p">(</span><span class="n">ya</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">tmp</span>
                    <span class="c1"># here we regenerate Sd&#39;s and fix concentrations</span>
                    <span class="n">rrules</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ya</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="n">ya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">ya</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="c1"># convert to concentrations</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">ya</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ya</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">ya</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                            <span class="n">ya</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span><span class="p">])</span>

                    <span class="n">output</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">ya</span>
                    <span class="c1"># set with self._EvalODE above</span>
                    <span class="n">rates</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span>

                    <span class="k">if</span> <span class="n">CVODE_XOUT</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span><span class="p">[</span><span class="n">st</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalExtraData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_HAVE_VPYTHON</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_VPYTHON</span><span class="p">(</span><span class="n">ya</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">ya</span><span class="p">,</span> <span class="n">rrules</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="n">flag</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span>
                        <span class="n">TOL_ADJUSTER</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3000</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10000</span>
                        <span class="n">TOL_ADJUSTER</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10000</span><span class="p">:</span>
                        <span class="c1">##  TOL_ADJUSTER += 1</span>
                        <span class="n">output</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
                        <span class="k">break</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mxstep warning (</span><span class="si">%s</span><span class="s1">) mxstep set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]))</span>
                    <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeSetMaxNumSteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">flag</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CVODE error:&#39;</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;At &#39;</span><span class="p">,</span> <span class="n">tout</span><span class="p">)</span>
                    <span class="n">output</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="n">rates</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="k">if</span> <span class="n">CVODE_XOUT</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span><span class="p">[</span><span class="n">st</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeSetMaxNumSteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_mxstep&quot;</span><span class="p">])</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_EVENTS__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">var_store</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="c1">#print &#39;old value&#39;, ass, getattr(self, ass)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ass</span><span class="p">,</span> <span class="n">var_store</span><span class="p">[</span><span class="n">ass</span><span class="p">])</span>
                <span class="c1">#print &#39;new value&#39;, getattr(self, ass)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;cvode_stats&quot;</span><span class="p">]:</span>
            <span class="c1">#print some stats from the intgrator</span>
            <span class="n">nst</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetNumSteps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">nfe</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetNumRhsEvals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">nsetups</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetNumLinSolvSetups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">netf</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetNumErrTestFails</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">nni</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetNumNonlinSolvIters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">ncfn</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetNumNonlinSolvConvFails</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">nje</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVDenseGetNumJacEvals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">nfeLS</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVDenseGetNumRhsEvals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>
            <span class="n">nge</span> <span class="o">=</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CVodeGetNumGEvals</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_mem__</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Final Statistics:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nst = </span><span class="si">%-6i</span><span class="s2"> nfe  = </span><span class="si">%-6i</span><span class="s2"> nsetups = </span><span class="si">%-6i</span><span class="s2"> nfeLS = </span><span class="si">%-6i</span><span class="s2"> nje = </span><span class="si">%i</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nst</span><span class="p">,</span> <span class="n">nfe</span><span class="p">,</span> <span class="n">nsetups</span><span class="p">,</span> <span class="n">nfeLS</span><span class="p">,</span> <span class="n">nje</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nni = </span><span class="si">%-6ld</span><span class="s2"> ncfn = </span><span class="si">%-6ld</span><span class="s2"> netf = </span><span class="si">%-6ld</span><span class="s2"> nge = </span><span class="si">%ld</span><span class="se">\n</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nni</span><span class="p">,</span> <span class="n">ncfn</span><span class="p">,</span> <span class="n">netf</span><span class="p">,</span> <span class="n">nge</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reltol = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">reltol</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;abstol:</span><span class="se">\n</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">abstol</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cvode</span><span class="o">.</span><span class="n">CV_SUCCESS</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.CVODE_EVENTS"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.CVODE_EVENTS">[docs]</a>    <span class="k">def</span> <span class="nf">CVODE_EVENTS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">svec</span><span class="p">,</span> <span class="n">eout</span><span class="p">,</span> <span class="n">f_data</span><span class="p">):</span>
        <span class="n">svec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">svec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="n">t</span>
        <span class="n">rrules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrate_all_odes</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">svec</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE_CVODE</span><span class="p">(</span><span class="n">svec</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">tmp</span>
        <span class="n">eventFired</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__events__</span><span class="p">[</span><span class="n">ev</span><span class="p">](</span><span class="n">t</span><span class="p">):</span>
                <span class="n">eout</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">eventFired</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eout</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CODE_raterule</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="PysMod.CVODE_VPYTHON"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.CVODE_VPYTHON">[docs]</a>    <span class="k">def</span> <span class="nf">CVODE_VPYTHON</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Future VPython hook for CVODE&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="PysMod.LSODA"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.LSODA">[docs]</a>    <span class="k">def</span> <span class="nf">LSODA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">initial</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        LSODA(initial)</span>

<span class="sd">        PySCeS interface to the LSODA integration algorithm. Given a set of initial</span>
<span class="sd">        conditions LSODA returns an array of species concentrations and a status flag.</span>
<span class="sd">        LSODA controls are accessible as mod.lsoda_&lt;control&gt;</span>

<span class="sd">        Arguments:</span>

<span class="sd">        initial: vector containing initial species concentrations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">function_sim</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_TIME_</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>

        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">go</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">go</span><span class="p">:</span>
            <span class="n">sim_res</span><span class="p">,</span><span class="n">infodict</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">function_sim</span><span class="p">,</span><span class="n">initial</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">,</span>\
                                                           <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;lsoda_atol&#39;</span><span class="p">],</span>\
                                                           <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;lsoda_rtol&#39;</span><span class="p">],</span>\
                                                           <span class="n">mxstep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">],</span>\
                                                           <span class="n">h0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_h0&quot;</span><span class="p">],</span>\
                                                           <span class="n">hmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_hmax&quot;</span><span class="p">],</span>\
                                                           <span class="n">hmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_hmin&quot;</span><span class="p">],</span>\
                                                           <span class="n">mxordn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxordn&quot;</span><span class="p">],</span>\
                                                           <span class="n">mxords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxords&quot;</span><span class="p">],</span>\
                                                           <span class="n">printmessg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mesg&quot;</span><span class="p">],</span>\
                                                           <span class="n">full_output</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">infodict</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Integration successful.&#39;</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_max_iter&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Integration error</span><span class="se">\n\n</span><span class="s1">Setting self.__settings__[&quot;lsoda_mxstep&quot;] = 1000 and reSimulating ...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration error</span><span class="se">\n\n</span><span class="s1">Setting self.__settings__[&quot;lsoda_mxstep&quot;] = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; and reSimulating ...&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span>
                <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">status</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_max_iter&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">This simulation is going nowhere fast</span><span class="se">\n</span><span class="s1">Consider trying CVODE (mod.mode_integrator = </span><span class="se">\&#39;</span><span class="s1">CVODE</span><span class="se">\&#39;</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.__settings__[&quot;lsoda_mxstep&quot;] = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;__settings__[</span><span class="se">\&#39;</span><span class="s1">mode_sim_max_iter</span><span class="se">\&#39;</span><span class="s1">] = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">iter</span><span class="p">))</span>
                <span class="n">go</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">go</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxstep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">rates</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sim_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sim_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">sim_res</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CVODE_Vtemp</span><span class="p">)</span>
                <span class="c1"># set with self._EvalODE above</span>
                <span class="n">rates</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span>
            <span class="k">del</span> <span class="n">tmp</span>

            <span class="c1"># regenerate dependent variables</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                <span class="n">sim_res</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sim_res</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sim_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sim_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">sim_res</span><span class="p">[</span><span class="n">x</span><span class="p">,:],</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sim_res</span> <span class="o">=</span> <span class="n">res</span>
                <span class="k">del</span> <span class="n">res</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sim_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">sim_res</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">sim_res</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                <span class="n">sim_res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sim_res</span><span class="p">,</span> <span class="n">rrules</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">sim_res</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                <span class="n">sim_res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sim_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">sim_res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sim_res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">sim_res</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">NaN</span>
            <span class="k">return</span> <span class="n">sim_res</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.HYBRD"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.HYBRD">[docs]</a>    <span class="k">def</span> <span class="nf">HYBRD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">initial</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        HYBRD(initial)</span>

<span class="sd">        PySCeS interface to the HYBRD solver. Returns a steady-state solution and</span>
<span class="sd">        error flag. Good general purpose solver.</span>
<span class="sd">        Algorithm controls are available as mod.hybrd_&lt;control&gt;</span>

<span class="sd">        Arguments:</span>

<span class="sd">        initial: vector of initial species concentrations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">function_state</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>

        <span class="n">state_out</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">fsolve</span><span class="p">(</span><span class="n">function_state</span><span class="p">,</span><span class="n">initial</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(),</span>\
                                          <span class="n">xtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_xtol&#39;</span><span class="p">],</span>\
                                          <span class="n">maxfev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_maxfev&#39;</span><span class="p">],</span>\
                                          <span class="n">epsfcn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_epsfcn&#39;</span><span class="p">],</span>\
                                          <span class="n">factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_factor&#39;</span><span class="p">],</span>\
                                          <span class="n">col_deriv</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>\
                                          <span class="n">full_output</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state_out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_mesg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(hybrd)&#39;</span><span class="p">,</span> <span class="n">state_out</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">state_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_mesg&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: (hybrd) Invalid steady state:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_mesg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(hybrd)&#39;</span><span class="p">,</span> <span class="n">state_out</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">state_out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.FINTSLV"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.FINTSLV">[docs]</a>    <span class="k">def</span> <span class="nf">FINTSLV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">initial</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        FINTSLV(initial)</span>

<span class="sd">        Forward integration steady-state solver. Finds a steady state when the</span>
<span class="sd">        maximum change in species concentration falls within a specified tolerance.</span>
<span class="sd">        Returns the steady-state solution and a error flag.</span>
<span class="sd">        Algorithm controls are available as mod.fintslv_&lt;control&gt;</span>

<span class="sd">        Arguments:</span>

<span class="sd">        initial: vector of initial concentrations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fintslv_range__</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;fintslv_rmult&#39;</span><span class="p">]</span>
        <span class="c1">#print sim_time</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">function_sim</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>

        <span class="n">res</span><span class="p">,</span><span class="n">infodict</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">odeint</span><span class="p">(</span><span class="n">function_sim</span><span class="p">,</span><span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">sim_time</span><span class="p">,</span>\
                                                  <span class="n">atol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;lsoda_atol&#39;</span><span class="p">],</span>\
                                                  <span class="n">rtol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;lsoda_rtol&#39;</span><span class="p">],</span>\
                                                  <span class="c1">##  mxstep=self.__settings__[&quot;lsoda_mxstep&quot;],\</span>
                                                  <span class="n">mxstep</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>\
                                                  <span class="n">h0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_h0&quot;</span><span class="p">],</span>\
                                                  <span class="n">hmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_hmax&quot;</span><span class="p">],</span>\
                                                  <span class="n">hmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_hmin&quot;</span><span class="p">],</span>\
                                                  <span class="n">mxordn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxordn&quot;</span><span class="p">],</span>\
                                                  <span class="n">mxords</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mxords&quot;</span><span class="p">],</span>\
                                                  <span class="n">printmessg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mesg&quot;</span><span class="p">],</span>\
                                                  <span class="n">full_output</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">infodict</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Integration successful.&#39;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># run through results if max(abs([x]-[x-1])) &lt; self.__settings__[&#39;fintslv_tol&#39;] score +1</span>
        <span class="c1"># if you get 5 points by seq end ... happiness</span>
        <span class="n">OK</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">OK</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;fintslv_step&#39;</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">OK</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;fintslv_step&#39;</span><span class="p">]:</span>
                    <span class="n">dif</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;fintslv_tol&#39;</span><span class="p">]:</span>
                        <span class="n">OK</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="k">if</span> <span class="n">OK</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.NLEQ2"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.NLEQ2">[docs]</a>    <span class="k">def</span> <span class="nf">NLEQ2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">initial</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NLEQ2(initial)</span>

<span class="sd">        PySCeS interface to the (optional) NLEQ2 algorithm. This is a powerful steady-state</span>
<span class="sd">        solver that can usually find a solution for when HYBRD() fails. Algorithm</span>
<span class="sd">        controls are available as: mod.nleq2_&lt;control&gt;</span>
<span class="sd">        Returns as steady-state solution and error flag.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        initial: vector of initial species concentrations</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">initial0</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">s_scale</span> <span class="o">=</span> <span class="n">initial</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span>
        <span class="n">iwk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">+</span><span class="mi">52</span><span class="p">),</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">rwk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="n">N</span><span class="o">+</span><span class="nb">max</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">N</span> <span class="o">+</span> <span class="mi">61</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">50</span><span class="p">),</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_jacgen&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(nleq2)User supplied Jacobian not supported yet ... setting __settings__[</span><span class="se">\&#39;</span><span class="s1">nleq2_jacgen</span><span class="se">\&#39;</span><span class="s1">] = 0&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_jacgen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">rtol</span> <span class="o">=</span> <span class="n">mach_spec</span><span class="o">.</span><span class="n">eps</span><span class="o">*</span><span class="mf">10.0</span><span class="o">*</span><span class="n">N</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_jacgen&#39;</span><span class="p">]</span> <span class="c1">#2</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iscaln&#39;</span><span class="p">]</span>  <span class="c1">#0</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_nonlin&#39;</span><span class="p">]</span> <span class="c1">#4</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_qrank1&#39;</span><span class="p">]</span> <span class="c1">#1</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_qnscal&#39;</span><span class="p">]</span> <span class="c1">#0</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_ibdamp&#39;</span><span class="p">]</span> <span class="c1">#0</span>
        <span class="n">iopt</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iormon&#39;</span><span class="p">]</span> <span class="c1">#2</span>

        <span class="n">iwk</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nleq2_nitmax</span>

        <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ifail</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">ifail</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1.0e150</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">ifail</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">ifail</span>

        <span class="k">def</span> <span class="nf">jacfunc</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="n">ierr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">BRETT_DEBUG_MODE</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ADVANCED_MODE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_advanced_mode&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ADVANCED_MODE</span><span class="p">:</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iter&#39;</span><span class="p">]</span> <span class="c1"># 3</span>
            <span class="n">max_iter_ceiling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iter_max&#39;</span><span class="p">]</span> <span class="c1"># 10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_iter_ceiling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iter&#39;</span><span class="p">]</span>
            <span class="n">max_iter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_iter&#39;</span><span class="p">]</span>

        <span class="nb">iter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">GO</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">GO</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">BRETT_DEBUG_MODE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;s_scale&#39;</span><span class="p">,</span> <span class="n">s_scale</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ierr(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">ierr</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;rtol(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">rtol</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nitmax(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">iwk</span><span class="p">[</span><span class="mi">30</span><span class="p">]))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;s_scale(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">s_scale</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max_iter(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">iter</span><span class="p">,</span><span class="n">max_iter</span><span class="p">))</span>

            <span class="n">res</span><span class="p">,</span><span class="n">s_scale</span><span class="p">,</span><span class="n">rtol</span><span class="p">,</span><span class="n">iopt</span><span class="p">,</span><span class="n">ierr</span> <span class="o">=</span> <span class="n">nleq2</span><span class="o">.</span><span class="n">nleq2</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">jacfunc</span><span class="p">,</span><span class="n">initial</span><span class="p">,</span><span class="n">s_scale</span><span class="p">,</span><span class="n">rtol</span><span class="p">,</span><span class="n">iopt</span><span class="p">,</span><span class="n">iwk</span><span class="p">,</span><span class="n">rwk</span><span class="p">)</span>


            <span class="k">if</span> <span class="n">ierr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># success</span>
                <span class="n">GO</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">ierr</span> <span class="o">==</span> <span class="mi">21</span><span class="p">:</span>
                <span class="c1"># negative rtol</span>
                <span class="n">GO</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1">##  rtol = abs(rtol)</span>
                <span class="c1">##  ierr = 0</span>
            <span class="k">elif</span> <span class="n">ierr</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># nitmax reached</span>
                <span class="n">iwk</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwk</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_growth_factor&#39;</span><span class="p">]</span> <span class="c1"># 10</span>

            <span class="k">if</span> <span class="nb">iter</span> <span class="o">&gt;=</span> <span class="n">max_iter</span> <span class="ow">and</span> <span class="nb">iter</span> <span class="o">&gt;=</span> <span class="n">max_iter_ceiling</span><span class="p">:</span>
                <span class="n">GO</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="nb">iter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">BRETT_DEBUG_MODE</span> <span class="ow">and</span> <span class="n">ierr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ierr = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ierr</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ierr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_mesg&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(nleq2) exits with ierr = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ierr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_mesg&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;(nleq2) The solution converged.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ierr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PysMod.PITCON"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.PITCON">[docs]</a>    <span class="k">def</span> <span class="nf">PITCON</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scanpar</span><span class="p">,</span><span class="n">scanpar3d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PITCON(scanpar,scanpar3d=None)</span>

<span class="sd">        PySCeS interface to the PITCON continuation algorithm. Single parameter</span>
<span class="sd">        continuation has been implemented as a &quot;scan&quot; with the continuation</span>
<span class="sd">        being initialised in mod.pitcon_par_space. The second argument does not</span>
<span class="sd">        affect the continuation but can be used to insert a third axis parameter into</span>
<span class="sd">        the results. Returns an array containing the results.</span>
<span class="sd">        Algorithm controls are available as mod.pitcon_&lt;control&gt;</span>

<span class="sd">        Arguments:</span>

<span class="sd">        scanpar: the model parameter to scan (x5)</span>
<span class="sd">        scanpar3d [default=None]: additional output parameter for 3D plots</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Bifurcation analysis not currently available for models containing RateRules&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">scanpar</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">scanpar must be a &lt;string&gt; representing a model parameter&#39;</span>
        <span class="n">modpar</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">modpar</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">scanpar</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">scanpar</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; is not a parameter of this model&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scanpar3d</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">scanpar3d</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">scanpar3d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scanpar3d</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">scanpar3d</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">,</span> <span class="s1">&#39;scanpar3d must be a &lt;float&gt;&#39;</span>


        <span class="n">par_hold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanpar</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_jac_opt&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_jac_opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: .__settings__[&quot;pitcon_jac_opt&quot;] set to 1 - user defined jacobian function not yet supported&#39;</span><span class="p">)</span>

        <span class="c1"># DONE!</span>
        <span class="k">def</span> <span class="nf">fx</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanpar</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sdot</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Vtemp</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PITCON EXCEPTION 1&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                <span class="n">sdot</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">sdot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">sdot</span>

        <span class="n">parm</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">xr2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parm</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">sdot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parm</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">iwork</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">30</span> <span class="o">+</span> <span class="n">parm</span><span class="p">),</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">rwork</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">30</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="n">parm</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">parm</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">ipar</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parm</span><span class="p">),</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">fpar</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">parm</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">xscan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_par_space</span><span class="p">:</span>
            <span class="n">Vtemp</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">xr2</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">sdot</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">ipar</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fpar</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">iwork</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#This is a startup</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_init_par&quot;</span><span class="p">]</span> <span class="c1">#Use X(1) for initial parameter</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_par_opt&quot;</span><span class="p">]</span> <span class="c1">#Parameterization option 0:allows program</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_jac_upd&quot;</span><span class="p">]</span> <span class="c1">#Update jacobian every newton step</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_targ_val_idx&quot;</span><span class="p">]</span> <span class="c1">#Seek target values for X(n)</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_limit_point_idx&quot;</span><span class="p">]</span> <span class="c1">#Seek limit points in X(n)</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_output_lvl&quot;</span><span class="p">]</span> <span class="c1">#Control amount of output.</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1">#Output unit 6=PC</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_jac_opt&quot;</span><span class="p">]</span> <span class="c1">#Jacobian choice. 0:supply jacobian,1:use forward difference,2:central difference</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iwork</span><span class="p">)</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">parm</span><span class="p">)</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rwork</span><span class="p">)</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_max_step&quot;</span><span class="p">]</span> <span class="c1">#max corrector steps</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">iwork</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">rwork</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_abs_tol&quot;</span><span class="p">]</span>      <span class="c1">#Absolute error tolerance</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_rel_tol&quot;</span><span class="p">]</span>      <span class="c1">#Relative error tolerance</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_min_step&quot;</span><span class="p">]</span>        <span class="c1">#Minimum stepsize</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_max_step&quot;</span><span class="p">]</span>        <span class="c1">#Maximum stepsize</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_start_step&quot;</span><span class="p">]</span>   <span class="c1">#Starting stepsize</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_start_dir&quot;</span><span class="p">]</span>    <span class="c1">#Starting direction +1.0/-1.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_targ_val</span>     <span class="c1">#Target value (Seek solution with iwork[4]=)</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_max_grow&quot;</span><span class="p">]</span> <span class="c1">#maximum growth factor</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">rwork</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanpar</span><span class="p">,</span> <span class="n">xscan</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
            <span class="c1">##  if self.__KeyWords__[&#39;Species_In_Conc&#39;]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesConcToAmount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">)</span>

            <span class="n">go</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span><span class="p">:</span>
                <span class="n">go</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_allow_badstate&quot;</span><span class="p">]:</span>
                <span class="n">go</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">go</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">go</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
                    <span class="c1">#sI0_sim_init</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">)):</span>
                        <span class="n">xr2</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xr2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">[:])</span>
                <span class="n">xr2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">xscan</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pitcon_iter</span><span class="p">)):</span>
                    <span class="n">ierror</span><span class="p">,</span><span class="n">iwork</span><span class="p">,</span><span class="n">rwork</span><span class="p">,</span><span class="n">xr2</span> <span class="o">=</span> <span class="n">pitcon</span><span class="o">.</span><span class="n">pitcon1</span><span class="p">(</span><span class="n">fx</span><span class="p">,</span><span class="n">fpar</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">ipar</span><span class="p">,</span><span class="n">iwork</span><span class="p">,</span><span class="n">rwork</span><span class="p">,</span><span class="n">xr2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">iwork</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_flux_gen&quot;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">xr2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_filter_neg&quot;</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">xout</span> <span class="o">=</span> <span class="n">xr2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="n">a</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">xout</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                                    <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                                <span class="n">xout2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__FluxGen__</span><span class="p">(</span><span class="n">xout</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="n">xout</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="n">xout</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">scanpar3d</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">xout</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">scanpar3d</span><span class="p">)</span>
                                <span class="n">xout2</span> <span class="o">=</span> <span class="n">xout</span><span class="o">+</span><span class="n">xout2</span>
                                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xout2</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">xr2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_filter_neg&quot;</span><span class="p">]:</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">xout</span> <span class="o">=</span> <span class="n">xr2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="n">a</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">xout</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                                    <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                                <span class="n">xout</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                                <span class="n">xout</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">scanpar3d</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">xout</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">scanpar3d</span><span class="p">)</span>
                                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">iwork</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Target point:&#39;</span><span class="p">)</span>
                        <span class="n">xout</span> <span class="o">=</span> <span class="n">xr2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xout</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                            <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                        <span class="n">xout</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">xout</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>

                        <span class="nb">print</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_target_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">iwork</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Limit point&#39;</span><span class="p">)</span>
                        <span class="n">xout</span> <span class="o">=</span> <span class="n">xr2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xout</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                            <span class="n">xout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                        <span class="n">xout</span> <span class="o">=</span> <span class="n">xout</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">xout</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">)</span>

                        <span class="nb">print</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pitcon_limit_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">iwork</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">iwork</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="c1">#raw_input()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Invalid steady state, skipping ...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;pitcon_filter_neg_res&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">result</span><span class="p">][:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scanpar</span><span class="p">,</span> <span class="n">par_hold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.Simulate"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Simulate">[docs]</a>    <span class="k">def</span> <span class="nf">Simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">userinit</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        PySCeS integration driver routine that evolves the system over the time.</span>
<span class="sd">        Resulting array of species concentrations is stored in the **mod.data_sim** object</span>
<span class="sd">        Initial concentrations can be selected using *mod.__settings__[&#39;mode_sim_init&#39;]*</span>
<span class="sd">        (default=0):</span>

<span class="sd">        - 0  initialise with intial concentrations</span>
<span class="sd">        - 1  initialise with a very small (close to zero) value</span>
<span class="sd">        - 2  initialise with results of previously calculated steady state</span>
<span class="sd">        - 3  initialise with final point of previous simulation</span>

<span class="sd">        *userinit* values can be (default=0):</span>

<span class="sd">        - 0: initial species concentrations intitialised from (mod.S_init), time array calculated from sim_start/sim_end/sim_points</span>
<span class="sd">        - 1: intial species concentrations intitialised from (mod.S_init) existing &quot;mod.sim_time&quot; used directly</span>
<span class="sd">        - 2: initial species concentrations read from &quot;mod.__inspec__&quot;, &quot;mod.sim_time&quot; used directly</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if the stoichiometry has been adjusted using Stoich_nmatrix_SetValue - brett 20050719</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StoichOK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Stoichiometry_ReAnalyse</span><span class="p">()</span>

        <span class="c1"># initialises self.__inspec__[x] with self.sXi</span>
        <span class="k">if</span> <span class="n">userinit</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapFunc_R__</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">userinit</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: sim_sinit is the incorrect length initialising with .sX_init&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">))</span>
                <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapFunc_R__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_start</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*****</span><span class="se">\n</span><span class="s1">WARNING: simulations require a minimum of 2 points, setting sim_points = 2.0</span><span class="se">\n</span><span class="s1">*****&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">retstep</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapFunc_R__</span><span class="p">)</span>

        <span class="c1"># initialise __rrule__ to mod.&lt;rule&gt;_init</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_init&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">)):</span>
            <span class="n">cval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_init&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">cval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">cval</span>
        <span class="c1"># set initialisation array to amounts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesConcToAmount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>

        <span class="c1"># set mod.&lt;species&gt; to corrected mod.&lt;species&gt;_init value</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

        <span class="c1">#This should work ok __Build_Tvec__ uses .self.__inspec__ to create Tvec</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__Build_Tvec__</span><span class="p">(</span><span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showConserved</span><span class="p">(</span><span class="n">screenwrite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conserved_sums</span><span class="p">)</span>

        <span class="c1"># Initialise the simulation ...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Start with s[x] at their initial values</span>
            <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Start with s[x] at zero ... well close to it anyway</span>
            <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>
            <span class="n">s0_sim_init</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;small_concentration&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Start with s[x] at the previous steady state if it exists and check if s[x] &lt; 0.0</span>
        <span class="c1"># if so set that value to 1.0e-10</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s0_sim_init</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">s0_sim_init</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">s0_sim_init</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;small_concentration&#39;</span><span class="p">]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Negative concentration detected in SimInit: s[&#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;] set to &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;small_concentration&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_sim_init&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Start with s[x] at the final point of the previous simulation if exists -- johann 20050220</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>

        <span class="c1">#print &#39;Sim debug&#39;</span>
        <span class="c1">#print s0_sim_init</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">)):</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">s0_sim_init</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
            <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="k">del</span> <span class="n">temp</span>
        <span class="c1">#print s0_sim_init</span>

        <span class="c1"># ok so now we add RateRules to the initialisation_vec and see what happens</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">s0_sim_init</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">s0_sim_init</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">])</span>

        <span class="c1"># re-set self._sim recarray (otherwise self.sim is not updated)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># real pluggable integration routines - brett 2007</span>
        <span class="c1"># the array copy is important ... brett leave it alone!</span>
        <span class="n">Tsim0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span> <span class="o">==</span> <span class="s1">&#39;LSODA&#39;</span><span class="p">:</span>
            <span class="n">sim_res</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">simOK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LSODA</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s0_sim_init</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span> <span class="o">==</span> <span class="s1">&#39;CVODE&#39;</span><span class="p">:</span>
            <span class="n">sim_res</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">simOK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CVODE</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s0_sim_init</span><span class="p">))</span>
        <span class="n">Tsim1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;lsoda_mesg&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> time for </span><span class="si">%s</span><span class="s2"> points: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_integrator</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">),</span> <span class="n">Tsim1</span><span class="o">-</span><span class="n">Tsim0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">sim_res</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sim_res</span><span class="p">,[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RateRules evaluated and added to mod.data_sim.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span> <span class="o">=</span> <span class="n">IntegrationDataObj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IS_VALID</span> <span class="o">=</span> <span class="n">simOK</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setTime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setSpecies</span><span class="p">(</span><span class="n">sim_res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setRates</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setRules</span><span class="p">(</span><span class="n">rrules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">setXData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CVODE_extra_output</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CVODE_xdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">simOK</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation failure&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">sim_res</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">getAllSimData</span><span class="p">(</span><span class="n">lbls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromrecords</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sim</span>

<div class="viewcode-block" id="PysMod.State"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.State">[docs]</a>    <span class="k">def</span> <span class="nf">State</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        State()</span>

<span class="sd">        PySCeS non-linear solver driver routine. Solve for a steady state using HYBRD/NLEQ2/FINTSLV</span>
<span class="sd">        algorithms. Results are stored in mod.state_species and mod.state_flux. The results</span>
<span class="sd">        of a steady-state analysis can be viewed with the mod.showState() method.</span>

<span class="sd">        The solver can be initialised in 3 ways using the mode_state_init switch.</span>
<span class="sd">        mod.mode_state_init = 0 initialize with species initial values</span>
<span class="sd">        mod.mode_state_init = 1 initialize with small values</span>
<span class="sd">        mod.mode_state_init = 2 initialize with the final value of a 10-logstep simulation numpy.logspace(0,5,18)</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if the stoichiometry has been adjusted using Stoich_nmatrix_SetValue - brett 20050719</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StoichOK</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Stoichiometry_ReAnalyse</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># function to feed the simulation routine if used to initialise the solver</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">function_sim</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>

        <span class="c1">#set self.__inspec__ to current Xi values</span>
        <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__mapFunc_R__</span><span class="p">)</span>

        <span class="c1"># initialise __rrule__ to mod.&lt;rule&gt;_init</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_init&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="c1"># set compartment values to initial values</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">)):</span>
            <span class="n">cval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_init&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAllIdx__</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">cval</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__CsizeAll__</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">cval</span>
        <span class="c1"># set initialisation array to amounts</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesConcToAmount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>
        <span class="c1"># set mod.&lt;species&gt; to corrected mod.&lt;species&gt;_init value</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
        <span class="c1">#This should work ok __Build_Tvec__ uses .self.__inspec__ to create Tvec</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__Build_Tvec__</span><span class="p">(</span><span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showConserved</span><span class="p">(</span><span class="n">screenwrite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conserved_sums</span><span class="p">)</span>

        <span class="c1">#clear the solver initialisation array</span>
        <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># save the __settings__[&#39;hybrd_factor&#39;]</span>
        <span class="n">hybrd_factor_temp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_factor&#39;</span><span class="p">])</span>

        <span class="c1"># use StateInit to initialise the solver with either 0:initval 1:zeroval 2:sim 3:1%state</span>
        <span class="c1"># in all cases fallback to init</span>
        <span class="c1"># initialising to previous ss seems problematic so I use |10%| of previous - brett</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_state_init</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Use initial S values</span>
            <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_state_init</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Use almost zero values 1.0e-8 any smaller seems to cause a problem</span>
        <span class="c1"># this is user defineable option --&gt; model.ZeroVal - brett 20040121</span>
            <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">s0_ss_init</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;small_concentration&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_state_init</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This initialisation mode has been disabled, using initial values.&#39;</span><span class="p">)</span>
            <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">##  # Perform a 10-logstep simulation numpy.logspace(0,5,18) and initialise solver with final value</span>
        <span class="c1">##  # This is guesstimate ... if anyone has a better idea please let me know</span>
        <span class="c1">##  # it should and be a user defineable array (min/max/len)- brett 20031215</span>
            <span class="c1">##  self.__settings__[&#39;hybrd_factor&#39;] = 10</span>
            <span class="c1">##  try:</span>
                <span class="c1">##  s0_ss_init = scipy.integrate.odeint(function_sim,self.__inspec__.tolist(),self.__mode_state_init2_array__,10000,full_output=0)</span>
                <span class="c1">##  if self.__HAS_MOIETY_CONSERVATION__ == True:</span>
                    <span class="c1">##  s0_ss_init = self.Fix_S_fullinput(s0_ss_init[-1], amounts=True)</span>
                <span class="c1">##  else:</span>
                    <span class="c1">##  s0_ss_init = s0_ss_init[-1]</span>
            <span class="c1">##  except:</span>
                <span class="c1">##  s0_ss_init = copy.copy(self.__inspec__)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_state_init</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Use |10%| of previous steady-state - seems to be safe, needs more testing and probably professional help</span>
        <span class="c1"># My rationale for this is &quot;a set of approximate values where all variables are relatively close&quot;</span>
        <span class="c1"># without having the overhead of a simulation ...</span>
        <span class="c1"># will eventually be a user option so that it can be +/- x% previous steadystate - brett 20031215</span>
        <span class="c1"># Note: hybrid doesn&#39;t seem to like to start too close to its solution more than 10% is dodgy</span>
            <span class="k">if</span>  <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesConcToAmount</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">))</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_init3_factor&#39;</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">)</span>
        <span class="c1"># reset __settings__[&#39;hybrd_factor&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hybrd_factor_temp</span>

        <span class="c1">#print &#39;State debug&#39;</span>
        <span class="c1">#print s0_ss_init</span>
        <span class="c1"># form an initialisation vector of independent species</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">)):</span>
                <span class="n">temp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">s0_ss_init</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
            <span class="c1"># add RateRules to the initialisation_vec and see what happens</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">temp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rrule__</span><span class="p">])</span>
            <span class="n">s0_ss_init</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="k">del</span> <span class="n">temp</span>
        <span class="c1">#print s0_ss_init</span>

        <span class="n">available_solvers</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HYBRD&#39;</span><span class="p">]</span>

        <span class="c1"># set mode_solver to new syntax for backwards compatibility only</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">=</span> <span class="s1">&#39;HYBRD&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">=</span> <span class="s1">&#39;FINTSLV&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">=</span> <span class="s1">&#39;NLEQ2&#39;</span>

        <span class="c1"># check for nleq2 and add if available this should be first</span>
        <span class="k">if</span> <span class="n">nleq2_switch</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">available_solvers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NLEQ2&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">==</span> <span class="s1">&#39;NLEQ2&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">=</span> <span class="s1">&#39;HYBRD&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: switching to HYBRD.</span><span class="se">\n</span><span class="s1">Nleq2 solver not available see /nleq/readme.txt for details&#39;</span><span class="p">)</span>

        <span class="c1"># ******* OTHER SOLVERS GO IN HERE *******</span>

        <span class="c1"># ******* OTHER SOLVERS GO IN HERE *******</span>

        <span class="c1"># shall we add HYBRD to fallback? this should be last</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_solver_fallback_integration&#39;</span><span class="p">]:</span>
            <span class="n">available_solvers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;FINTSLV&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver_fallback</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="ow">in</span> <span class="n">available_solvers</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ERROR: </span><span class="si">%s</span><span class="s1"> is not a valid (</span><span class="si">%s</span><span class="s1">) solver!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">available_solvers</span><span class="p">))</span>
            <span class="n">available_solvers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span><span class="p">]</span>

        <span class="c1"># if solver other than HYBRD is selected move it to front of list so it is run first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span> <span class="o">!=</span> <span class="s1">&#39;HYBRD&#39;</span><span class="p">:</span>
            <span class="n">available_solvers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">available_solvers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">available_solvers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_solver</span><span class="p">)))</span>

        <span class="n">STATE_XOUT</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">STATE_xdata</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STATE_extra_output</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATE_extra_output</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: STATE is ignoring extra data (</span><span class="si">%s</span><span class="s1">), it either doesn</span><span class="se">\&#39;</span><span class="s1">t exist or it</span><span class="se">\&#39;</span><span class="s1">s a species, rate or rule.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">STATE_extra_output</span> <span class="o">=</span> <span class="n">out</span>
                <span class="n">STATE_XOUT</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">del</span> <span class="n">out</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">state_species</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rrules</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">state_flux</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">solver</span> <span class="ow">in</span> <span class="n">available_solvers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;HYBRD&#39;</span><span class="p">:</span>
                <span class="n">state_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HYBRD</span><span class="p">(</span><span class="n">s0_ss_init</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;NLEQ2&#39;</span><span class="p">:</span>
                <span class="n">state_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NLEQ2</span><span class="p">(</span><span class="n">s0_ss_init</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">solver</span> <span class="o">==</span> <span class="s1">&#39;FINTSLV&#39;</span><span class="p">:</span>
                <span class="n">state_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FINTSLV</span><span class="p">(</span><span class="n">s0_ss_init</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="c1">#In case of a number (scalar) output from the solver</span>
            <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">state_species</span><span class="p">):</span>
                <span class="n">state_species</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state_species</span><span class="p">],</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

            <span class="c1"># this gets everything into the current tout state</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalODE</span><span class="p">(</span><span class="n">state_species</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">Vtemp</span><span class="p">)</span>
            <span class="n">state_flux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
                <span class="n">state_species</span><span class="p">,</span> <span class="n">rrules</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">state_species</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">Nrmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="c1"># test for negative concentrations</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">state_species</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_mesg&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING!! Negative concentrations detected.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_solver_fallback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;solver_switch_warning&#39;</span><span class="p">]:</span>
                    <span class="n">slv_idx</span>  <span class="o">=</span> <span class="n">available_solvers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">slv_idx</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">available_solvers</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: STATE is switching to </span><span class="si">%s</span><span class="s1"> solver.&#39;</span> <span class="o">%</span> <span class="n">available_solvers</span><span class="p">[</span><span class="n">slv_idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: STATE calculation failed!&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">STATE_XOUT</span><span class="p">:</span>
            <span class="n">STATE_xdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalExtraData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STATE_extra_output</span><span class="p">)</span>

        <span class="c1"># the current status quo is all state algorithms will use and produce results</span>
        <span class="c1"># in amounts and autoconversion to and from species takes place in the calling</span>
        <span class="c1"># algorithms -- brett2008</span>
        <span class="c1"># THIS IS OPPOSITE TO THE SIMULATE METHOD brett - again</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">state_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fix_S_indinput</span><span class="p">(</span><span class="n">state_species</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="n">state_species</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span> <span class="o">=</span> <span class="n">state_species</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span> <span class="o">=</span> <span class="n">state_flux</span>

        <span class="k">del</span> <span class="n">state_species</span><span class="p">,</span> <span class="n">state_flux</span>

        <span class="c1"># final check for a bad state set check if fluxes are == mach_eps</span>
        <span class="c1"># this is almost never going to be true</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">WARNING: extremely small flux detected! proceed with caution:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">)</span>
            <span class="c1">##  self.__StateOK__ = False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">***</span><span class="se">\n</span><span class="s1">WARNING: invalid steady state solution (species concentrations and fluxes)</span><span class="se">\n</span><span class="s1">***</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_nan_on_fail&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>

        <span class="c1"># set the instance steady state flux and species attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetStateSymb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">)</span>

        <span class="c1"># coming soon to a terminal near you</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span> <span class="o">=</span> <span class="n">StateDataObj</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="o">.</span><span class="n">setSpecies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="o">.</span><span class="n">setFluxes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="o">.</span><span class="n">setRules</span><span class="p">(</span><span class="n">rrules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">STATE_XOUT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="o">.</span><span class="n">setXData</span><span class="p">(</span><span class="n">STATE_xdata</span><span class="p">,</span> <span class="n">lbls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">STATE_extra_output</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">STATE_xdata</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="o">.</span><span class="n">IS_VALID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.state_species&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.state_flux&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">)</span></div>

<span class="c1">#driver routines that support the core routines</span>
<span class="c1">#   core support</span>

    <span class="c1"># takes the flux and species arrays and</span>
    <span class="c1"># assigns them as instances variable self.Jx and self.Xss</span>
    <span class="c1"># I&#39;m not sure if anyone wants to use this in real life so it might be hidden at some point - brett 20040122</span>
    <span class="c1"># gone - brett 20040506 ... back brett 20040720</span>
<div class="viewcode-block" id="PysMod.SetStateSymb"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.SetStateSymb">[docs]</a>    <span class="k">def</span> <span class="nf">SetStateSymb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">flux</span><span class="p">,</span><span class="n">metab</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SetStateSymb(flux,metab)</span>

<span class="sd">        Sets the individual steady-state flux and concentration attributes as</span>
<span class="sd">        mod.J_&lt;reaction&gt; and mod.&lt;species&gt;_ss</span>

<span class="sd">        Arguments:</span>

<span class="sd">        flux: the steady-state flux array</span>
<span class="sd">        metab: the steady-state concentration array</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_ss&#39;</span><span class="p">,</span> <span class="n">metab</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;J_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">x</span><span class="p">])</span></div>

    <span class="c1"># uses __inspec__ to build Tvec</span>
    <span class="k">def</span> <span class="nf">__Build_Tvec__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __Build_Tvec_(concs=False)</span>

<span class="sd">        Creates vectors of conserved moiety totals from __inspec__</span>
<span class="sd">        self.__tvec_a__ = amounts</span>
<span class="sd">        self.__tvec_c__ = concentrations</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">amounts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reordered_lcons</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_c__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reordered_lcons</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesAmountToConc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_c__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reordered_lcons</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reordered_lcons</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_SpeciesConcToAmount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__inspec__</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="PysMod.showConserved"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showConserved">[docs]</a>    <span class="k">def</span> <span class="nf">showConserved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">screenwrite</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%2.3f</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showConserved(File=None,screenwrite=1,fmt=&#39;%2.3f&#39;)</span>

<span class="sd">        Print the moiety conserved cycles present in the system.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open writable Python file object</span>
<span class="sd">        screenwrite [default=1]: write results to console (0 means no reponse)</span>
<span class="sd">        fmt [default=&#39;%2.3f&#39;]: the output number format string</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">Tlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">Tlist</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">ConSumPstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">Tlist</span><span class="p">)):</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix_col</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix</span><span class="p">[</span><span class="n">Tlist</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="c1">#coeff = self.__settings__[&#39;mode_number_format&#39;] % (s_init[y]*abs(conservation_matrix[Tlist[x],y]))</span>
                            <span class="n">coeff</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix</span><span class="p">[</span><span class="n">Tlist</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">y</span><span class="p">])</span>
                            <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span>
                            <span class="n">ConSumPstr</span> <span class="o">+=</span> <span class="s1">&#39; + {&#39;</span> <span class="o">+</span> <span class="n">coeff</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix</span><span class="p">[</span><span class="n">Tlist</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="c1">#coeff = self.__settings__[&#39;mode_number_format&#39;] % (s_init[y]*abs(conservation_matrix[Tlist[x],y]))</span>
                            <span class="n">coeff</span> <span class="o">=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix</span><span class="p">[</span><span class="n">Tlist</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="n">y</span><span class="p">])</span>
                            <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conservation_matrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span>
                            <span class="n">ConSumPstr</span> <span class="o">+=</span> <span class="s1">&#39; - {&#39;</span> <span class="o">+</span> <span class="n">coeff</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_COMPARTMENTS__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
                        <span class="n">ConSumPstr</span> <span class="o">+=</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_c__</span><span class="p">[</span><span class="n">Tlist</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ConSumPstr</span> <span class="o">+=</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">[</span><span class="n">Tlist</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conserved_sums</span> <span class="o">=</span> <span class="n">ConSumPstr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conserved_sums</span> <span class="o">=</span> <span class="s1">&#39;No moiety conservation&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conserved relationships&#39;</span><span class="p">)</span>
            <span class="c1">#assert type(File) == file, &#39;showConserved() needs an open file object&#39;</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Conserved relationships</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conserved_sums</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">screenwrite</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Conserved relationships&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conserved_sums</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.showFluxRelationships"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showFluxRelationships">[docs]</a>    <span class="k">def</span> <span class="nf">showFluxRelationships</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showConserved(File=None)</span>

<span class="sd">        Print the flux relationships present in the system.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Ostr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">Ostr</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> =&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix_row</span><span class="p">[</span><span class="n">row</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span>  <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span>  <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="n">Ostr</span> <span class="o">+=</span> <span class="s2">&quot; + {</span><span class="si">%2.2f</span><span class="s2">}</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix_col</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Ostr</span> <span class="o">+=</span> <span class="s2">&quot; - {</span><span class="si">%2.2f</span><span class="s2">}</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix_col</span><span class="p">[</span><span class="n">col</span><span class="p">]])</span>
            <span class="n">Ostr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Flux relationships&#39;</span><span class="p">)</span>
            <span class="c1">#assert type(File) == file, &#39;showConserved() needs an open file object&#39;</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Flux relationships</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">Ostr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Flux relationships&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Ostr</span><span class="p">)</span></div>

    <span class="c1"># Calculate dependant variables done directly in EvalREq2 this is a utility version</span>
<div class="viewcode-block" id="PysMod.Fix_S_fullinput"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Fix_S_fullinput">[docs]</a>    <span class="k">def</span> <span class="nf">Fix_S_fullinput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_vec</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fix_S_fullinput(s_vec)</span>

<span class="sd">        Using the full concentration vector evaluate the dependent species</span>

<span class="sd">        Arguments:</span>

<span class="sd">        s_vec: a full length concentration vector</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># s_vec = copy.copy(s)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_vec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">amounts</span><span class="p">:</span>
                <span class="n">s_vec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)</span>  <span class="c1">#there might be a way to reduce the 2 for loops</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s_vec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_c__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__SI__</span><span class="p">)</span>  <span class="c1">#there might be a way to reduce the 2 for loops</span>

        <span class="k">return</span> <span class="n">s_vec</span></div>

    <span class="c1"># Calculate dependant variables done directly in EvalREq2B this is a utility version</span>
<div class="viewcode-block" id="PysMod.Fix_S_indinput"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Fix_S_indinput">[docs]</a>    <span class="k">def</span> <span class="nf">Fix_S_indinput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s_vec</span><span class="p">,</span> <span class="n">amounts</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fix_S_indinput(s_vec, amounts=True)</span>
<span class="sd">        whether to use self.__tvec_a__ (default)</span>
<span class="sd">        or self.__tvec_c__</span>

<span class="sd">        Given a vector of independent species evaluate and return a full concentration vector.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        s_vec: vector of independent species</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#stick SI into s using Nrrow order</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_vec</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="n">s_vec</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="c1">#stick SD into s using lzerorow order</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">amounts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span><span class="o">*</span><span class="n">s_vec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__tvec_c__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span><span class="o">*</span><span class="n">s_vec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__SALL__</span><span class="p">)</span></div>

<span class="c1">#   output support routines</span>

    <span class="c1"># Quick and dirty flux regeneration uses the Rx form of the RE&#39;s to cater for potential conservation</span>
    <span class="c1"># caters for both vectors and arrays and is conservation aware</span>
    <span class="k">def</span> <span class="nf">__FluxGen__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Deprecating** only used by **PITCON**</span>

<span class="sd">        s: species vector/array</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__Nshape__</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Vout</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__vvec__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1">#depending if there is conservation -- N.L_switch is: 0 for none or 1 for present</span>
                    <span class="n">Vout</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq2_alt</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">x</span><span class="p">,:],</span><span class="n">Vtemp</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">Vout</span><span class="p">[</span><span class="n">x</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">x</span><span class="p">,:],</span><span class="n">Vtemp</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1">#depending if there is conservation -- N.L_switch is: 0 for none or 1 for present</span>
                <span class="n">Vout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq2_alt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">Vout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EvalREq</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Vout</span>

<div class="viewcode-block" id="PysMod.FluxGenSim"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.FluxGenSim">[docs]</a>    <span class="k">def</span> <span class="nf">FluxGenSim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Deprecated**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="PysMod.ParGenSim"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.ParGenSim">[docs]</a>    <span class="k">def</span> <span class="nf">ParGenSim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Deprecated**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="PysMod.Fix_Sim"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Fix_Sim">[docs]</a>    <span class="k">def</span> <span class="nf">Fix_Sim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">metab</span><span class="p">,</span><span class="n">flux</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">par</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Deprecated**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<span class="c1"># MCA routines</span>
<span class="c1">#   elasticity routines</span>

<div class="viewcode-block" id="PysMod.EvalEvar"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.EvalEvar">[docs]</a>    <span class="k">def</span> <span class="nf">EvalEvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">input2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EvalEvar(input=None,input2=None)</span>

<span class="sd">        Calculate reaction elasticities towards the variable species.</span>

<span class="sd">        Both inputs (input1=species,input2=rates) should be valid (steady state for MCA) solutions and given in the correct order for them to be used. If either or both are missing the last state values are used automatically.</span>
<span class="sd">        Elasticities are scaled using input 1 and 2.</span>

<span class="sd">        Arguments::</span>

<span class="sd">         - input [default=None]:  species concentration vector</span>
<span class="sd">         - input2 [default=None]: reaction rate vector</span>

<span class="sd">        Settings, set in mod.__settings__::</span>

<span class="sd">         - elas_evar_upsymb   [default = 1] attach individual elasticity symbols to model instance</span>
<span class="sd">         - elas_zero_conc_fix [default=False] if zero concentrations are detected in a steady-state solution make it a very small number</span>
<span class="sd">         - elas_zero_flux_fix [default=False] if zero fluxes are detected in a steady-state solution make it a very small number</span>
<span class="sd">         - elas_scaling_div0_fix [default=False] if INf&#39;s are detected after scaling set to zero</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">input2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span>
            <span class="n">input2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span>
            <span class="c1">#print &#39;INFO: Using state_species and state_flux as input&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">),</span> <span class="s1">&#39;length error this array must have &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; elements&#39;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">),</span> <span class="s1">&#39;length error this array must have &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; elements&#39;</span>
            <span class="c1"># not really necessary but in here just in case - brett 20040930</span>
            <span class="c1"># map input back to self.Sx</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CDvarUpString__</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_zero_flux_fix&#39;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">input2</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Info: zero flux detected: J_</span><span class="si">%s</span><span class="s1"> set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">val</span><span class="p">))</span>
                    <span class="n">input2</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_zero_conc_fix&#39;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">val</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Info: zero concentration detected: </span><span class="si">%s</span><span class="s1"> set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">val</span><span class="p">))</span>
                    <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Varinput = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="c1"># scale KL (future refactoring allow user input)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ScaleKL</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span><span class="n">input2</span><span class="p">)</span>

        <span class="c1"># create tuples of the rows and columns for the Ev matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">))</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">)):</span>
            <span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">col</span>

        <span class="c1"># attempt to evaluate every variable against every flux: E&#39;s &gt; mach_eps are assumed to exist</span>
        <span class="k">for</span> <span class="n">react</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reaction: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)):</span>
                <span class="n">countV</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">countMet</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># this modification should make this independant of a steady state - finally implimented july2004</span>
                <span class="c1"># eval(&#39;self.&#39;+ self.__species__[met] + &#39;_ss&#39;),order=self.__settings__[&#39;mode_elas_deriv_order&#39;],dx=hstep,n=1,\</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="sd">&quot;&quot;&quot; I got the idea of scaling the stepsize to So from Herbert Sauro&#39;s Jarnac TModel.uEEOp function</span>

<span class="sd">                    brett - 20040818&quot;&quot;&quot;</span>

                    <span class="n">hstep</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">met</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_factor&#39;</span><span class="p">]</span>  <span class="c1"># self.__settings__[&#39;mode_elas_deriv_factor&#39;] = 0.0001</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hstep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_min&#39;</span><span class="p">]:</span>         <span class="c1"># self.__settings__[&#39;mode_elas_deriv_min&#39;] = 1.0e-12</span>
                        <span class="n">hstep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_min&#39;</span><span class="p">]</span>

                    <span class="n">a</span> <span class="o">=</span> <span class="n">ScipyDerivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__num_deriv_function__</span><span class="p">,</span><span class="nb">input</span><span class="p">[</span><span class="n">met</span><span class="p">],</span><span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_order&#39;</span><span class="p">],</span><span class="n">dx</span><span class="o">=</span><span class="n">hstep</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">met</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: Elasticity evaluation failure in &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">met</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elasticity has been set to zero&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A stepsize that is too large might cause this ... try decreasing the factor and or min stepsize&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Keep in mind machine precision, is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">],</span> <span class="s1">&#39; and if min stepsize&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;becomes too small numeric error can become significant&#39;</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;species: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">met</span><span class="p">])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--&gt; d(&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)d(&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">met</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;) = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">[</span><span class="n">react</span><span class="p">,</span><span class="n">met</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

       <span class="c1"># restore variables to ss values only if steady state used</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_evar_remap&#39;</span><span class="p">]:</span>
            <span class="nb">eval</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__remaps</span><span class="p">,</span><span class="s1">&#39;__remaps&#39;</span><span class="p">,</span><span class="s1">&#39;exec&#39;</span><span class="p">))</span>
            <span class="c1">#print &quot;\nREMAPPING\n&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span>

        <span class="c1"># If scaled mca is requested</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Ds</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">Dj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)):</span>
                <span class="n">Ds</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="c1">#print Ds</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)):</span>
                <span class="n">Dj</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">input2</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_scaling_div0_fix&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">Dj</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Infinite elasticity detected during scaling setting to zero (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">Dj</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-16</span>
            <span class="c1">#print Dj</span>

            <span class="n">Dj_e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dj_e</span><span class="p">,</span> <span class="n">Ds</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elas_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elas_var</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;elas_evar_upsymb&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Upload elasticity symbols into namespace</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">output2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
                <span class="n">react</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                    <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ec&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;uec&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

            <span class="c1"># the new way of doing things (test phase) brett - 2007</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec</span> <span class="o">=</span> <span class="n">BagOfStuff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ec</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">********************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">output2</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">********************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1">#print &#39;INFO: variable elasticity symbols not attached - .__settings__[&quot;elas_evar_upsymb&quot;] = &#39; + `self.__settings__[&quot;elas_evar_upsymb&quot;]`</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">e_vmatrix&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.CleanNaNsFromArray"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.CleanNaNsFromArray">[docs]</a>    <span class="k">def</span> <span class="nf">CleanNaNsFromArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arr</span><span class="p">,</span> <span class="n">replace_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan a matrix for NaN&#39;s and replace with zeros:</span>

<span class="sd">         - *arr* the array to be cleaned</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nantest</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nantest</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nantest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">nantest</span><span class="p">[</span><span class="n">r</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nantest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]):</span>
                            <span class="n">arr</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">replace_val</span></div>

<div class="viewcode-block" id="PysMod.EvalEpar"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.EvalEpar">[docs]</a>    <span class="k">def</span> <span class="nf">EvalEpar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">input2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EvalEpar(input=None,input2=None)</span>

<span class="sd">        Calculate reaction elasticities towards the parameters.</span>

<span class="sd">        Both inputs (input1=species,input2=rates) should be valid (steady state for MCA) solutions and given in the correct order for them to be used. If either or both are missing the last state values are used automatically. Elasticities are scaled using input 1 and 2.</span>

<span class="sd">        Arguments:</span>

<span class="sd">         - input [default=None]: species concentration vector</span>
<span class="sd">         - input2 [default=None]: reaction rate vector</span>

<span class="sd">        Settings, set in mod.__settings__::</span>

<span class="sd">         - elas_epar_upsymb   [default = 1] attach individual elasticity symbols to model instance</span>
<span class="sd">         - elas_scaling_div0_fix [default=False] if NaN&#39;s are detected in the variable and parameter elasticity matrix replace with zero</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">input2</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span>
            <span class="n">input2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">),</span> <span class="s1">&#39;length error this array must have &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; elements&#39;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">),</span> <span class="s1">&#39;length error this array must have &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; elements&#39;</span>
            <span class="c1"># put in to fix the juicy bug - brett 20040930</span>
            <span class="c1"># iow automatic derivatives use the current values of self.Sx to operate</span>
            <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__CDvarUpString__</span><span class="p">)</span>

        <span class="c1"># create parameter holding array</span>
        <span class="n">parVal_hold</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parinput = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">parVal_hold1&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">parVal_hold</span><span class="p">)</span>

        <span class="c1">#Store parameter values into the storage array and copy them to the working array (parVal2)</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__par_map2storeC</span><span class="p">)</span>
        <span class="n">parVal2</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">parVal_hold</span><span class="p">)</span>

        <span class="c1"># create the matrix of parameter elasticities</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="c1"># create tuples of the rows and columns for the Ep matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_par_row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elas_par_col</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">react</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reaction: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)):</span>
                <span class="n">countV</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">countPar</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="sd">&quot;&quot;&quot; I got the idea of scaling the stepsize to So from Herbert Sauro&#39;s Jarnac TModel.uEEOp function</span>

<span class="sd">                    brett - 20040818&quot;&quot;&quot;</span>

                    <span class="n">hstep</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">par</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_factor&#39;</span><span class="p">]</span>  <span class="c1"># self.__settings__[&#39;mode_elas_deriv_factor&#39;] = 0.0001</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">hstep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_min&#39;</span><span class="p">]:</span>         <span class="c1"># self.__settings__[&#39;mode_elas_deriv_min&#39;] = 1.0e-12</span>
                        <span class="n">hstep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_min&#39;</span><span class="p">]</span>

                    <span class="n">a</span> <span class="o">=</span> <span class="n">ScipyDerivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__num_deriv_function__</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">par</span><span class="p">]),</span><span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_elas_deriv_order&#39;</span><span class="p">],</span><span class="n">dx</span><span class="o">=</span><span class="n">hstep</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>\
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">par</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Numeric derivative evaluation failure in &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">par</span><span class="p">])</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Elasticity has been set to NaN&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A stepsize that is too large might cause this ... try decreasing the factor and or min stepsize&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Keep in mind machine precision, is&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">],</span> <span class="s1">&#39; and if min stepsize&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;becomes too small numeric error can become significant&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span>

                <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mach_floateps&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;parameter: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">par</span><span class="p">])</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--&gt; d(&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">react</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)d(&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">par</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;) = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="p">[</span><span class="n">react</span><span class="p">,</span><span class="n">par</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elas_par_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span>

        <span class="c1">#Retrieve parameter values from the storage array</span>
        <span class="n">exec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__par_remapC</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">parVal_hold2&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">parVal_hold</span><span class="p">)</span>

        <span class="c1"># Parameters are scaled by [1/J]*[Ep]*[P]</span>
        <span class="c1"># If scaled mca is requested scale self.__epmatrix__</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">Dp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
            <span class="n">Dj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)):</span>
                <span class="n">Dp</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">parVal_hold</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="c1">#print Dp</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)):</span>
                <span class="n">Dj</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">input2</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;elas_scaling_div0_fix&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">Dj</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Infinite elasticity detected during scaling setting to zero (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="n">Dj</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0e-16</span>
            <span class="c1">#print Dj</span>

            <span class="n">Dj_e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dj</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dj_e</span><span class="p">,</span> <span class="n">Dp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elas_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elas_par</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">del</span> <span class="n">parVal_hold</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;elas_epar_upsymb&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Upload elasticity symbols into namespace</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">output2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
                <span class="n">react</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                    <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ec&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;uec&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">met</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

            <span class="c1"># the new way of doing things (test phase) brett - 2007</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecp</span> <span class="o">=</span> <span class="n">BagOfStuff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_par_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_par_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ecp</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecp</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ecp</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">********************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">output2</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">********************************</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">e_pmatrix&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showEvar"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showEvar">[docs]</a>    <span class="k">def</span> <span class="nf">showEvar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showEvar(File=None)</span>

<span class="sd">        Write out all variable elasticities as \&#39;LaTeX\&#39; formatted strings, alternatively write results to a file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The Variable elasticities</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">evar_output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
                <span class="n">react</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="n">evar_output</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                    <span class="n">rtemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                    <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__evmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                            <span class="n">elas</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">ec{&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">elas</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">uec{&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="n">evar_output</span> <span class="o">+=</span> <span class="n">elas</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">evar_output</span> <span class="o">=</span> <span class="n">evar_output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">evar_output</span> <span class="o">=</span> <span class="s1">&#39;No variable elasticities - run EvalEvar() to calculate&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">species elasticities&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## species elasticities</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">evar_output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">species elasticities&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">evar_output</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.showEpar"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showEpar">[docs]</a>    <span class="k">def</span> <span class="nf">showEpar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showEpar(File=None)</span>

<span class="sd">        Write out all nonzero parameter elasticities as \&#39;LaTeX\&#39; formatted strings, alternatively write to file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The parameter elasticities</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">epar_output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
                <span class="n">react</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="n">epar_output</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                    <span class="n">rtemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__epmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                    <span class="n">met</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                    <span class="c1"># brett (paranoia removal) October 2004</span>
                    <span class="c1">#if abs(self.__epmatrix__[x,y]) &gt;= 1.e-15:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                        <span class="n">elas</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">ec{&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">elas</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">uec{&#39;</span> <span class="o">+</span> <span class="n">react</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">met</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="c1">#print elas</span>
                    <span class="n">epar_output</span> <span class="o">+=</span> <span class="n">elas</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">epar_output</span> <span class="o">=</span> <span class="n">epar_output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">epar_output</span> <span class="o">=</span> <span class="s1">&#39;No parameter elasticities - run EvalEpar() to calculate&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parameter elasticities&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Parameter elasticities</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">epar_output</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parameter elasticities&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">epar_output</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showElas"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showElas">[docs]</a>    <span class="k">def</span> <span class="nf">showElas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showElas(File=None)</span>

<span class="sd">        Print all elasticities to screen or file as \&#39;LaTeX\&#39; compatible strings.</span>
<span class="sd">        Calls showEvar() and showEpar()</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showEvar</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showEpar</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showEvar</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showEpar</span><span class="p">()</span></div>


<div class="viewcode-block" id="PysMod.ScaleKL"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.ScaleKL">[docs]</a>    <span class="k">def</span> <span class="nf">ScaleKL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">input2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ScaleKL(input,input2)</span>

<span class="sd">        Scale the K and L matrices with current steady state (if either input1 or 2 == None) or user input.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        input: vector of species concentrations</span>
<span class="sd">        input2: vector of reaction rates</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># called by EvalEvar</span>
        <span class="c1"># Scale L matrix</span>
        <span class="n">lmat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span>
            <span class="n">input2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span>
            <span class="c1">#print &#39;INFO: Using state_species and state_flux as input&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">),</span> <span class="s1">&#39;length error this array must have &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; elements&#39;</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">),</span> <span class="s1">&#39;length error this array must have &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; elements&#39;</span>

        <span class="n">s_1_scale</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s_1_scale</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="nb">input</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="c1">#create 1/D Using the steady-state met&#39;s ordered to the rows</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Zero species detected: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;_ss = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]))</span>
                <span class="n">s_1_scale</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">Si_order</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">))</span> <span class="c1">#check</span>
        <span class="n">Si_scale</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)):</span>
            <span class="n">Si_order</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="c1">#check</span>
            <span class="n">Si_scale</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

        <span class="n">L_Si</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lmat</span><span class="p">,</span> <span class="n">Si_scale</span><span class="p">)</span>
        <span class="n">L_scaled</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">s_1_scale</span><span class="p">,</span> <span class="n">L_Si</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_scaled</span> <span class="o">=</span> <span class="n">L_scaled</span>

        <span class="c1">#Scale K matrix</span>
        <span class="n">kmat</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">)</span>

        <span class="n">j_1_scale</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">input2</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">j_1_scale</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">input2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Null flux detected: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;_ss = &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">input2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]))</span>
                <span class="n">j_1_scale</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">Ji_order</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">))</span> <span class="c1">#check</span>
        <span class="n">Ji_scale</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">)),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">)):</span>
            <span class="n">Ji_order</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="c1">#check</span>
            <span class="n">Ji_scale</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">input2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

        <span class="n">K_Ji</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">kmat</span><span class="p">,</span> <span class="n">Ji_scale</span><span class="p">)</span>
        <span class="n">K_scaled</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j_1_scale</span><span class="p">,</span> <span class="n">K_Ji</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_scaled</span> <span class="o">=</span> <span class="n">K_scaled</span></div>

    <span class="k">def</span> <span class="nf">__num_deriv_function__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">react</span><span class="p">,</span><span class="n">met</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        __num_deriv_function__(x,react,met)</span>

<span class="sd">        System function that evaluates the rate equation, used by numeric perturbation methods to derive</span>
<span class="sd">        elasticities. It uses a specific format assigning x to met and evaluating react for v and is tailored for the ScipyDerivative() function using precompiled function strings.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        x: value to assign to met</span>
<span class="sd">        react: reaction</span>
<span class="sd">        met: species</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#exec(met)</span>
        <span class="c1">#self.Forcing_Function()</span>
        <span class="c1">#exec(react)</span>
        <span class="c1">#return v</span>
        <span class="n">bk</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">met</span><span class="p">)</span> <span class="c1"># backup current metabolite value</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">met</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Forcing_Function</span><span class="p">()</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">react</span><span class="p">)</span>
        <span class="n">vout</span> <span class="o">=</span> <span class="n">v</span><span class="p">()</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">met</span><span class="p">,</span> <span class="n">bk</span><span class="p">)</span> <span class="c1"># reset metabolite value</span>
        <span class="k">return</span> <span class="n">vout</span>

<span class="c1">#   Control coefficient routines</span>
<div class="viewcode-block" id="PysMod.EvalCC"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.EvalCC">[docs]</a>    <span class="k">def</span> <span class="nf">EvalCC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EvalCC()</span>

<span class="sd">        Calculate the MCA control coefficients using the current steady-state solution.</span>

<span class="sd">        mod.__settings__[&quot;mca_ccj_upsymb&quot;] = 1  attach the flux control coefficients to the model instance</span>
<span class="sd">        mod.__settings__[&quot;mca_ccs_upsymb&quot;] = 1 attach the concentration control coefficients to the model instance</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#sort E to match K and L</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">)),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="c1">#print e2</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">)):</span>
                <span class="n">e2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_u</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e2</span><span class="p">)</span>

        <span class="n">EL</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">e2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">)</span>
        <span class="n">KEL</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">,</span> <span class="n">EL</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kel_unscaled</span> <span class="o">=</span> <span class="n">KEL</span>

        <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Ci_u</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">KEL</span><span class="p">)</span>
            <span class="c1"># fortran has a very fp idea of zero I use abs(val)&lt;1.0e-15</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">MatrixFloatFix</span><span class="p">(</span><span class="n">Ci_u</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="mf">1.e-15</span><span class="p">)</span>
            <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: K-EL matrix inversion failed this is possibly due to NaN values in the Elasticity matrix&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NaN elasticities can be caused by zero fluxes or concentrations look at the settings (in mod.__settings__)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">elas_scaling_div0_fix</span><span class="se">\&#39;</span><span class="s1"> and </span><span class="se">\&#39;</span><span class="s1">elas_zero_flux_fix</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">go</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span> <span class="o">=</span> <span class="n">Ci_u</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__mca_CCi_unscaled</span> <span class="o">=</span> <span class="n">Ci_u</span>
            <span class="k">del</span> <span class="n">Ci_u</span>
        <span class="k">elif</span> <span class="n">go</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
            <span class="n">Vi_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#Ind fluxes</span>
            <span class="n">Vd_l</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Can never be the case but b.paranoid</span>
            <span class="n">Si_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1">#Ind species</span>
            <span class="n">Sd_l</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="c1"># Can never be the case but b.paranoid</span>

            <span class="n">scale1_l</span> <span class="o">=</span> <span class="n">Vi_l</span> <span class="o">+</span> <span class="n">Si_l</span>
            <span class="n">scale1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">scale1_l</span><span class="p">,</span><span class="n">scale1_l</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Vi_l</span><span class="p">):</span>
                <span class="n">scale1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Vi_l</span><span class="p">,</span><span class="n">scale1_l</span><span class="p">):</span>
                <span class="n">scale1</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="n">Vi_l</span><span class="p">]]</span>

            <span class="n">scale2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Vi_l</span> <span class="o">+</span> <span class="n">Vd_l</span><span class="p">,</span> <span class="n">Vi_l</span> <span class="o">+</span> <span class="n">Vd_l</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">)):</span>
                <span class="n">scale2</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>

            <span class="n">left</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">scale1</span><span class="p">,</span> <span class="n">Ci_u</span><span class="p">)</span>
            <span class="n">Ci</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">scale2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span> <span class="o">=</span> <span class="n">Ci</span>
            <span class="k">del</span> <span class="n">scale1_l</span><span class="p">,</span> <span class="n">scale1</span><span class="p">,</span> <span class="n">scale2</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">Ci</span><span class="p">,</span> <span class="n">Ci_u</span>

        <span class="n">Cirow</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Cicol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># the wierdness continues</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">)):</span>
            <span class="n">Cicol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">)):</span>
            <span class="n">Cirow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)):</span>
            <span class="n">Cirow</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span> <span class="o">=</span> <span class="n">Cirow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span> <span class="o">=</span> <span class="n">Cicol</span>

        <span class="k">del</span> <span class="n">e2</span><span class="p">,</span> <span class="n">EL</span><span class="p">,</span> <span class="n">KEL</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;print self.mca_ci_row&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;print self.mca_ci_col&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;print self.mca_ci&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">)</span>

        <span class="n">CJi</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">CSi</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">):</span>
                    <span class="n">CJi</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">CSi</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">),</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>

        <span class="n">Ko_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Ko_col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sKo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">xFactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1">#we need the scaled k/l matrices to calculate the dependent cc&#39;s</span>
        <span class="c1">#self.ScaleKL()</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">Ko_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#this can be replaced by a row slice operation</span>
                <span class="n">sKo</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_scaled</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">xFactor</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Ko_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kzeromatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]])</span>

        <span class="n">Ko_row</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">Ko_col</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CJi&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">CJi</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sKo&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">sKo</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.kzeromatrix&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="p">)</span>

        <span class="c1">#new</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sKo</span><span class="p">,</span> <span class="n">CJi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kzeromatrix__</span><span class="p">,</span> <span class="n">CJi</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd_row</span> <span class="o">=</span> <span class="n">Ko_row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">sKo</span><span class="p">,</span> <span class="n">CJi</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.mca_cjd_row&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.mca_cjd_col&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd_col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.mca_cjd&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd</span><span class="p">)</span>

        <span class="n">Lo_row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Lo_col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sLo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="n">xFactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">Lo_row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="c1">#this can be replaced by a row slice operation</span>
                <span class="n">sLo</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_scaled</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">xFactor</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Lo_col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__D_s_Order</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lzeromatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]])</span>

        <span class="n">Lo_row</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">Lo_col</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#Only do this if there is S dependency</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sLo</span><span class="p">,</span> <span class="n">CSi</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lzeromatrix__</span><span class="p">,</span> <span class="n">CSi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_row</span> <span class="o">=</span> <span class="n">Lo_row</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_row</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_col</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">del</span> <span class="n">CSi</span><span class="p">,</span> <span class="n">sLo</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.mca_csd&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_csd</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.mca_csd_row&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.mca_csd_col&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_col</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FLUX_CONSERVATION__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],:],</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd_row</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_csd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_row</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FLUX_CONSERVATION__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],:],</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_cjd_row</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:,:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: this is interesting no dependent flux cc</span><span class="se">\&#39;</span><span class="s1">s only dependent conc cc</span><span class="se">\&#39;</span><span class="s1">s!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:,:],</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_csd</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_csd_row</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: this is interesting no dependent flux/conc coefficients!&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:,:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_row</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_row</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_ci_col</span><span class="p">)</span>

        <span class="c1"># the new way of doing things (test phase) brett - 2007</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span> <span class="o">=</span> <span class="n">BagOfStuff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.cc_flux&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.cc_conc&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.cc_all&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccj_upsymb&quot;</span><span class="p">]:</span>
            <span class="c1">#CJ</span>
            <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">CJoutput</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ccJ&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;uccJ&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccs_upsymb&quot;</span><span class="p">]:</span>
            <span class="c1">#CS</span>
            <span class="n">CSoutput</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">),</span><span class="n">r</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;cc&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;ucc&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CJoutput&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">CJoutput</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CSoutput&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">CSoutput</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showCC"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showCC">[docs]</a>    <span class="k">def</span> <span class="nf">showCC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showCC(File=None)</span>

<span class="sd">        Print all control coefficients as \&#39;LaTex\&#39; formatted strings to the screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_altout&quot;</span><span class="p">]:</span>
            <span class="n">CAltoutput</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="n">CAltoutput</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">`Reaction &#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">CAltoutput</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">Flux control coefficients</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">):</span>
                        <span class="n">CAltoutput</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">Concentration control coefficients</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                    <span class="n">rtemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cc{J&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">ucc{J&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cc{&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">ucc{&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                    <span class="n">CAltoutput</span> <span class="o">+=</span> <span class="n">cc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_fluxout&quot;</span><span class="p">]:</span>
                <span class="c1">#CJ</span>
                <span class="n">CJoutput</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="n">CJoutput</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">`J&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                        <span class="n">rtemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cc{J&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">ucc{J&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="n">CJoutput</span> <span class="o">+=</span> <span class="n">cc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_concout&quot;</span><span class="p">]:</span>
                <span class="c1">#CS</span>
                <span class="n">CSoutput</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">),</span><span class="n">r</span><span class="p">):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                    <span class="n">CSoutput</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">`&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\&#39;\n</span><span class="s1">&#39;</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
                        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
                        <span class="n">rtemp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cc{&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">ucc{&#39;</span> <span class="o">+</span> <span class="n">row</span> <span class="o">+</span> <span class="s1">&#39;}{&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;} = &#39;</span> <span class="o">+</span> <span class="n">rtemp</span>
                        <span class="n">CSoutput</span> <span class="o">+=</span> <span class="n">cc</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#assert type(File) == file, &#39;showCC() needs an open file object&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_altout&quot;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Control coefficients grouped by reaction&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Control coefficients grouped by reaction</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">CAltoutput</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_fluxout&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Flux control coefficients&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Flux control coefficients</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">CJoutput</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_concout&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Concentration control coefficients&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Concentration control coefficients</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">CSoutput</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_altout&quot;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Control coefficients grouped by reaction&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">CAltoutput</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_fluxout&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Flux control coefficients&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">CJoutput</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;mca_ccall_concout&quot;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Concentration control coefficients&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">CSoutput</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.EvalRC"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.EvalRC">[docs]</a>    <span class="k">def</span> <span class="nf">EvalRC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EvalRC()</span>

<span class="sd">        Calculate the MCA response coefficients using the current steady-state solution.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">reordered_cc_all</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_par_row</span><span class="p">)):</span>
            <span class="n">reordered_cc_all</span><span class="p">[:,</span><span class="n">reac</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all</span><span class="p">[:,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_all_col</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_par_row</span><span class="p">[</span><span class="n">reac</span><span class="p">])]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mca_rc_par</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">reordered_cc_all</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_par</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_rc_par_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_all_row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_rc_par_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_par_col</span>
        <span class="k">del</span> <span class="n">reordered_cc_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">MatrixFloatFix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_rc_par</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">=</span> <span class="n">BagOfStuff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_rc_par</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_rc_par_row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_rc_par_col</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.EvalRCT"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.EvalRCT">[docs]</a>    <span class="k">def</span> <span class="nf">EvalRCT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EvalRCT()</span>

<span class="sd">        Calculate the MCA response coefficients using the current steady-state solution.</span>

<span class="sd">        Responses to changes in the sums of moiety conserved cycles are also calculated.</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># We arbitrarily choose the order of reactions as that of elas_var_row</span>
        <span class="c1"># and the order of species as that of elas_var_col. The order of dependent</span>
        <span class="c1"># species (there is one for each moiety conserved cycle) is from the</span>
        <span class="c1"># conservation matrix (mod.Consmatrix.row). The final output is the</span>
        <span class="c1"># (m x (m-r)) R^S_T matrix and the (n x (m-r)) R^J_T matrix.</span>
        <span class="c1">#</span>
        <span class="c1"># See &quot;Metabolic control analysis in a nutshell&quot; by Hofmeyr and also</span>
        <span class="c1"># Kholodenko, Sauro, Westerhoff 1994 for the matrix formulations.</span>
        <span class="c1">#</span>
        <span class="c1"># Danie Palm - 2011-10-26</span>

        <span class="c1"># Reorder reactions in Cs and CJ to match elas_var_row</span>
        <span class="n">reaction_reordered_cc_conc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">)):</span>
            <span class="n">reaction_reordered_cc_conc</span><span class="p">[:,</span><span class="n">reac</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span><span class="p">[:,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_col</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">[</span><span class="n">reac</span><span class="p">])]</span>
        <span class="n">reaction_reordered_cc_flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">)):</span>
            <span class="n">reaction_reordered_cc_flux</span><span class="p">[:,</span><span class="n">reac</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span><span class="p">[:,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_col</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">[</span><span class="n">reac</span><span class="p">])]</span>

        <span class="c1"># Reorder metabolites in Cs to match elas_var_col</span>
        <span class="n">reordered_cc_conc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metab</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span><span class="p">)):</span>
            <span class="n">reordered_cc_conc</span><span class="p">[</span><span class="n">metab</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">reaction_reordered_cc_conc</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_conc_row</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span><span class="p">[</span><span class="n">metab</span><span class="p">]),:]</span>

        <span class="c1"># Reorder fluxes in CJ to match elas_var_row</span>
        <span class="n">reordered_cc_flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">flux</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">)):</span>
            <span class="n">reordered_cc_flux</span><span class="p">[</span><span class="n">flux</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">reaction_reordered_cc_flux</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc_flux_row</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">[</span><span class="n">flux</span><span class="p">]),:]</span>

        <span class="c1"># Some basic dimensions and matrices</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Lmatrix</span><span class="o">.</span><span class="n">col</span><span class="p">)</span>
        <span class="n">Im</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>

        <span class="c1"># Construct the (right) pseudoinverse of the the conservation matrix in the order of elas_var_col</span>
        <span class="n">reordered_zero_I</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">-</span><span class="n">r</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Consmatrix</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Consmatrix</span><span class="o">.</span><span class="n">row</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">species</span><span class="p">)</span>
                <span class="n">reordered_zero_I</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Unlike normal RCs, separate calculations are required for scaled</span>
        <span class="c1"># and unscaled RCT&#39;s. We also need to pick the right elasticity</span>
        <span class="c1"># matrix: elas_var for scaled and elas_var_u for unscaled.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Some scaling matrices</span>
            <span class="n">diag_T</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Species_In_Conc&#39;</span><span class="p">]:</span>
                <span class="n">diag_T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tvec_c__</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">diag_T</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__tvec_a__</span><span class="p">))</span>
            <span class="n">diag_S</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="o">.</span><span class="n">getStateData</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span><span class="p">)))</span>

            <span class="c1"># Calculate concentration responses to changes in T</span>
            <span class="c1"># (Cs*es + Im) * diag_S.I * reordered_zero_I * diag_T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_conc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">reordered_cc_conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var</span><span class="p">)</span> <span class="o">+</span> <span class="n">Im</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">diag_S</span><span class="p">)),</span> <span class="n">reordered_zero_I</span><span class="p">),</span> <span class="n">diag_T</span><span class="p">)</span>

            <span class="c1"># Calculate flux responses to changes in T</span>
            <span class="c1"># CJ*es * diag_S.I * reordered_zero_I * diag_T</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">reordered_cc_flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">diag_S</span><span class="p">)),</span> <span class="n">reordered_zero_I</span><span class="p">),</span> <span class="n">diag_T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate concentration responses to changes in T</span>
            <span class="c1"># (Cs*es + Im) * reordered_zero_I</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_conc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">reordered_cc_conc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_u</span><span class="p">)</span> <span class="o">+</span> <span class="n">Im</span><span class="p">,</span> <span class="n">reordered_zero_I</span><span class="p">)</span>

            <span class="c1"># Calculate flux responses to changes in T</span>
            <span class="c1"># CJ*es * reordered_zero_I</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_flux</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">reordered_cc_flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_u</span><span class="p">),</span> <span class="n">reordered_zero_I</span><span class="p">)</span>

        <span class="c1"># Cleanup</span>
        <span class="k">del</span> <span class="n">reordered_cc_conc</span>
        <span class="k">del</span> <span class="n">reordered_cc_flux</span>

        <span class="c1"># We simply prepend &#39;T_&#39; to the name of the dependent species to prevent</span>
        <span class="c1"># confusion with the real species. This is a parameter, not variable.</span>
        <span class="n">moiety_sum_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;T_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dependent_species</span><span class="p">)</span> <span class="k">for</span> <span class="n">dependent_species</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Consmatrix</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">MatrixFloatFix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_conc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_conc_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_conc_col</span> <span class="o">=</span> <span class="n">moiety_sum_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__structural__</span><span class="o">.</span><span class="n">MatrixFloatFix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_flux</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_flux_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_flux_col</span> <span class="o">=</span> <span class="n">moiety_sum_names</span>

        <span class="c1"># Augment the existing m.rc object (this could be more efficient)</span>

        <span class="c1"># Reordering as a matter of principle: too many burnt fingers</span>
        <span class="n">vstacked_col</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_row</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_col</span><span class="p">)</span>
        <span class="n">vstacked</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_flux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mca_rct_conc</span><span class="p">))</span>
        <span class="n">reordered_vstack</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">vstacked</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">row</span><span class="p">)):</span>
            <span class="n">reordered_vstack</span><span class="p">[</span><span class="n">row_index</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">vstacked</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">vstacked_col</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">row</span><span class="p">[</span><span class="n">row_index</span><span class="p">]),:]</span>
        <span class="n">hstacked</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vstacked</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rc</span> <span class="o">=</span> <span class="n">BagOfStuff</span><span class="p">(</span><span class="n">hstacked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">col</span> <span class="o">+</span> <span class="n">moiety_sum_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_mca_scaled&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.EvalEigen"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.EvalEigen">[docs]</a>    <span class="k">def</span> <span class="nf">EvalEigen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        EvalEigen()</span>

<span class="sd">        Calculate the eigenvalues or vectors of the unscaled Jacobian matrix and thereby</span>
<span class="sd">        analyse the stability of a system</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Nr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">)</span>

        <span class="c1">#sort E to match K and L</span>
        <span class="n">Es</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">elas_var_u</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="c1">#print e2</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">)):</span>
                <span class="n">Es</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elas_var_u</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">jac1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Es</span><span class="p">)</span>
            <span class="n">jacobian</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">jac1</span><span class="p">,</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jacobian</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Nr</span><span class="p">,</span><span class="n">Es</span><span class="p">)</span>
        <span class="n">Si</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)):</span>
            <span class="n">Si</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">jacobian</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">jacobian</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jacobian_row</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Si</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jacobian_col</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">Si</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_eigen_output&#39;</span><span class="p">]:</span>
                <span class="c1">#returns eigenvalues as well as left and right eigenvectors</span>
                <span class="n">eigenval</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecleft</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecright</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">jacobian</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">jacobian</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;d&#39;</span><span class="p">),</span><span class="n">left</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Eigenvalues&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">eigenval</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Left Eigenvector&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecleft</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Right Eigenvector&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecright</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#returns eigenvalues</span>
                <span class="n">eigenval</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">jacobian</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Eigenvalues&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">eigenval</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span> <span class="o">=</span> <span class="n">eigenval</span>
        <span class="c1">#self.eigen_order = tuple(eigenorder)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="p">)):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;lambda&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;display_debug&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Eigenvalues attached as lambda1 ... lambda&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eigenorder</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.showEigen"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showEigen">[docs]</a>    <span class="k">def</span> <span class="nf">showEigen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showEigen(File=None)</span>

<span class="sd">        Print the eigenvalues and stability analysis of a system generated with EvalEigen()</span>
<span class="sd">        to the screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eigenstats</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;Max real part: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;Min real part: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;Max absolute imaginary part: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;Min absolute imaginary part: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="o">.</span><span class="n">imag</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;Stiffness: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="o">.</span><span class="n">real</span><span class="p">))</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="o">.</span><span class="n">real</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">pure_real</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pure_imag</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">negcplx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pure_cplx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pure_zero</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pos_real</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="n">neg_real</span>  <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">imag</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">pure_real</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">imag</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">pure_imag</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">imag</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">pure_zero</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">pos_real</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">neg_real</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">real</span> <span class="o">&lt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">imag</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">negcplx</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Stability&#39;</span>
        <span class="n">eiglen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">neg_real</span> <span class="o">==</span> <span class="n">eiglen</span><span class="p">:</span>
            <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39; --&gt; Stable state&#39;</span>
        <span class="k">elif</span> <span class="n">pure_zero</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39; --&gt; Undetermined&#39;</span>
        <span class="k">elif</span> <span class="n">pos_real</span> <span class="o">==</span> <span class="n">eiglen</span><span class="p">:</span>
            <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39; --&gt; Unstable state&#39;</span>

        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Purely real: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pure_real</span><span class="p">)</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Purely imaginary: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pure_imag</span><span class="p">)</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Zero: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pure_zero</span><span class="p">)</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Positive real part: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pos_real</span><span class="p">)</span>
        <span class="n">eigenstats</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Negative real part: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">neg_real</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#assert type(File) == file, &#39;showEigen() needs an open file object&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Eigen values&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Eigen values</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">File</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="p">,</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">keep_open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Eigen statistics&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Eigen statistics</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">eigenstats</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_eigen_output&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Left eigen vector&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Left eigen vector</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">File</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecleft</span><span class="p">,</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">keep_open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Right eigen vector&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Right eigen vector</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">File</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecright</span><span class="p">,</span><span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">keep_open</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Eigen values&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_values</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Eigen statistics&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">eigenstats</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_eigen_output&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Left eigen vector&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecleft</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Right eigen vector&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eigen_vecright</span><span class="p">)</span></div>

<span class="c1">#Utility functions</span>
<span class="c1">#new generation metafunctions</span>
    <span class="c1">##  def doLoad(self,stoich_load=0):</span>
        <span class="c1">##  &quot;&quot;&quot;</span>
        <span class="c1">##  doLoad(stoich_load=0)</span>

        <span class="c1">##  Load and instantiate a PySCeS model so that it can be used for further analyses.</span>

        <span class="c1">##  Calls model loading subroutines:</span>
        <span class="c1">##  Stoichiometry_Analyse() [override=0,load=stoich_load]</span>
        <span class="c1">##  InitialiseModel()</span>

        <span class="c1">##  Arguments:</span>

        <span class="c1">##  stoich_load [default=0]: try to load a stoichiometry saved with Stoichiometry_Save_Serial()</span>

        <span class="c1">##  &quot;&quot;&quot;</span>
        <span class="c1">##  self.InitialiseInputFile()</span>
        <span class="c1">##  assert self.__parseOK, &#39;\nError in input file, parsing could not complete&#39;</span>
        <span class="c1">##  self.Stoichiometry_Analyse(override=0,load=stoich_load)</span>
        <span class="c1">##  # add new Style functions to model</span>
        <span class="c1">##  self.InitialiseFunctions()</span>
        <span class="c1">##  self.InitialiseCompartments()</span>
        <span class="c1">##  self.InitialiseRules()</span>
        <span class="c1">##  self.InitialiseEvents()</span>
        <span class="c1">##  self.InitialiseOldFunctions() # TODO replace this with initialisation functions</span>
        <span class="c1">##  self.InitialiseModel()</span>
        <span class="c1">##  self.InitialiseRuleChecks()</span>

<div class="viewcode-block" id="PysMod.doSim"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doSim">[docs]</a>    <span class="k">def</span> <span class="nf">doSim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="mi">21</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doSim(end=10.0,points=20.0)</span>

<span class="sd">        Run a time simulation from t=0 to t=sim_end with sim_points.</span>

<span class="sd">        Calls:</span>
<span class="sd">        Simulate()</span>

<span class="sd">        Arguments:</span>

<span class="sd">        end [default=10.0]: simulation end time</span>
<span class="sd">        points [default=20.0]: number of points in the simulation</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span> <span class="o">=</span> <span class="n">points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Simulate</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.doSimPlot"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doSimPlot">[docs]</a>    <span class="k">def</span> <span class="nf">doSimPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">points</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a time simulation from t=0 to t=sim_end with sim_points and plot the results.</span>
<span class="sd">        The required output data and format can be set:</span>

<span class="sd">        - *end* the end time (default=10.0)</span>
<span class="sd">        - *points* the number of points in the simulation (default=20.0)</span>
<span class="sd">        - *plot* (default=&#39;species&#39;) select output data</span>

<span class="sd">         - &#39;species&#39;</span>
<span class="sd">         - &#39;rates&#39;</span>
<span class="sd">         - &#39;all&#39; both species and rates</span>

<span class="sd">        - *fmt* plot format, UPI backend dependent (default=&#39;&#39;) or the *CommonStyle* &#39;lines&#39; or &#39;points&#39;.</span>
<span class="sd">        - *filename* if not None (default) then the plot is exported as *filename*.png</span>

<span class="sd">        Calls:</span>
<span class="sd">        - **Simulate()**</span>
<span class="sd">        - **SimPlot()**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span> <span class="o">=</span> <span class="n">points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Simulate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SimPlot</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.exportSimAsSedML"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.exportSimAsSedML">[docs]</a>    <span class="k">def</span> <span class="nf">exportSimAsSedML</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="n">return_sed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vc_given</span><span class="o">=</span><span class="s1">&#39;PySCeS&#39;</span><span class="p">,</span> <span class="n">vc_family</span><span class="o">=</span><span class="s1">&#39;Software&#39;</span><span class="p">,</span> <span class="n">vc_email</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">vc_org</span><span class="o">=</span><span class="s1">&#39;pysces.sourceforge.net&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exports the current simulation as SED-ML in various ways it creates and stores the SED-ML files in a folder</span>
<span class="sd">        generated from the model name.</span>

<span class="sd">         - *output* [default=&#39;files&#39;] the SED-ML export type can be one or more comma separated e.g. &#39;files,combine&#39;</span>
<span class="sd">         - *files* export the plain SBML and SEDML XML files</span>
<span class="sd">         - *archive* export as a SED-ML archive *&lt;file&gt;.sedx* containing the SBML and SEDML xml files</span>
<span class="sd">         - *combine* export as a COMBINE archive *&lt;file&gt;.omex* containing the SBML, SEDML, manifest (XML) and metadata (RDF)</span>
<span class="sd">           - *vc_given* [default=&#39;PySCeS&#39;]</span>
<span class="sd">           - *vc_family* [default=&#39;Software&#39;]</span>
<span class="sd">           - *vc_email* [default=&#39;bgoli@users.sourceforge.net&#39;]</span>
<span class="sd">           - *vc_org* [default=&#39;&lt;pysces.sourceforge.net&gt;&#39;]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sedname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.psc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">sedout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">OUTPUT_DIR</span><span class="p">,</span> <span class="s1">&#39;sedout&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sedout</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">sedout</span><span class="p">)</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">SED</span><span class="o">.</span><span class="n">SED</span><span class="p">(</span><span class="n">sedname</span><span class="o">+</span><span class="s1">&#39;_sed&#39;</span><span class="p">,</span> <span class="n">sedout</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">addModel</span><span class="p">(</span><span class="n">sedname</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">addSimulation</span><span class="p">(</span><span class="s1">&#39;sim0&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_points</span><span class="p">,</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">__SIMPLOT_OUT__</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;KISAO:0000019&#39;</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">addTask</span><span class="p">(</span><span class="s1">&#39;task0&#39;</span><span class="p">,</span> <span class="s1">&#39;sim0&#39;</span><span class="p">,</span> <span class="n">sedname</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">addTaskDataGenerators</span><span class="p">(</span><span class="s1">&#39;task0&#39;</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">addTaskPlot</span><span class="p">(</span><span class="s1">&#39;task0&#39;</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">s_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">s_</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s_</span> <span class="o">==</span> <span class="s1">&#39;files&#39;</span><span class="p">:</span>
                <span class="n">S</span><span class="o">.</span><span class="n">writeSedScript</span><span class="p">()</span>
                <span class="n">S</span><span class="o">.</span><span class="n">writeSedXML</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">s_</span> <span class="o">==</span> <span class="s1">&#39;archive&#39;</span><span class="p">:</span>
                <span class="n">S</span><span class="o">.</span><span class="n">writeSedXArchive</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">s_</span> <span class="o">==</span> <span class="s1">&#39;combine&#39;</span><span class="p">:</span>
                <span class="n">S</span><span class="o">.</span><span class="n">writeCOMBINEArchive</span><span class="p">(</span><span class="n">vc_given</span><span class="o">=</span><span class="n">vc_given</span><span class="p">,</span> <span class="n">vc_family</span><span class="o">=</span><span class="n">vc_family</span><span class="p">,</span> <span class="n">vc_email</span><span class="o">=</span><span class="n">vc_email</span><span class="p">,</span> <span class="n">vc_org</span><span class="o">=</span><span class="n">vc_org</span><span class="p">)</span>
        <span class="n">S</span><span class="o">.</span><span class="n">_SED_CURRENT_</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">return_sed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">S</span></div>

<div class="viewcode-block" id="PysMod.doSimPerturb"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doSimPerturb">[docs]</a>    <span class="k">def</span> <span class="nf">doSimPerturb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pl</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Deprecated**: use events instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="PysMod.doState"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doState">[docs]</a>    <span class="k">def</span> <span class="nf">doState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doState()</span>

<span class="sd">        Calculate the steady-state solution of the system.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.doStateShow"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doStateShow">[docs]</a>    <span class="k">def</span> <span class="nf">doStateShow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doStateShow()</span>

<span class="sd">        Calculate the steady-state solution of a system and show the results.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>
<span class="sd">        showState()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">INFO: Invalid steady state: run mod.doState() and check for errors&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showState</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.doElas"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doElas">[docs]</a>    <span class="k">def</span> <span class="nf">doElas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doElas()</span>

<span class="sd">        Calculate the model elasticities, this method automatically calculates a steady state.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>
<span class="sd">        EvalEvar()</span>
<span class="sd">        EvalEpar()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">INFO: Invalid steady state: run mod.doState() and check for errors&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEvar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEpar</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.doEigen"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doEigen">[docs]</a>    <span class="k">def</span> <span class="nf">doEigen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doEigen()</span>

<span class="sd">        Calculate the eigenvalues, automatically performs a steady state and elasticity analysis.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>
<span class="sd">        EvalEvar()</span>
<span class="sd">        Evaleigen()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">INFO: Invalid steady state: run mod.doState() and check for errors&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;elas_evar_upsymb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEvar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;elas_evar_upsymb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEigen</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.doEigenShow"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doEigenShow">[docs]</a>    <span class="k">def</span> <span class="nf">doEigenShow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doEigenShow()</span>

<span class="sd">        Calculate the eigenvalues, automatically performs a steady state and elasticity analysis</span>
<span class="sd">        and displays the results.</span>

<span class="sd">        Calls:</span>
<span class="sd">        doEigen()</span>
<span class="sd">        showEigen()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doEigen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showEigen</span><span class="p">()</span></div>


<div class="viewcode-block" id="PysMod.doEigenMca"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doEigenMca">[docs]</a>    <span class="k">def</span> <span class="nf">doEigenMca</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doEigenMca()</span>

<span class="sd">        Calculate a full Control Analysis and eigenvalues, automatically performs a steady state, elasticity, control analysis.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>
<span class="sd">        EvalEvar()</span>
<span class="sd">        EvalCC()</span>
<span class="sd">        Evaleigen()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">INFO: Invalid steady state: run mod.doState() and check for errors&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEvar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalCC</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEigen</span><span class="p">()</span></div>


<div class="viewcode-block" id="PysMod.doMca"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doMca">[docs]</a>    <span class="k">def</span> <span class="nf">doMca</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doMca()</span>

<span class="sd">        Perform a complete Metabolic Control Analysis on the model, automatically calculates a steady state.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>
<span class="sd">        EvalEvar()</span>
<span class="sd">        EvalEpar()</span>
<span class="sd">        EvalCC()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">INFO: Invalid steady state run: mod.doState() and check for errors&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEvar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEpar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalCC</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.doMcaRC"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doMcaRC">[docs]</a>    <span class="k">def</span> <span class="nf">doMcaRC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doMca()</span>

<span class="sd">        Perform a complete Metabolic Control Analysis on the model, automatically calculates a steady state.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>
<span class="sd">        EvalEvar()</span>
<span class="sd">        EvalEpar()</span>
<span class="sd">        EvalCC()</span>
<span class="sd">        EvalRC()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">INFO: Invalid steady state run: mod.doState() and check for errors&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEvar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEpar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalCC</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalRC</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.doMcaRCT"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.doMcaRCT">[docs]</a>    <span class="k">def</span> <span class="nf">doMcaRCT</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        doMcaRCT()</span>

<span class="sd">        Perform a complete Metabolic Control Analysis on the model, automatically calculates a steady state.</span>

<span class="sd">        In additional, response coefficients to the sums of moiety-conserved cycles are calculated.</span>

<span class="sd">        Calls:</span>
<span class="sd">        State()</span>
<span class="sd">        EvalEvar()</span>
<span class="sd">        EvalEpar()</span>
<span class="sd">        EvalCC()</span>
<span class="sd">        EvalRC()</span>
<span class="sd">        EvalRCT()</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">INFO: Invalid steady state run: mod.doState() and check for errors&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEvar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalEpar</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalCC</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EvalRC</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">EvalRCT</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No moiety conservation detected, reverting to simple doMcaRC().&#39;</span><span class="p">)</span></div>

<span class="c1">#show/save function prototypes</span>
<div class="viewcode-block" id="PysMod.showSpecies"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showSpecies">[docs]</a>    <span class="k">def</span> <span class="nf">showSpecies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showSpecies(File=None)</span>

<span class="sd">        Prints the current value of the model&#39;s variable species (mod.X) to screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Species values&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## species values</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1">##  print self.__species__[x] + &#39; = &#39; +  self.__settings__[&#39;mode_number_format&#39;] % eval(&#39;self.&#39; + self.__species__[x])</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">##  out_list.append(self.__species__[x] + &#39; = &#39; +  self.__settings__[&#39;mode_number_format&#39;] % eval(&#39;self.&#39; + self.__species__[x]) + &#39;\n&#39;)</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showSpeciesI"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showSpeciesI">[docs]</a>    <span class="k">def</span> <span class="nf">showSpeciesI</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showSpeciesI(File=None)</span>

<span class="sd">        Prints the current value of the model&#39;s variable species initial values (mod.X_init) to screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Species initial values&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## species initial values</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_init = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_init&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_init&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showSpeciesFixed"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showSpeciesFixed">[docs]</a>    <span class="k">def</span> <span class="nf">showSpeciesFixed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showSpeciesFixed(File=None)</span>

<span class="sd">        Prints the current value of the model&#39;s fixed species values (mod.X) to screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fixed species&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## fixed species</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showPar"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showPar">[docs]</a>    <span class="k">def</span> <span class="nf">showPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showPar(File=None)</span>

<span class="sd">        Prints the current value of the model&#39;s parameter values (mod.P) to screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Parameters&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## parameters</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showModifiers"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showModifiers">[docs]</a>    <span class="k">def</span> <span class="nf">showModifiers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showModifiers(File=None)</span>

<span class="sd">        Prints the current value of the model&#39;s modifiers per reaction to screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">noMod</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Modifiers per reaction:&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## modifiers per reaction</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__modifiers__</span><span class="p">:</span>
            <span class="n">rstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reac</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">reac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39; has modifier:&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">rstr</span> <span class="o">=</span> <span class="n">rstr</span> <span class="o">+</span> <span class="n">reac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39; has modifier: &#39;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reac</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">rstr</span> <span class="o">=</span> <span class="n">rstr</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">rstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">reac</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">reac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39; has modifiers: &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">rstr</span> <span class="o">=</span> <span class="n">rstr</span> <span class="o">+</span> <span class="n">reac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39; has modifiers: &#39;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reac</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">rstr</span> <span class="o">=</span> <span class="n">rstr</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">rstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">noMod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reac</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noMod</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reactions with no modifiers:&#39;</span><span class="p">)</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## reactions with no modifiers</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">rstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noMod</span><span class="p">)):</span>
                <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">cntr</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">rstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                    <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">noMod</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">rstr</span> <span class="o">=</span> <span class="n">rstr</span> <span class="o">+</span> <span class="n">noMod</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">rstr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rstr</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.showState"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showState">[docs]</a>    <span class="k">def</span> <span class="nf">showState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showState(File=None)</span>

<span class="sd">        Prints the result of the last steady-state analyses. Both steady-state flux&#39;s and species concentrations are shown.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Steady-state species concentrations&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Current steady-state species concentrations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_ss = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_ss = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_species</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No valid steady state found&#39;</span><span class="p">)</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No valid steady state found.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Steady-state fluxes&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Steady-state fluxes</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;J_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;J_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_flux</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No valid steady state found&#39;</span><span class="p">)</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No valid steady state found.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showRate"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showRate">[docs]</a>    <span class="k">def</span> <span class="nf">showRate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the current rates of all the reactions using the current parameter values and species concentrations</span>

<span class="sd">        - *File* an open, writable Python file object (default=None)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Vtemp</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">r</span><span class="p">])]</span>
        <span class="n">outrate</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">)):</span>
            <span class="n">outrate</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; = &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="n">Vtemp</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">del</span> <span class="n">s</span><span class="p">,</span><span class="n">Vtemp</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reaction rates&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">##Reaction rates</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outrate</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reaction rates&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">outrate</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.showRateEq"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showRateEq">[docs]</a>    <span class="k">def</span> <span class="nf">showRateEq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showRateEq(File=None)</span>

<span class="sd">        Prints the reaction stoichiometry and rate equations to screen or File.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tnform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%2.5f</span><span class="s1">&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reaction stoichiometry and rate equations&#39;</span><span class="p">)</span>
        <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## Reaction stoichiometry and rate equations</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># writes these out in a better order</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Kmatrix</span><span class="o">.</span><span class="n">row</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">reagL</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">reagR</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">reagent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">][</span><span class="n">reagent</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">][</span><span class="n">reagent</span><span class="p">]</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">reagR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reagent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reagR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">][</span><span class="n">reagent</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">reagent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">][</span><span class="n">reagent</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">][</span><span class="n">reagent</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">reagL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reagent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reagL</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Reagents&#39;</span><span class="p">][</span><span class="n">reagent</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span> <span class="o">+</span> <span class="n">reagent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

            <span class="n">substring</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reagL</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">substring</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
                <span class="n">substring</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">prodstring</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">reagR</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">prodstring</span> <span class="o">+=</span> <span class="s1">&#39; + &#39;</span>
                <span class="n">prodstring</span> <span class="o">+=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Rever&#39;</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39; = &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39; &gt; &#39;</span>
            <span class="k">if</span> <span class="n">File</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">substring</span> <span class="o">+</span> <span class="n">symbol</span> <span class="o">+</span> <span class="n">prodstring</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;RateEq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">substring</span> <span class="o">+</span> <span class="n">symbol</span> <span class="o">+</span> <span class="n">prodstring</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nDict__</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;RateEq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;self.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"># Assignment rules</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">:</span>
                <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;!F </span><span class="si">%s</span><span class="s1"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>\
                                <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">ass</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">]))</span>
            <span class="n">out_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_list</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tnform</span></div>


<div class="viewcode-block" id="PysMod.showODE"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showODE">[docs]</a>    <span class="k">def</span> <span class="nf">showODE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%2.3f</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showODE(File=None,fmt=&#39;%2.3f&#39;)</span>

<span class="sd">        Print a representation of the full set of ODE&#39;s generated by PySCeS to screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        fmt [default=&#39;%2.3f&#39;]: output number format</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maxmetlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxmetlen</span><span class="p">:</span>
                <span class="n">maxmetlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">maxreaclen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxreaclen</span><span class="p">:</span>
                <span class="n">maxreaclen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">odes</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## ODE</span><span class="se">\&#39;</span><span class="s1">s (unreduced)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxmetlen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span>
            <span class="n">beginline</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">beginline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                            <span class="n">beginline</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">beginline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39; -&#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">y</span><span class="p">]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">beginline</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">odes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Rate Rules:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">:</span>
                <span class="n">odes</span> <span class="o">+=</span> <span class="s2">&quot;d</span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">odes</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ODE</span><span class="se">\&#39;</span><span class="s1">s (unreduced)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">odes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">odes</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showODEr"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showODEr">[docs]</a>    <span class="k">def</span> <span class="nf">showODEr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%2.3f</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showODEr(File=None,fmt=&#39;%2.3f&#39;)</span>

<span class="sd">        Print a representation of the reduced set of ODE&#39;s generated by PySCeS to screen or file.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        fmt [default=&#39;%2.3f&#39;]: output number format</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maxmetlen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxmetlen</span><span class="p">:</span>
                <span class="n">maxmetlen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">maxreaclen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxreaclen</span><span class="p">:</span>
                <span class="n">maxreaclen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">odes</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## ODE</span><span class="se">\&#39;</span><span class="s1">s (reduced)</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39;d&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxmetlen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span>
            <span class="n">beginline</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">beginline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                            <span class="n">beginline</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39; + &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">beginline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39; -&#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span>  <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="n">maxreaclen</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">y</span><span class="p">]]))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">beginline</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">odes</span> <span class="o">+=</span>  <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_RATE_RULES__</span><span class="p">:</span>
            <span class="n">odes</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">## Rate Rules:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rate_rules__</span><span class="p">:</span>
                <span class="n">odes</span> <span class="o">+=</span> <span class="s2">&quot;d</span><span class="si">%s</span><span class="s2"> | </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__rules__</span><span class="p">[</span><span class="n">rule</span><span class="p">][</span><span class="s1">&#39;formula&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">odes</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ODE</span><span class="se">\&#39;</span><span class="s1">s (reduced)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">odes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showConserved</span><span class="p">(</span><span class="n">File</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">odes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showConserved</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.showModel"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showModel">[docs]</a>    <span class="k">def</span> <span class="nf">showModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">skipcheck</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showModel(filename=None,filepath=None,skipcheck=0)</span>

<span class="sd">        The PySCeS &#39;save&#39; command, prints the entire model to screen or File in a PSC format.</span>
<span class="sd">        (Currently this only applies to basic model attributes, ! functions are not saved).</span>

<span class="sd">        Arguments:</span>

<span class="sd">        filename [default=None]: the output PSC file</span>
<span class="sd">        filepath [default=None]: the output directory</span>
<span class="sd">        skipcheck [default=0]: skip check to see if the file exists (1) auto-averwrite</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelDir</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fixed species&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&lt;none&gt;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">showRateEq</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showSpeciesI</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">showPar</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#assert type(filename) == str, &#39;showModel() takes a string filename argument&#39;</span>
            <span class="n">FBuf</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
                <span class="c1">#filename = str(filename)</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">chkpsc</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">skipcheck</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">filex</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filex</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">file &quot;&#39;</span> <span class="o">+</span> <span class="n">filex</span> <span class="o">+</span> <span class="s1">&#39;&quot; exists.</span><span class="se">\n</span><span class="s1">Overwrite? ([y]/n) &#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="ow">or</span> <span class="nb">input</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="nb">input</span> <span class="o">==</span> <span class="s1">&#39;n&#39;</span><span class="p">:</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">file &quot;&#39;</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot; exists. Enter a new filename: &#39;</span><span class="p">)</span>
                            <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">filex</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="n">chkpsc</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Invalid input&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">file &quot;&#39;</span> <span class="o">+</span> <span class="n">filex</span> <span class="o">+</span> <span class="s1">&#39;&quot; does not exist, proceeding&#39;</span><span class="p">)</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">I hope we have a filebuffer&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">==</span><span class="n">file</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">==</span><span class="n">io</span><span class="o">.</span><span class="n">OutputType</span><span class="p">:</span> <span class="c1"># --johann 20070615</span>
                    <span class="n">go</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">FBuf</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Seems like it&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">go</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Are you sure you know what ur doing&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">go</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">FBuf</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filex</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.psc&#39;</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Assuming extension is .psc&#39;</span><span class="p">)</span>
                        <span class="n">filex</span> <span class="o">+=</span> <span class="s1">&#39;.psc&#39;</span>
                    <span class="n">outFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filex</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outFile</span> <span class="o">=</span> <span class="n">filename</span>

                <span class="c1">#header =   &#39;# \n&#39;</span>
                <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;# PySCeS (&#39;</span> <span class="o">+</span> <span class="n">__version__</span> <span class="o">+</span> <span class="s1">&#39;) model input file </span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="c1">#header += &#39;# Copyright Brett G. Olivier, 2004 (bgoli at sun dot ac dot za)  \n&#39;</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;# http://pysces.sourceforge.net/ </span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;# </span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;# Original input file: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;# This file generated: &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

                <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;## Fixed species</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#  &lt;none&gt;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;FIX: &#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fixed_species__</span><span class="p">:</span>
                        <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showRateEq</span><span class="p">(</span><span class="n">File</span><span class="o">=</span><span class="n">outFile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showSpeciesI</span><span class="p">(</span><span class="n">File</span><span class="o">=</span><span class="n">outFile</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">showPar</span><span class="p">(</span><span class="n">File</span><span class="o">=</span><span class="n">outFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">==</span><span class="n">file</span><span class="p">:</span>  <span class="c1"># don&#39;t close cStringIO objects -- johann 20070615</span>
                    <span class="n">outFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="PysMod.showN"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showN">[docs]</a>    <span class="k">def</span> <span class="nf">showN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%2.3f</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showN(File=None,fmt=&#39;%2.3f&#39;)</span>

<span class="sd">        Print the stoichiometric matrix (N), including row and column labels to screen or File.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        fmt [default=&#39;%2.3f&#39;]: output number format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">rtr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="mi">9</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]][:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;* &#39;</span>
                <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_row</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">rtr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="c1">#km += &#39;\n&#39; + self.__reactions__[self.nmatrix_row[x]] + 4*&#39; &#39;</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">:</span>
                        <span class="n">km</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">km_trunc</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (col) reaction</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_col</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ctr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">if</span> <span class="n">km_trunc2</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (row) species:</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmatrix_row</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rtr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Stoichiometric matrix (N)&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">## Stoichiometric matrix (N)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Stoichiometric matrix (N)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">km</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showNr"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showNr">[docs]</a>    <span class="k">def</span> <span class="nf">showNr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%2.3f</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showNr(File=None,fmt=&#39;%2.3f&#39;)</span>

<span class="sd">        Print the reduced stoichiometric matrix (Nr), including row and column labels to screen or File.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        fmt [default=&#39;%2.3f&#39;]: output number format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rtr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="mi">9</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]][:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;* &#39;</span>
                <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">a</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]][:</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">rtr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="c1">#km += &#39;\n&#39; + self.__reactions__[self.nrmatrix_row[x]] + 4*&#39; &#39;</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mf">10.0</span><span class="p">:</span>
                        <span class="n">km</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__nrmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">km_trunc</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (col) reaction:</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_col</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ctr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">if</span> <span class="n">km_trunc2</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (row) species:</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rtr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reduced stoichiometric matrix (Nr)&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">## Reduced stoichiometric matrix (Nr)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Reduced stoichiometric matrix (Nr)&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">km</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showK"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showK">[docs]</a>    <span class="k">def</span> <span class="nf">showK</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%2.3f</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showK(File=None,fmt=&#39;%2.3f&#39;)</span>

<span class="sd">        Print the Kernel matrix (K), including row and column labels to screen or File.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        fmt [default=&#39;%2.3f&#39;]: output number format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rtr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]][:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;* &#39;</span>
                <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]][:</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="mi">1</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">rtr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="c1">#km += &#39;\n&#39; + self.__reactions__[self.kmatrix_row[x]] + 4*&#39; &#39;</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">km_trunc</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (col) reaction:</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ctr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">if</span> <span class="n">km_trunc2</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (row) reaction:</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rtr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Kernel matrix (K)&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">## Kernel matrix (K)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FLUX_CONSERVATION__</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No flux conservation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Kernel matrix (K)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_FLUX_CONSERVATION__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No flux conservation&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">km</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.showL"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.showL">[docs]</a>    <span class="k">def</span> <span class="nf">showL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%2.3f</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        showL(File=None,fmt=&#39;%2.3f&#39;)</span>

<span class="sd">        Print the Link matrix (L), including row and column labels to screen or File.</span>

<span class="sd">        Arguments:</span>

<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        fmt [default=&#39;%2.3f&#39;]: output number format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">km</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rtr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="mi">8</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]][:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;* &#39;</span>
                <span class="n">km_trunc</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">a</span><span class="p">]])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]][:</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;* &#39;</span>
                <span class="n">km_trunc2</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">rtr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="mi">4</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lmatrix__</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">km_trunc</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (col) species:</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ctr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_col</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">if</span> <span class="n">km_trunc2</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;* indicates truncated (row) species:</span><span class="se">\n</span><span class="s1">(&#39;</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rtr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">km</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lmatrix_row</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">km</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>


        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Link matrix (L)&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">## Link matrix (L)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;No moiety conservation</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Link matrix (L)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__HAS_MOIETY_CONSERVATION__</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="s1">No moiety conservation</span><span class="se">\&quot;\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">km</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">km</span><span class="p">)</span></div>

<span class="c1">#Internal test functions</span>
<div class="viewcode-block" id="PysMod.TestSimState"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.TestSimState">[docs]</a>    <span class="k">def</span> <span class="nf">TestSimState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">endTime</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span><span class="n">points</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">diff</span><span class="o">=</span><span class="mf">1.0e-5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Deprecated**</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="PysMod.ResetNumberFormat"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.ResetNumberFormat">[docs]</a>    <span class="k">def</span> <span class="nf">ResetNumberFormat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ResetNumberFormat()</span>

<span class="sd">        Reset PySCeS default number format stored as mod.mode_number format to %2.4e</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%2.4e</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="PysMod.Write_array"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Write_array">[docs]</a>    <span class="k">def</span> <span class="nf">Write_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">close_file</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write_array(input,File=None,Row=None,Col=None,close_file=0,separator=&#39;  &#39;)</span>

<span class="sd">        Write an array to File with optional row/col labels. A &#39;,&#39; separator can be specified to create</span>
<span class="sd">        a CSV style file.</span>

<span class="sd">        mod.__settings__[&#39;write_array_header&#39;]: add &lt;filename&gt; as a header line (1 = yes, 0 = no)</span>
<span class="sd">        mod.__settings__[&#39;write_array_spacer&#39;]: add a space after the header line (1 = yes, 0 = no)</span>
<span class="sd">        mod.__settings__[&#39;write_arr_lflush&#39;]: set the flush rate for large file writes</span>

<span class="sd">        Arguments:</span>

<span class="sd">        input: the array to be written</span>
<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        Row [default=None]: a list of row labels</span>
<span class="sd">        Col [default=None]: a list of column labels</span>
<span class="sd">        close_file [default=0]: close the file after write (1) or leave open (0)</span>
<span class="sd">        separator [default=&#39;  &#39;]: the column separator to use</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;Write_array_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.psc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>

        <span class="c1"># seeing as row indexes are now tuples and not arrays - brett 20050713</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Row</span><span class="p">)</span> <span class="o">==</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;len(Row) must be equal to len(input_row)&#39;</span>
        <span class="k">if</span> <span class="n">Col</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Col</span><span class="p">)</span> <span class="o">==</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;len(Col) must be equal to len(input_col)&#39;</span>

        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#assert File != file, &#39;WriteArray(input,File=None,Row=None,Col=None,close_file=0)&#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_header&#39;</span><span class="p">]:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">## &#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_spacer&#39;</span><span class="p">]:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Col</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing column&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">input_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">input_width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Col</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])):</span>
                        <span class="n">spacer</span>  <span class="o">=</span> <span class="p">(</span><span class="n">input_width</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">spacer</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">spacer</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">separator</span><span class="p">)))</span><span class="o">*</span><span class="s1">&#39; &#39;</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">input_width</span><span class="p">])</span> <span class="o">+</span> <span class="n">spacer</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing array (normal) to file&#39;</span><span class="p">)</span>
                <span class="c1">#scipy.io.write_array(File,input,separator=&#39; &#39;,linesep=&#39;\n&#39;,precision=3,keep_open=1)</span>
                <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: LineFlush must be &gt;= 2&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">flush_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">flush_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1">#print &#39;flushing&#39;</span>
                <span class="c1">#File.write(&#39;\n&#39;)</span>
            <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing vector (normal) to file&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)):</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_number_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing row&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# Row: &#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Row</span><span class="p">:</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">separator</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">close_file</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: You need to supply an open writable file as the 2nd argument to this function&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.Write_array_latex"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Write_array_latex">[docs]</a>    <span class="k">def</span> <span class="nf">Write_array_latex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">close_file</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write_array_latex(input,File=None,Row=None,Col=None,close_file=0)</span>

<span class="sd">        Write an array to an open file as a \&#39;LaTeX\&#39; {array}</span>

<span class="sd">        Arguments:</span>

<span class="sd">        input: the array to be written</span>
<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        Row [default=None]: a list of row labels</span>
<span class="sd">        Col [default=None]: a list of column labels</span>
<span class="sd">        close_file [default=0]: close the file after write (1) or leave open (0)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># seeing as row indexes are now tuples and not arrays - brett 20050713</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Row</span><span class="p">)</span> <span class="o">==</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;len(Row) must be equal to len(input_row)&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing row&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Col</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Col</span><span class="p">)</span> <span class="o">==</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;len(Col) must be equal to len(input_col)&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing column&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: LineFlush must be &gt;= 2&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;Write_array_latex_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.psc&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#assert File != file, &#39;WriteArray(input,File=None,Row=None,Col=None,close_file=0)&#39;</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">%%</span><span class="s1"> &#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Writing array (LaTeX) to file&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">[</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin</span><span class="si">{array}</span><span class="s1">{&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;r|&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">)</span>
                <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">Col</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Col</span><span class="p">)):</span>
                            <span class="n">elx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Col</span><span class="p">[</span><span class="n">el</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;\_&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &amp; $</span><span class="se">\\</span><span class="s1">small{&#39;</span> <span class="o">+</span> <span class="n">elx</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">el</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; $</span><span class="se">\\</span><span class="s1">small{&#39;</span> <span class="o">+</span> <span class="n">elx</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &amp; $</span><span class="se">\\</span><span class="s1">small{&#39;</span> <span class="o">+</span> <span class="n">elx</span> <span class="o">+</span> <span class="s1">&#39;}$&#39;</span><span class="p">)</span>

                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\\\\</span><span class="s1"> </span><span class="se">\\</span><span class="s1">hline</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="p">)</span>
                    <span class="n">flush_count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">el2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Row</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">_&#39;</span><span class="p">)</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">small{&#39;</span> <span class="o">+</span> <span class="n">el2</span> <span class="o">+</span> <span class="s1">&#39;}$ &amp;&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%2.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%2.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span>

                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; &amp;&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\\\\\n</span><span class="s1"> &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">flush_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1">#print &#39;flushing&#39;</span>
                <span class="c1">#File.write(&#39;\n&#39;)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end</span><span class="si">{array}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">]</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: Only arrays can currently be processed with this method.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">close_file</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: You need to supply an open writable file as the 2nd argument to this method&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.Write_array_html"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Write_array_html">[docs]</a>    <span class="k">def</span> <span class="nf">Write_array_html</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">input</span><span class="p">,</span><span class="n">File</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">close_file</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write_array_html(input,File=None,Row=None,Col=None,name=None,close_file=0)</span>

<span class="sd">        Write an array as an HTML table (no header/footer) or complete document. Tables</span>
<span class="sd">        are formatted with coloured columns if they exceed a specified size.</span>

<span class="sd">        mod.__settings__[&#39;write_array_html_header&#39;]: write the HTML document header</span>
<span class="sd">        mod.__settings__[&#39;write_array_html_footer&#39;]: write the HTML document footer</span>

<span class="sd">        Arguments:</span>

<span class="sd">        input: the array to be written</span>
<span class="sd">        File [default=None]: an open, writable Python file object</span>
<span class="sd">        Row [default=None]: a list of row labels</span>
<span class="sd">        Col [default=None]: a list of column labels</span>
<span class="sd">        name [default=None]: an HTML table description line</span>
<span class="sd">        close_file [default=0]: close the file after write (1) or leave open (0)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># seeing as row indexes are now tuples and not arrays - brett 20050713</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Row</span><span class="p">)</span> <span class="o">==</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;len(Row) must be equal to len(input_row)&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing row&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Col</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">Col</span><span class="p">)</span> <span class="o">==</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;len(Col) must be equal to len(input_col)&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing column&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: LineFlush must be &gt;= 2&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;PySCeS data &quot;&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;&quot; generated from model file: &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;PySCeS data generated from model file: &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">File</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#assert File != file, &#39;WriteArray(input,File=None,Row=None,Col=None,close_file=0)&#39;</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;html&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;head&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;title&gt;PySCeS data generated from: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S (%Z)&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/title&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=iso-8859-1&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;/head&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;body&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span>
            <span class="n">header</span> <span class="o">+=</span> <span class="s1">&#39;&lt;h4&gt;&lt;a href=&quot;http://pysces.sourceforge.net&quot;&gt;PySCeS&lt;/a&gt; data generated from: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+</span> <span class="s1">&#39;&lt;/h4&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_html_header&#39;</span><span class="p">]:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;!-- &#39;</span> <span class="o">+</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;--&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;p&gt;</span><span class="se">\n</span><span class="s1">&lt;font face=&quot;Arial, Helvetica, sans-serif&quot;&gt;&lt;strong&gt;&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;&lt;/strong&gt;&lt;/font&gt;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;table border=&quot;1&quot; cellpadding=&quot;2&quot; cellspacing=&quot;2&quot; bgcolor=&quot;#FFFFFF&quot;&gt;&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing array (HTML) to file&#39;</span><span class="p">)</span>

                <span class="n">double_index</span> <span class="o">=</span> <span class="mi">15</span>

                <span class="k">if</span> <span class="n">Col</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td&gt;&amp;nbsp;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">Col</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td bgcolor=&quot;#CCCCCC&quot;&gt;&lt;div align=&quot;center&quot;&gt;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&lt;/div&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">double_index</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td&gt;&amp;nbsp;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/tr&gt;&#39;</span><span class="p">)</span>

                <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">colour_count_row</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="n">colour_count_col</span> <span class="o">=</span> <span class="mi">6</span>
                <span class="n">rowcntr</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">html_colour</span> <span class="o">=</span> <span class="s1">&#39;#FFFFCC&#39;</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">rowcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">rowcntr</span> <span class="o">==</span> <span class="n">colour_count_row</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">colour_count_row</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;tr bgcolor=&quot;&#39;</span><span class="o">+</span><span class="n">html_colour</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">rowcntr</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td bgcolor=&quot;#CCCCCC&quot;&gt;&lt;div align=&quot;center&quot;&gt;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">Row</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&lt;/div&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">colcntr</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">colcntr</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">colcntr</span> <span class="o">==</span> <span class="n">colour_count_col</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">*</span><span class="n">colour_count_row</span><span class="p">:</span>
                            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td nowrap bgcolor=&quot;&#39;</span><span class="o">+</span><span class="n">html_colour</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_html_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">colcntr</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td nowrap&gt;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_html_format&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">input</span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1">##                        File.write(&#39;  &lt;td nowrap&gt;&#39; + self.__settings__[&#39;write_array_html_format&#39;] % input[x,y] + &#39;&lt;/td&gt;\n&#39;)</span>
                    <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">double_index</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td bgcolor=&quot;#CCCCCC&quot;&gt;&lt;div align=&quot;center&quot;&gt;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">Row</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&lt;/div&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/tr&gt;&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">flush_count</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_arr_lflush&#39;</span><span class="p">]:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="n">flush_count</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="c1">#print &#39;flushing&#39;</span>
                <span class="k">if</span> <span class="n">Col</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">double_index</span><span class="p">:</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td&gt;&amp;nbsp;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">Col</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td bgcolor=&quot;#CCCCCC&quot;&gt;&lt;div align=&quot;center&quot;&gt;&lt;b&gt;&#39;</span> <span class="o">+</span> <span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;&lt;/b&gt;&lt;/div&gt;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">Row</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">input</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">double_index</span><span class="p">:</span>
                        <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &lt;td&gt;&amp;nbsp;&lt;/td&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/tr&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: Only arrays can currently be processed with this method.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&lt;/table&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/p&gt;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;write_array_html_footer&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;&lt;a href=&quot;http://pysces.sourceforge.net&quot;&gt;&lt;font size=&quot;3&quot;&gt;PySCeS &#39;</span><span class="o">+</span><span class="n">__version__</span><span class="o">+</span>\
                               <span class="s1">&#39;&lt;/font&gt;&lt;/a&gt;&lt;font size=&quot;2&quot;&gt; HTML output (model &lt;i&gt;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">+</span>\
                               <span class="s1">&#39;&lt;/i&gt; analysed at &#39;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; by &lt;i&gt;&#39;</span><span class="o">+</span><span class="n">getuser</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;&lt;/i&gt;)&lt;/font&gt;&lt;/p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;p&gt;&lt;a href=&quot;http://pysces.sourceforge.net&quot;&gt;&lt;font size=&quot;3&quot;&gt;PySCeS &#39;</span><span class="o">+</span><span class="n">__version__</span><span class="o">+</span>\
                               <span class="s1">&#39;&lt;/font&gt;&lt;/a&gt;&lt;font size=&quot;2&quot;&gt; HTML output (model &lt;i&gt;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span><span class="o">+</span>\
                               <span class="s1">&#39;&lt;/i&gt; analysed at &#39;</span><span class="o">+</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S - %Z&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;)&lt;/font&gt;&lt;/p&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/body&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/html&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">close_file</span><span class="p">:</span>
                <span class="n">File</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;INFO: You need to supply an open writable file as the 2nd argument to this method&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PysMod.SimPlot"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.SimPlot">[docs]</a>    <span class="k">def</span> <span class="nf">SimPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the simulation results, uses the new UPI pysces.plt interface:</span>

<span class="sd">        - *plot*: output to plot (default=&#39;species&#39;)</span>

<span class="sd">         - &#39;all&#39; rates and species</span>
<span class="sd">         - &#39;species&#39; species</span>
<span class="sd">         - &#39;rates&#39; reaction rates</span>
<span class="sd">         - `[&#39;S1&#39;, &#39;R1&#39;, ]` a list of model attributes (species, rates)</span>

<span class="sd">        - *filename* if not None file is exported to filename (default=None)</span>
<span class="sd">        - *title* the plot title (default=None)</span>
<span class="sd">        - *log* use log axis for &#39;x&#39;, &#39;y&#39;, &#39;xy&#39; (default=None)</span>
<span class="sd">        - *format* line format, backend dependant (default=&#39;&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">allowedplots</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;species&#39;</span><span class="p">,</span> <span class="s1">&#39;rates&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="n">plot</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowedplots</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Plot must be one of </span><span class="si">%s</span><span class="s1"> not </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">allowedplots</span><span class="p">),</span> <span class="n">plot</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">getAllSimData</span><span class="p">(</span><span class="n">lbls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;species&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">getSpecies</span><span class="p">(</span><span class="n">lbls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;rates&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">getRates</span><span class="p">(</span><span class="n">lbls</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">plot</span> <span class="k">if</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">__reactions__</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">time_label</span><span class="p">]]</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lbls&#39;</span> <span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">getSimData</span><span class="p">(</span><span class="o">*</span><span class="n">plot</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">allowedplots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__SIMPLOT_OUT__</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plotLines</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">titles</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="nb">format</span><span class="p">])</span>
        <span class="c1"># set the x-axis range so that it is original range + 0.2*sim_end</span>
        <span class="c1"># this is a sceintifcally dtermned amount of space that is needed for the title at the</span>
        <span class="c1"># end of the line :-) - brett 20040209</span>
        <span class="n">RngTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_sim</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">RngTime</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">RngTime</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">RngTime</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">RngTime</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__KeyWords__</span><span class="p">[</span><span class="s1">&#39;Output_In_Conc&#39;</span><span class="p">]:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="s1">&#39;Concentration&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="s1">&#39;Amount (</span><span class="si">%(multiplier)s</span><span class="s1"> x </span><span class="si">%(kind)s</span><span class="s1"> x 10**</span><span class="si">%(scale)s</span><span class="s1">)**</span><span class="si">%(exponent)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uDict__</span><span class="p">[</span><span class="s1">&#39;substance&#39;</span><span class="p">]</span>
        <span class="n">xu</span> <span class="o">=</span> <span class="s1">&#39;Time (</span><span class="si">%(multiplier)s</span><span class="s1"> x </span><span class="si">%(kind)s</span><span class="s1"> x 10**</span><span class="si">%(scale)s</span><span class="s1">)**</span><span class="si">%(exponent)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__uDict__</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setAxisLabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">xu</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="s1">&#39;Rates, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">M</span>
        <span class="k">elif</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;rates&#39;</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="s1">&#39;Rate&#39;</span>
        <span class="k">elif</span> <span class="n">plot</span> <span class="o">==</span> <span class="s1">&#39;species&#39;</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">M</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yl</span> <span class="o">=</span> <span class="s1">&#39;Rates, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">M</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setAxisLabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">yl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setLogScale</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setGraphTitle</span><span class="p">(</span><span class="s1">&#39;PySCeS Simulation (&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setGraphTitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">replot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.Scan1"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Scan1">[docs]</a>    <span class="k">def</span> <span class="nf">Scan1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">range1</span><span class="o">=</span><span class="p">[],</span><span class="n">runUF</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan1(range1=[],runUF=0)</span>

<span class="sd">        Perform a single dimension parameter scan using the steady-state solvers. The parameter to be scanned is defined (as a model attribute &quot;P&quot;) in mod.scan_in while the required output is entered into the list mod.scan_out.</span>
<span class="sd">        Results of a parameter scan can be easilly viewed with Scan1Plot().</span>

<span class="sd">        mod.scan_in - a model attribute written as in the input file (eg. P, Vmax1 etc)</span>
<span class="sd">        mod.scan_out -  a list of required output [&#39;A&#39;,&#39;T2&#39;, &#39;ecR1_s1&#39;, &#39;ccJR1_R1&#39;, &#39;rcJR1_s1&#39;, ...]</span>
<span class="sd">        mod.scan_res -  the results of a parameter scan</span>
<span class="sd">        mod.scan - numpy record array with the scan results (scan_in and scan_out), call as mod.scan.Vmax, mod.scan.A_ss, mod.scan.J_R1, etc.</span>
<span class="sd">        mod.__settings__[&quot;scan1_mca_mode&quot;] - force the scan algorithm to evaluate the elasticities (1) and control coefficients (2)</span>
<span class="sd">        (this should also be auto-detected by the Scan1 method).</span>

<span class="sd">        Arguments:</span>

<span class="sd">        range1 [default=[]]: a predefined range over which to scan.</span>
<span class="sd">        runUF [default=0]: run (1) the user defined function mod.User_Function (!U) before evaluating the steady state.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_dropbad&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">****</span><span class="se">\n</span><span class="s1">INFO: Dropping invalid steady states can mask interesting behaviour</span><span class="se">\n</span><span class="s1">****</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">#check the legitimacy of the input and output lists</span>
        <span class="c1">#self.__settings__[&quot;scan1_mca_mode&quot;] = scanMCA</span>
        <span class="n">run</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># we now accept parameters and intial species values as scanable values - brett 20060519</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__parameters__</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="s1">&#39;_init&#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__species__</span><span class="p">]</span>
        <span class="n">scanpar</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">scanIn</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span><span class="p">]</span>


        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scanIn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">scanpar</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39; is not a parameter&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scanpar</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;mod.scan_in should contain something&#39;</span><span class="p">)</span>
            <span class="n">run</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">scanpar</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Only 1D scans possible - first element will be used&#39;</span><span class="p">)</span>
            <span class="n">scanpar</span> <span class="o">=</span> <span class="n">scanpar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;self.scan_in = &#39;</span><span class="p">,</span> <span class="n">scanpar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scanpar</span> <span class="o">=</span> <span class="n">scanpar</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span> <span class="o">=</span> <span class="n">scanpar</span>

        <span class="n">wrong</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ec&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;cc&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rc&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doElas</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doMca</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doMcaRC</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doState</span><span class="p">()</span> <span class="c1"># we are going to run a whole bunch anyway</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecp</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cc&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ccJ&#39;</span><span class="p">):</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rc&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rcJ&#39;</span><span class="p">):</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INFO: using steady-state flux for reaction (</span><span class="si">%s</span><span class="s2"> --&gt; J_</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;J_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;J_&#39;</span><span class="p">):</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INFO: using steady-state concentration for species (</span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">_ss)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_ss&#39;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_ss&#39;</span><span class="p">):</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39; is not a valid attribute&#39;</span><span class="p">)</span>
                <span class="n">wrong</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span><span class="p">:</span>
                <span class="n">wrong</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39; is mod.scan_in &#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wrong</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wrong</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No valid output&#39;</span><span class="p">)</span>
                <span class="n">run</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Output parameter list (mod.scan_out) empty - do the model attributes exist ... see manual for details.&quot;</span>

        <span class="c1">#print run, self.scan_in, self.scan_out</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cntr2</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">cntr3</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># reset scan error controls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scan_errors_par__</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scan_errors_idx__</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;scan1_mesg&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Scanning ...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">run</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">badList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">badList_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;scan1_mesg&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">range1</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">cntr</span><span class="o">*</span><span class="n">cntr2</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">range1</span><span class="p">)):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">range1</span><span class="p">[</span><span class="n">xi</span><span class="p">]</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                <span class="c1">##  exec(&#39;self.&#39; + self.scan_in + &#39; = &#39; + `x`)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">doElas</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">doMca</span><span class="p">()</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_mca_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">doMcaRC</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">State</span><span class="p">()</span>
                <span class="n">rawres</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="c1"># these two lines are going to be terminated - brett</span>
                <span class="c1">#rawres.append(x)</span>
                <span class="c1">#rawres.insert(0,x)</span>
                <span class="k">if</span> <span class="n">runUF</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">User_Function</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ec</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ecp</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                    <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;cc&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ccJ&#39;</span><span class="p">):</span>
                            <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cc</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                    <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rc&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;rcJ&#39;</span><span class="p">):</span>
                            <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">:]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rc</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                    <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                        <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;J_&#39;</span><span class="p">):</span>
                        <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
                    <span class="k">elif</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">:</span>
                        <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">res</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_ss&#39;</span><span class="p">):</span>
                        <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_sstate</span><span class="p">,</span> <span class="n">res</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rawres</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>

                <span class="c1"># The following is for user friendly reporting:</span>
                <span class="c1"># next we check if the state is ok : if bad report it and add it : if good add it</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_dropbad&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__StateOK__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;scan1_nan_on_bad&quot;</span><span class="p">]:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">rawres</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rawres</span><span class="p">)</span>
                    <span class="n">badList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">badList_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rawres</span><span class="p">)</span>
                <span class="n">cntr</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cntr3</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">cntr</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;scan1_mesg&#39;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">range1</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">cntr</span><span class="o">*</span><span class="n">cntr2</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cntr2</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">cntr3</span> <span class="o">==</span> <span class="mi">101</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;scan1_mesg&#39;</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="n">cntr3</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;scan1_mesg&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">done.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">badList</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__scan_errors_par__</span> <span class="o">=</span> <span class="n">badList</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__scan_errors_idx__</span> <span class="o">=</span> <span class="n">badList_idx</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">badList</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; invalid steady states detected at &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span> <span class="o">+</span> <span class="s1">&#39; values:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">badList</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">range1</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rec</span><span class="o">.</span><span class="n">fromrecords</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scan</span>

<div class="viewcode-block" id="PysMod.Scan1Plot"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Scan1Plot">[docs]</a>    <span class="k">def</span> <span class="nf">Scan1Plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="p">[],</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the results of a parameter scan generated with **Scan1()**</span>

<span class="sd">        - *plot* if empty mod.scan_out is used, otherwise any subset of mod.scan_out (default=[])</span>
<span class="sd">        - *filename* the filename of the PNG file (default=None, no export)</span>
<span class="sd">        - *title* the plot title (default=None)</span>
<span class="sd">        - *log* if None a linear axis is assumed otherwise one of [&#39;x&#39;,&#39;xy&#39;,&#39;xyz&#39;] (default=None)</span>
<span class="sd">        - *format* the backend dependent line format (default=&#39;lines&#39;)  or the *CommonStyle* &#39;lines&#39; or &#39;points&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_res</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">plot</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No plottable output specified using self.scan_out&#39;</span><span class="p">)</span>
            <span class="n">plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span>

        <span class="n">plotidx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">plot</span><span class="p">]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_out</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plotLines</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">plotidx</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span class="p">[</span><span class="nb">format</span><span class="p">])</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">end</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setAxisLabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan_in</span><span class="p">)</span>

        <span class="n">yl</span> <span class="o">=</span> <span class="s1">&#39;Steady-state variable&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setAxisLabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">yl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setLogScale</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setGraphTitle</span><span class="p">(</span><span class="s1">&#39;PySCeS Scan1 (&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setGraphTitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">replot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.Scan2D"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Scan2D">[docs]</a>    <span class="k">def</span> <span class="nf">Scan2D</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">output</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a 2 dimensional parameter scan using the steady-state solvers.</span>

<span class="sd">        - *p1* is a list of [parameter1, start, end, points]</span>
<span class="sd">        - *p2* is a list of [parameter2, start, end, points]</span>
<span class="sd">        - *output* steady-state variable/properties e.g. &#39;J_R1&#39;, &#39;A_ss&#39;, &#39;ecR1_s1&#39;</span>
<span class="sd">        - *log* scan using log ranges for both axes</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s1"> is not a valid model attribute&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">log</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">log</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>

        <span class="n">sc1</span> <span class="o">=</span> <span class="n">Scanner</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">sc1</span><span class="o">.</span><span class="n">quietRun</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">sc1</span><span class="o">.</span><span class="n">addScanParameter</span><span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">)</span>
        <span class="n">sc1</span><span class="o">.</span><span class="n">addScanParameter</span><span class="p">(</span><span class="o">*</span><span class="n">p2</span><span class="p">)</span>
        <span class="n">sc1</span><span class="o">.</span><span class="n">addUserOutput</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">sc1</span><span class="o">.</span><span class="n">Run</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_pars__</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">output</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_results__</span> <span class="o">=</span> <span class="n">sc1</span><span class="o">.</span><span class="n">getResultMatrix</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">sc1</span></div>

<div class="viewcode-block" id="PysMod.Scan2DPlot"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.Scan2DPlot">[docs]</a>    <span class="k">def</span> <span class="nf">Scan2DPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the results of a 2D scan generated with Scan2D</span>

<span class="sd">        - *filename* the filename of the PNG file (default=None, no export)</span>
<span class="sd">        - *title* the plot title (default=None)</span>
<span class="sd">        - *log* if None a linear axis is assumed otherwise one of [&#39;x&#39;,&#39;xy&#39;,&#39;xyz&#39;] (default=None)</span>
<span class="sd">        - *format* the backend dependent line format (default=&#39;lines&#39;)  or the *CommonStyle* &#39;lines&#39; or &#39;points&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">splot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_results__</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_pars__</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setRange</span><span class="p">(</span><span class="s1">&#39;xyz&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setAxisLabel</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_pars__</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setAxisLabel</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__scan2d_pars__</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">setAxisLabel</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;Steady-state variable&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setLogScale</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setGraphTitle</span><span class="p">(</span><span class="s1">&#39;PySCeS Scan2D (&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModelFile</span> <span class="o">+</span> <span class="s1">&#39;) &#39;</span> <span class="o">+</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%a, </span><span class="si">%d</span><span class="s2"> %b %Y %H:%M:%S&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setGraphTitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">replot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ModelOutput</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="PysMod.SetQuiet"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.SetQuiet">[docs]</a>    <span class="k">def</span> <span class="nf">SetQuiet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SetQuiet()</span>

<span class="sd">        Turn off as much solver reporting noise as possible:</span>
<span class="sd">        mod.__settings__[&#39;hybrd_mesg&#39;] = 0</span>
<span class="sd">        mod.__settings__[&#39;nleq2_mesg&#39;] = 0</span>
<span class="sd">        mod.__settings__[&quot;lsoda_mesg&quot;] = 0</span>
<span class="sd">        mod.__settings__[&#39;mode_state_mesg&#39;] = 0</span>
<span class="sd">        mod.__settings__[&#39;scan1_mesg&#39;] = 0</span>
<span class="sd">        mod.__settings__[&#39;solver_switch_warning&#39;] = False</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mesg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;scan1_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;solver_switch_warning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="PysMod.SetLoud"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.SetLoud">[docs]</a>    <span class="k">def</span> <span class="nf">SetLoud</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SetLoud()</span>

<span class="sd">        Turn on as much solver reporting noise as possible:</span>
<span class="sd">        mod.__settings__[&#39;hybrd_mesg&#39;] = 1</span>
<span class="sd">        mod.__settings__[&#39;nleq2_mesg&#39;] = 1</span>
<span class="sd">        mod.__settings__[&quot;lsoda_mesg&quot;] = 1</span>
<span class="sd">        mod.__settings__[&#39;mode_state_mesg&#39;] = 1</span>
<span class="sd">        mod.__settings__[&#39;scan1_mesg&#39;] = 1</span>
<span class="sd">        mod.__settings__[&#39;solver_switch_warning&#39;] = True</span>

<span class="sd">        Arguments:</span>
<span class="sd">        None</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;hybrd_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;nleq2_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s2">&quot;lsoda_mesg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;mode_state_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;scan1_mesg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__settings__</span><span class="p">[</span><span class="s1">&#39;solver_switch_warning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="PysMod.clone"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.PysMod.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a deep copy of this model object (experimental!)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">INFO: Cloning function is currently experimental ... use with care.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="WasteManagement"><a class="viewcode-back" href="../../modules_doc.html#pysces.PyscesModel.WasteManagement">[docs]</a><span class="k">class</span> <span class="nc">WasteManagement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">_gc_delay_hack</span> <span class="o">=</span> <span class="n">gplt</span> <span class="c1"># dont f$%^&amp;*)ing even ask ... only 5 hrs to hack this workaround</span></div>
<span class="n">__waste_manager</span> <span class="o">=</span> <span class="n">WasteManagement</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__psyco_active__</span><span class="p">:</span>
    <span class="n">psyco</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">PysMod</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">To use PySCeS import it from a Python Shell: </span><span class="se">\n\t</span><span class="s1">import pysces</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Press &lt;enter&gt; to continue&#39;</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../userguide.html">
              <img class="logo" src="../../_static/pysces_logo_2.gif" alt="Logo"/>
            </a></p><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../userguide.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2004-2019, Brett Oliver, Johann Rohwer, Jannie Hofmeyr.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>